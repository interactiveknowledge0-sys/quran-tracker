<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Quran Tracker</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Amiri:ital,wght@0,400;0,700;1,400&family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     FIREBASE CONFIG ‚Äî REPLACE THESE VALUES
     1. Go to console.firebase.google.com
     2. Create a project ‚Üí Add web app
     3. Copy your config values below
     ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged, sendPasswordResetEmail, GoogleAuthProvider, signInWithPopup }
  from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
import { getFirestore, doc, setDoc, getDoc, updateDoc, collection, getDocs, query, where, addDoc, onSnapshot, serverTimestamp, deleteDoc, orderBy }
  from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// üîß REPLACE WITH YOUR FIREBASE CONFIG
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const firebaseConfig = {
  apiKey: "YOUR_API_KEY",
  authDomain: "YOUR_AUTH_DOMAIN",
  projectId: "YOUR_PROJECT_ID",
  storageBucket: "YOUR_STORAGE_BUCKET",
  messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
  appId: "YOUR_APP_ID"
};
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

try {
  const app  = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db   = getFirestore(app);

  window.__firebaseReady = true;
  window.__auth = auth;
  window.__db   = db;
  window.__firebaseFns = {
    createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut,
    onAuthStateChanged, sendPasswordResetEmail, GoogleAuthProvider, signInWithPopup,
    doc, setDoc, getDoc, updateDoc, collection, getDocs, query, where,
    addDoc, onSnapshot, serverTimestamp, deleteDoc, orderBy
  };
  document.dispatchEvent(new Event('firebaseReady'));
} catch(err) {
  window.__firebaseError = err.message;
  document.dispatchEvent(new Event('firebaseReady'));
}
</script>

<style>
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

:root {
  --bg: #faf8f6;
  --surface: #f4f0ee;
  --card: #ffffff;
  --border: #e8dde4;
  --border2: #d8ccd4;
  --teal: #b8829a;
  --teal2: #a06e84;
  --gold: #c4a0b4;
  --amber: #c8a8b8;
  --blue: #a8a0c8;
  --red: #d07888;
  --green: #88aa88;
  --text: #3a2a34;
  --text2: #7a6070;
  --text3: #a898a4;
  --font: 'Outfit', sans-serif;
  --arabic: 'Amiri', serif;
  --radius: 16px;
}

html { scroll-behavior: smooth; }
body { background: var(--bg); color: var(--text); font-family: var(--font); min-height: 100vh; overflow-x: hidden; }

body::before {
  content: '';
  position: fixed; inset: 0; pointer-events: none; z-index: 0;
  background-image:
    radial-gradient(600px 400px at 20% 10%, rgba(220,190,210,0.18) 0%, transparent 70%),
    radial-gradient(500px 350px at 80% 90%, rgba(200,185,220,0.14) 0%, transparent 70%);
}

/* ‚îÄ‚îÄ SCREENS ‚îÄ‚îÄ */
.screen { display: none !important; position: relative; z-index: 1; }
.screen.active { display: block !important; }

/* Auth screen needs flex for centering */
#authScreen.active { display: flex !important; }

/* ‚îÄ‚îÄ AUTH SCREEN ‚îÄ‚îÄ */
#authScreen {
  min-height: 100vh; display: flex; align-items: center; justify-content: center; padding: 20px;
}
.auth-box {
  background: #fff; border-radius: 24px; padding: 40px; width: 100%; max-width: 460px;
  box-shadow: 0 8px 48px rgba(160,110,145,0.18); animation: fadeUp 0.4s ease both;
}
.auth-logo { text-align: center; margin-bottom: 32px; }
.auth-logo-icon {
  width: 64px; height: 64px; background: linear-gradient(135deg, var(--teal), var(--gold));
  border-radius: 18px; display: flex; align-items: center; justify-content: center;
  font-size: 28px; margin: 0 auto 16px; box-shadow: 0 8px 32px rgba(184,130,154,0.28);
}
.auth-logo h1 {
  font-size: 26px; font-weight: 700;
  background: linear-gradient(135deg, #3a2a34 0%, #b8829a 100%);
  -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;
}
.auth-logo p { font-family: var(--arabic); font-size: 15px; color: var(--text3); margin-top: 4px; }

.auth-tabs { display: flex; background: var(--bg); border-radius: 10px; padding: 4px; margin-bottom: 28px; }
.auth-tab {
  flex: 1; padding: 9px; border: none; background: transparent; border-radius: 8px;
  font-family: var(--font); font-size: 13px; font-weight: 500; color: var(--text3); cursor: pointer; transition: all 0.2s;
}
.auth-tab.active { background: #fff; color: var(--text); font-weight: 600; box-shadow: 0 2px 8px rgba(0,0,0,0.08); }

.auth-form { display: none; }
.auth-form.active { display: block; }

.form-group { margin-bottom: 16px; }
.form-label { font-size: 12px; color: var(--text3); font-weight: 500; display: block; margin-bottom: 6px; text-transform: uppercase; letter-spacing: 0.4px; }
.form-input {
  width: 100%; background: var(--bg); border: 1px solid var(--border); border-radius: 10px;
  padding: 11px 14px; color: var(--text); font-family: var(--font); font-size: 14px; outline: none; transition: border-color 0.2s;
}
.form-input:focus { border-color: #b8829a; }
.form-select {
  width: 100%; background: var(--bg); border: 1px solid var(--border); border-radius: 10px;
  padding: 11px 14px; color: var(--text); font-family: var(--font); font-size: 14px; outline: none;
  cursor: pointer; appearance: none; transition: border-color 0.2s;
}
.form-select:focus { border-color: #b8829a; }

.btn { padding: 12px 24px; border: none; border-radius: 10px; font-family: var(--font); font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.2s; }
.btn-primary { background: #b8829a; color: #fff; width: 100%; margin-top: 8px; }
.btn-primary:hover { background: #a06e84; box-shadow: 0 4px 20px rgba(184,130,154,0.3); transform: translateY(-1px); }
.btn-secondary { background: transparent; border: 1px solid var(--border); color: var(--text2); }
.btn-secondary:hover { border-color: var(--border2); }
.btn-sm { padding: 8px 16px; font-size: 12px; border-radius: 8px; }
.btn-danger { background: rgba(208,120,136,0.1); color: var(--red); border: 1px solid rgba(208,120,136,0.2); }
.btn-danger:hover { background: rgba(208,120,136,0.2); }
.btn-green { background: rgba(136,170,136,0.15); color: #5a8a5a; border: 1px solid rgba(136,170,136,0.3); }
.btn-green:hover { background: rgba(136,170,136,0.25); }

.auth-link { text-align: center; margin-top: 16px; font-size: 13px; color: var(--text3); }
.auth-link a { color: #b8829a; cursor: pointer; text-decoration: underline; }
.auth-error { background: rgba(208,120,136,0.08); border: 1px solid rgba(208,120,136,0.2); color: var(--red); border-radius: 8px; padding: 10px 14px; font-size: 13px; margin-bottom: 14px; display: none; }
.auth-error.visible { display: block; }

.google-btn {
  width: 100%; padding: 11px 16px; border-radius: 10px; margin-top: 10px;
  border: 1px solid var(--border); background: #fff; cursor: pointer;
  font-family: var(--font); font-size: 14px; font-weight: 500; color: var(--text);
  display: flex; align-items: center; justify-content: center; gap: 10px;
  transition: all 0.2s; box-shadow: 0 1px 4px rgba(0,0,0,0.06);
}
.google-btn:hover { border-color: #b8829a; box-shadow: 0 3px 12px rgba(0,0,0,0.1); transform: translateY(-1px); }
.google-btn img { width: 18px; height: 18px; }
.auth-divider { display: flex; align-items: center; gap: 10px; margin: 16px 0; }
.auth-divider::before, .auth-divider::after { content: ''; flex: 1; height: 1px; background: var(--border); }
.auth-divider span { font-size: 12px; color: var(--text3); white-space: nowrap; }

/* Google role picker overlay */
.google-role-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.6); backdrop-filter: blur(6px); z-index: 2000; display: flex; align-items: center; justify-content: center; padding: 20px; }
.google-role-box { background: #fff; border-radius: 20px; padding: 32px; width: 100%; max-width: 440px; box-shadow: 0 24px 64px rgba(0,0,0,0.2); animation: fadeUp 0.3s ease both; }

/* ‚îÄ‚îÄ ROLE SELECT (after signup) ‚îÄ‚îÄ */
.role-cards { display: grid; grid-template-columns: repeat(3,1fr); gap: 12px; margin: 20px 0; }
.role-card {
  border: 2px solid var(--border); border-radius: 14px; padding: 20px 14px; text-align: center;
  cursor: pointer; transition: all 0.2s;
}
.role-card:hover { border-color: rgba(184,130,154,0.5); background: rgba(184,130,154,0.04); transform: translateY(-2px); }
.role-card.selected { border-color: #b8829a; background: rgba(184,130,154,0.08); }
.role-card .role-emoji { font-size: 28px; margin-bottom: 8px; }
.role-card .role-name { font-size: 13px; font-weight: 600; }
.role-card .role-desc { font-size: 11px; color: var(--text3); margin-top: 3px; }

/* ‚îÄ‚îÄ MAIN LAYOUT ‚îÄ‚îÄ */
#appScreen { min-height: 100vh; }

header {
  position: sticky; top: 0; z-index: 100;
  padding: 14px 40px; border-bottom: 1px solid var(--border);
  display: flex; align-items: center; justify-content: space-between;
  background: rgba(250,248,246,0.97); backdrop-filter: blur(12px);
}
.header-left { display: flex; align-items: center; gap: 14px; }
.logo-icon { width: 40px; height: 40px; background: linear-gradient(135deg, var(--teal), var(--gold)); border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 18px; box-shadow: 0 4px 16px rgba(184,130,154,0.2); }
.header-title h1 { font-size: 19px; font-weight: 700; background: linear-gradient(135deg, #3a2a34 0%, #b8829a 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
.header-title p { font-size: 10px; color: var(--text3); font-family: var(--arabic); }

.header-right { display: flex; align-items: center; gap: 10px; }

.role-badge { padding: 5px 12px; border-radius: 20px; font-size: 11px; font-weight: 600; }
.role-badge.teacher { background: rgba(168,160,200,0.15); color: #6860a8; border: 1px solid rgba(168,160,200,0.3); }
.role-badge.parent  { background: rgba(136,170,136,0.15); color: #5a8a5a; border: 1px solid rgba(136,170,136,0.3); }
.role-badge.student { background: rgba(184,130,154,0.12); color: #9a5a72; border: 1px solid rgba(184,130,154,0.3); }

.user-menu-btn { display: flex; align-items: center; gap: 8px; padding: 7px 14px 7px 10px; background: #fff; border: 1px solid rgba(184,130,154,0.2); border-radius: 40px; cursor: pointer; transition: all 0.2s; box-shadow: 0 2px 8px rgba(160,110,145,0.08); }
.user-menu-btn:hover { border-color: rgba(184,130,154,0.4); }
.user-avatar { width: 26px; height: 26px; border-radius: 50%; background: linear-gradient(135deg,var(--teal),var(--gold)); display: flex; align-items: center; justify-content: center; font-size: 12px; color: #fff; font-weight: 700; }
.user-name { font-size: 13px; font-weight: 600; max-width: 100px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }

/* Dropdown */
.header-dropdown-wrap { position: relative; }
.header-dropdown {
  position: absolute; top: calc(100% + 8px); right: 0; background: #fff;
  border: 1px solid var(--border); border-radius: 14px; box-shadow: 0 8px 32px rgba(160,110,145,0.18);
  min-width: 200px; z-index: 200; overflow: hidden; display: none;
}
.header-dropdown.open { display: block; animation: fadeUp 0.2s ease both; }
.hd-item { padding: 11px 16px; font-size: 13px; color: var(--text2); cursor: pointer; transition: background 0.15s; display: flex; align-items: center; gap: 10px; }
.hd-item:hover { background: rgba(184,130,154,0.06); }
.hd-item.danger { color: var(--red); }
.hd-divider { height: 1px; background: var(--border); }

/* Theme toggle */
.theme-toggle { width: 44px; height: 24px; border-radius: 12px; border: none; background: #e0d4dc; cursor: pointer; position: relative; transition: background 0.3s; padding: 3px; display: flex; align-items: center; }
body.dark-mode .theme-toggle { background: #4a2a3c; justify-content: flex-end; }
.tt-knob { width: 18px; height: 18px; border-radius: 50%; background: #fff; display: flex; align-items: center; justify-content: center; font-size: 11px; box-shadow: 0 1px 4px rgba(0,0,0,0.2); transition: all 0.3s; }

/* ‚îÄ‚îÄ NAV ‚îÄ‚îÄ */
nav { display: flex; gap: 4px; padding: 12px 40px; border-bottom: 1px solid var(--border); background: rgba(250,248,246,0.95); backdrop-filter: blur(8px); overflow-x: auto; position: sticky; top: 69px; z-index: 90; }
.tab-btn { padding: 8px 16px; border-radius: 8px; border: 1px solid transparent; background: transparent; color: var(--text3); font-family: var(--font); font-size: 13px; font-weight: 500; cursor: pointer; transition: all 0.2s; white-space: nowrap; display: flex; align-items: center; gap: 6px; }
.tab-btn:hover { color: var(--text); background: rgba(184,130,154,0.06); }
.tab-btn.active { background: #b8829a; border-color: #b8829a; color: #fff; font-weight: 600; }
.tab-btn .badge-count { background: rgba(255,255,255,0.3); border-radius: 10px; padding: 1px 7px; font-size: 11px; }

/* ‚îÄ‚îÄ MAIN ‚îÄ‚îÄ */
main { max-width: 1400px; margin: 0 auto; padding: 32px 40px; position: relative; z-index: 1; }
.tab-section { display: none; }
.tab-section.active { display: block; }

/* ‚îÄ‚îÄ CARDS ‚îÄ‚îÄ */
.card { background: #fff; border-radius: var(--radius); padding: 24px; box-shadow: 0 4px 20px rgba(160,110,145,0.12); }
.card-title { font-size: 13px; font-weight: 600; color: var(--text2); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 18px; display: flex; align-items: center; gap: 8px; }

/* ‚îÄ‚îÄ KPI GRID ‚îÄ‚îÄ */
.kpi-grid { display: grid; grid-template-columns: repeat(auto-fit,minmax(170px,1fr)); gap: 16px; margin-bottom: 24px; }
.kpi-card { background: #fff; border-radius: var(--radius); padding: 20px; position: relative; overflow: hidden; box-shadow: 0 4px 20px rgba(160,110,145,0.12); transition: transform 0.2s; animation: fadeUp 0.4s ease both; }
.kpi-card:hover { transform: translateY(-3px); }
.kpi-card::before { content:''; position:absolute; top:0; left:0; right:0; height:3px; }
.kpi-card.c1::before { background: linear-gradient(90deg,var(--teal),var(--gold)); }
.kpi-card.c2::before { background: var(--green); }
.kpi-card.c3::before { background: var(--blue); }
.kpi-card.c4::before { background: var(--amber); }
.kpi-card.c5::before { background: linear-gradient(90deg,#e8a4b8,#d08898); }
.kpi-icon { width: 32px; height: 32px; border-radius: 9px; display: flex; align-items: center; justify-content: center; font-size: 14px; margin-bottom: 10px; background: rgba(184,130,154,0.1); }
.kpi-value { font-size: 32px; font-weight: 700; letter-spacing: -1px; color: var(--teal); }
.kpi-label { font-size: 11px; color: var(--text3); font-weight: 500; text-transform: uppercase; letter-spacing: 0.4px; margin-top: 4px; }
.kpi-bar { margin-top: 10px; height: 3px; background: var(--border); border-radius: 2px; overflow: hidden; }
.kpi-bar-fill { height: 100%; background: linear-gradient(90deg,var(--teal),var(--blue)); border-radius: 2px; transition: width 0.8s ease; }

/* ‚îÄ‚îÄ TABLE ‚îÄ‚îÄ */
.table-controls { display: flex; gap: 10px; margin-bottom: 16px; flex-wrap: wrap; align-items: center; }
.search-box { flex: 1; min-width: 180px; background: #fff; border: 1px solid rgba(180,130,154,0.2); border-radius: 10px; box-shadow: 0 1px 6px rgba(160,110,145,0.08); padding: 9px 14px; color: var(--text); font-family: var(--font); font-size: 14px; outline: none; transition: border-color 0.2s; }
.search-box:focus { border-color: #b8829a; }
.filter-btn { padding: 9px 14px; border-radius: 9px; border: 1px solid rgba(180,130,154,0.2); background: #fff; box-shadow: 0 1px 6px rgba(160,110,145,0.08); color: var(--text3); font-family: var(--font); font-size: 12px; font-weight: 500; cursor: pointer; transition: all 0.2s; white-space: nowrap; }
.filter-btn.active-filter { background: #b8829a; border-color: #b8829a; color: #fff; }
.table-wrap { background: #fff; border-radius: var(--radius); overflow: hidden; box-shadow: 0 4px 24px rgba(160,110,145,0.12); }
table { width: 100%; border-collapse: collapse; }
thead { background: #fdf6f9; border-bottom: 1px solid rgba(180,130,154,0.12); }
th { padding: 12px 14px; text-align: left; font-size: 11px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; color: var(--text3); }
tbody tr { border-bottom: 1px solid rgba(180,130,154,0.07); transition: background 0.15s; }
tbody tr:last-child { border-bottom: none; }
tbody tr:hover { background: rgba(184,130,154,0.04); }
td { padding: 12px 14px; font-size: 13px; color: var(--text); vertical-align: middle; }
.surah-num { width: 30px; height: 30px; background: var(--border); border-radius: 7px; display: flex; align-items: center; justify-content: center; font-size: 11px; font-weight: 600; color: var(--text3); }
.arabic-col { font-family: var(--arabic); font-size: 17px; color: #b8829a; }
.status-badge { display: inline-flex; align-items: center; gap: 5px; padding: 5px 11px; border-radius: 20px; font-size: 11px; font-weight: 600; cursor: pointer; border: none; font-family: var(--font); transition: all 0.15s; }
.status-badge:hover { filter: brightness(1.1); transform: scale(1.03); }
.status-badge.memorised  { background: rgba(136,170,136,0.12); color: #5a8a5a; border: 1px solid rgba(136,170,136,0.3); }
.status-badge.memorising { background: rgba(184,130,154,0.1); color: #9a5a72; border: 1px solid rgba(184,130,154,0.3); }
.status-badge.revision   { background: rgba(196,160,180,0.12); color: #906070; border: 1px solid rgba(196,160,180,0.3); }
.status-badge.not-started{ background: rgba(232,221,228,0.6); color: var(--text3); border: 1px solid var(--border); }
.star-rating { display: flex; gap: 2px; }
.star { font-size: 14px; cursor: pointer; color: #e0d4d8; transition: color 0.1s; }
.star.filled { color: #b8829a; }
.notes-input { background: transparent; border: none; color: var(--text2); font-family: var(--font); font-size: 12px; outline: none; width: 100%; padding: 3px 6px; border-radius: 5px; transition: background 0.15s; }
.notes-input:focus { background: var(--border); }
.date-input { background: transparent; border: 1px solid transparent; color: var(--text2); font-family: var(--font); font-size: 12px; padding: 3px 6px; border-radius: 6px; outline: none; transition: all 0.15s; }
.date-input:hover,.date-input:focus { border-color: var(--border2); background: var(--border); }
.surah-name-btn { background: transparent; border: none; color: var(--text); font-family: var(--font); font-size: 13px; font-weight: 600; cursor: pointer; text-decoration: underline; text-decoration-color: rgba(184,130,154,0.25); text-underline-offset: 3px; transition: color 0.15s; }
.surah-name-btn:hover { color: #b8829a; }

/* ‚îÄ‚îÄ CHARTS ‚îÄ‚îÄ */
.charts-grid { display: grid; grid-template-columns: 340px 1fr; gap: 20px; margin-bottom: 24px; }
.chart-wrap { position: relative; height: 240px; display: flex; align-items: center; justify-content: center; }
.donut-center { position: absolute; text-align: center; pointer-events: none; }
.donut-center .big { font-size: 30px; font-weight: 700; color: var(--teal); }
.donut-center .small { font-size: 10px; color: var(--text3); text-transform: uppercase; }
.donut-legend { margin-top: 16px; display: flex; flex-direction: column; gap: 8px; }
.legend-item { display: flex; align-items: center; gap: 8px; font-size: 12px; color: var(--text2); }
.legend-dot { width: 9px; height: 9px; border-radius: 50%; flex-shrink: 0; }

/* ‚îÄ‚îÄ HEATMAP ‚îÄ‚îÄ */
.heatmap-wrap { background: #fff; border-radius: var(--radius); padding: 24px; overflow-x: auto; box-shadow: 0 4px 20px rgba(160,110,145,0.12); margin-bottom: 20px; }
.heatmap-months { display: flex; margin-bottom: 6px; padding-left: 28px; }
.month-label { font-size: 10px; color: var(--text3); text-transform: uppercase; }
.heatmap-body { display: flex; }
.day-labels { display: flex; flex-direction: column; gap: 3px; margin-right: 5px; padding-top: 2px; }
.day-label { height: 13px; font-size: 9px; color: var(--text3); line-height: 13px; }
.heatmap-cols { display: flex; gap: 3px; }
.heatmap-col { display: flex; flex-direction: column; gap: 3px; }
.heatmap-cell { width: 13px; height: 13px; border-radius: 2px; background: #ede4ea; cursor: pointer; transition: transform 0.1s; }
.heatmap-cell:hover { transform: scale(1.3); }
.heatmap-cell.l1 { background: rgba(184,130,154,0.2); }
.heatmap-cell.l2 { background: rgba(184,130,154,0.45); }
.heatmap-cell.l3 { background: rgba(184,130,154,0.72); }
.heatmap-cell.l4 { background: rgba(184,130,154,1); }
.heatmap-cell.today { outline: 2px solid var(--gold); outline-offset: 1px; }

/* ‚îÄ‚îÄ GOALS ‚îÄ‚îÄ */
.goals-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
.goal-card { background: #fff; border-radius: var(--radius); padding: 22px; box-shadow: 0 4px 20px rgba(160,110,145,0.12); }
.goal-nums { display: flex; align-items: baseline; gap: 6px; margin: 12px 0 6px; }
.goal-current { font-size: 38px; font-weight: 700; color: var(--teal); letter-spacing: -1px; }
.goal-sep { font-size: 20px; color: var(--text3); }
.goal-target { font-size: 20px; font-weight: 600; color: var(--text2); }
.goal-bar { height: 7px; background: var(--border); border-radius: 4px; overflow: hidden; margin: 10px 0 8px; }
.goal-bar-fill { height: 100%; background: linear-gradient(90deg,var(--teal),var(--blue)); border-radius: 4px; transition: width 0.8s; }

/* ‚îÄ‚îÄ BADGES ‚îÄ‚îÄ */
.badges-grid { display: grid; grid-template-columns: repeat(auto-fill,minmax(160px,1fr)); gap: 12px; }
.badge-card { background: #fff; border-radius: 14px; padding: 16px; text-align: center; box-shadow: 0 3px 14px rgba(160,110,145,0.1); transition: transform 0.2s; position: relative; }
.badge-card.earned { background: linear-gradient(135deg,rgba(184,130,154,0.05),#fff); box-shadow: 0 4px 20px rgba(184,130,154,0.18); }
.badge-card.earned:hover { transform: translateY(-3px); }
.badge-card.locked { opacity: 0.4; filter: grayscale(0.8); }
.badge-emoji { font-size: 28px; display: block; margin-bottom: 8px; }
.badge-name { font-size: 12px; font-weight: 600; margin-bottom: 3px; }
.badge-desc { font-size: 10px; color: var(--text3); line-height: 1.4; }
.badge-earned-tag { position: absolute; top: 8px; right: 8px; font-size: 9px; color: #e8a4b8; font-weight: 700; }

/* ‚îÄ‚îÄ TEACHER DASHBOARD ‚îÄ‚îÄ */
.class-overview-grid { display: grid; grid-template-columns: repeat(auto-fill,minmax(240px,1fr)); gap: 14px; margin-bottom: 24px; }
.student-card { background: #fff; border-radius: var(--radius); padding: 18px; box-shadow: 0 3px 16px rgba(160,110,145,0.1); cursor: pointer; transition: all 0.2s; border: 2px solid transparent; }
.student-card:hover { transform: translateY(-2px); border-color: rgba(184,130,154,0.3); box-shadow: 0 8px 28px rgba(160,110,145,0.18); }
.student-card-header { display: flex; align-items: center; gap: 12px; margin-bottom: 12px; }
.student-avatar { width: 40px; height: 40px; border-radius: 50%; background: linear-gradient(135deg,var(--teal),var(--gold)); display: flex; align-items: center; justify-content: center; font-size: 16px; color: #fff; font-weight: 700; flex-shrink: 0; }
.student-name { font-size: 14px; font-weight: 600; }
.student-email { font-size: 11px; color: var(--text3); }
.student-mini-stats { display: flex; gap: 8px; margin-bottom: 10px; flex-wrap: wrap; }
.mini-stat { font-size: 11px; padding: 3px 9px; border-radius: 10px; font-weight: 500; }
.mini-stat.m { background: rgba(136,170,136,0.12); color: #5a8a5a; }
.mini-stat.mg { background: rgba(184,130,154,0.1); color: #9a5a72; }
.mini-stat.r { background: rgba(196,160,180,0.12); color: #906070; }
.student-progress-bar { height: 5px; background: var(--border); border-radius: 3px; overflow: hidden; }
.student-progress-fill { height: 100%; background: linear-gradient(90deg,var(--green),var(--teal)); border-radius: 3px; transition: width 0.6s; }
.revised-today-dot { width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0; }
.revised-today-dot.yes { background: var(--green); }
.revised-today-dot.no  { background: var(--red); }

/* Alerts */
.alert-card { background: rgba(208,120,136,0.06); border: 1px solid rgba(208,120,136,0.2); border-radius: 12px; padding: 14px 16px; display: flex; align-items: center; justify-content: space-between; }
.alert-info { display: flex; flex-direction: column; gap: 3px; }
.alert-name { font-size: 13px; font-weight: 600; }
.alert-detail { font-size: 12px; color: var(--text3); }
.alert-days { font-size: 12px; color: var(--red); font-weight: 600; }

/* Messages */
.message-thread { display: flex; flex-direction: column; gap: 12px; max-height: 400px; overflow-y: auto; padding-right: 4px; }
.message-bubble { max-width: 75%; padding: 12px 16px; border-radius: 14px; font-size: 13px; line-height: 1.5; }
.message-bubble.sent { align-self: flex-end; background: #b8829a; color: #fff; border-bottom-right-radius: 4px; }
.message-bubble.received { align-self: flex-start; background: #fff; border: 1px solid var(--border); border-bottom-left-radius: 4px; }
.message-meta { font-size: 10px; opacity: 0.6; margin-top: 4px; }
.message-compose { display: flex; gap: 10px; margin-top: 16px; }
.message-compose input { flex: 1; background: var(--bg); border: 1px solid var(--border); border-radius: 10px; padding: 10px 14px; font-family: var(--font); font-size: 13px; outline: none; color: var(--text); transition: border-color 0.2s; }
.message-compose input:focus { border-color: #b8829a; }

/* Parent dashboard */
.children-grid { display: grid; grid-template-columns: repeat(auto-fill,minmax(300px,1fr)); gap: 16px; }
.child-card { background: #fff; border-radius: var(--radius); padding: 22px; box-shadow: 0 4px 20px rgba(160,110,145,0.12); }
.child-header { display: flex; align-items: center; gap: 14px; margin-bottom: 16px; }
.child-avatar { width: 48px; height: 48px; border-radius: 50%; background: linear-gradient(135deg,var(--teal),var(--gold)); display: flex; align-items: center; justify-content: center; font-size: 20px; color: #fff; font-weight: 700; }

/* Invite system */
.invite-box { background: rgba(184,130,154,0.06); border: 1px solid rgba(184,130,154,0.2); border-radius: 12px; padding: 16px; margin-top: 16px; }
.invite-link { font-family: monospace; font-size: 12px; color: var(--text2); background: #fff; border: 1px solid var(--border); border-radius: 8px; padding: 9px 12px; word-break: break-all; margin: 8px 0; display: block; }
.invite-actions { display: flex; gap: 8px; flex-wrap: wrap; }

/* Surah modal */
.modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.75); backdrop-filter: blur(8px); z-index: 500; display: flex; align-items: center; justify-content: center; opacity: 0; pointer-events: none; transition: opacity 0.2s; padding: 20px; }
.modal-overlay.open { opacity: 1; pointer-events: all; }
.modal { background: #fff; border-radius: 20px; padding: 30px; width: 440px; max-width: 96vw; transform: translateY(16px); transition: transform 0.2s; box-shadow: 0 24px 64px rgba(0,0,0,0.2); }
.modal-overlay.open .modal { transform: translateY(0); }
.modal-title { font-size: 17px; font-weight: 700; margin-bottom: 20px; }
.modal-label { font-size: 11px; color: var(--text3); text-transform: uppercase; letter-spacing: 0.4px; display: block; margin-bottom: 6px; }
.modal-input { width: 100%; background: var(--bg); border: 1px solid var(--border); border-radius: 9px; padding: 10px 13px; font-family: var(--font); font-size: 14px; color: var(--text); outline: none; margin-bottom: 14px; transition: border-color 0.2s; }
.modal-input:focus { border-color: #b8829a; }
.modal-actions { display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px; }

/* Surah viewer modal */
.sv-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.88); backdrop-filter: blur(12px); z-index: 600; display: flex; align-items: center; justify-content: center; opacity: 0; pointer-events: none; transition: opacity 0.25s; padding: 20px; }
.sv-overlay.open { opacity: 1; pointer-events: all; }
.sv-modal { background: #fff; border-radius: 20px; width: 700px; max-width: 96vw; max-height: 86vh; display: flex; flex-direction: column; transform: translateY(20px) scale(0.97); transition: transform 0.28s cubic-bezier(0.34,1.56,0.64,1); overflow: hidden; box-shadow: 0 40px 120px rgba(0,0,0,0.4); }
.sv-overlay.open .sv-modal { transform: translateY(0) scale(1); }
.sv-banner { background: linear-gradient(160deg,#f4eef2,#efe8f0,#f8f4f6); border-bottom: 1px solid #e8dde4; padding: 28px 28px 22px; text-align: center; position: relative; flex-shrink: 0; }
.sv-close { position: absolute; top: 14px; right: 14px; width: 30px; height: 30px; border-radius: 50%; border: 1px solid rgba(184,130,154,0.2); background: rgba(184,130,154,0.06); color: rgba(58,42,52,0.4); font-size: 12px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.15s; }
.sv-close:hover { background: rgba(184,130,154,0.12); }
.sv-arabic { font-family: var(--arabic); font-size: 46px; color: #3a2a34; line-height: 1.3; margin-bottom: 6px; }
.sv-translit { font-size: 17px; font-weight: 600; color: #7a4a5e; margin-bottom: 3px; }
.sv-meaning { font-size: 12px; color: rgba(58,42,52,0.45); margin-bottom: 16px; }
.sv-chips { display: flex; gap: 6px; flex-wrap: wrap; justify-content: center; }
.sv-chip { padding: 4px 12px; border-radius: 20px; background: rgba(184,130,154,0.08); border: 1px solid rgba(184,130,154,0.2); font-size: 10px; color: rgba(58,42,52,0.55); font-weight: 500; }
.sv-controls { display: flex; align-items: center; justify-content: space-between; padding: 12px 24px; border-bottom: 1px solid #e8dde4; background: #fdf8fa; flex-shrink: 0; }
.sv-ctrl-title { font-size: 11px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; color: rgba(58,42,52,0.35); }
.sv-ctrl-btns { display: flex; gap: 5px; }
.sv-ctrl-btn { padding: 5px 14px; border-radius: 7px; border: 1px solid rgba(184,130,154,0.2); background: transparent; color: rgba(58,42,52,0.4); font-family: var(--font); font-size: 11px; cursor: pointer; transition: all 0.15s; }
.sv-ctrl-btn:hover { border-color: rgba(184,130,154,0.4); }
.sv-ctrl-btn.active { background: #b8829a; border-color: #b8829a; color: #fff; font-weight: 600; }
.sv-body { overflow-y: auto; flex: 1; background: #faf8f9; }
.sv-bismillah { font-family: var(--arabic); font-size: 28px; text-align: center; color: #3a2a34; padding: 28px; border-bottom: 1px solid #f0e8ec; background: #fff8fb; line-height: 1.9; }
.sv-verse { display: flex; flex-direction: column; padding: 18px 28px; border-bottom: 1px solid #f0e8ec; transition: background 0.15s; }
.sv-verse:hover { background: rgba(184,130,154,0.03); }
.sv-verse-top { display: flex; gap: 14px; align-items: flex-start; }
.sv-vnum { width: 28px; height: 28px; border-radius: 50%; border: 1px solid rgba(184,130,154,0.2); display: flex; align-items: center; justify-content: center; font-size: 9px; font-weight: 600; color: rgba(58,42,52,0.35); flex-shrink: 0; margin-top: 10px; }
.sv-varabic { font-family: var(--arabic); font-size: 24px; line-height: 2.1; direction: rtl; text-align: right; color: #2a1a24; flex: 1; }
.sv-vtranslation { font-size: 13px; line-height: 1.7; color: rgba(58,42,52,0.5); padding: 10px 0 4px 42px; font-style: italic; display: none; }
.sv-vtranslation.show { display: block; }
.sv-loading { text-align: center; padding: 48px; color: rgba(58,42,52,0.4); font-size: 13px; }
.sv-spinner { width: 28px; height: 28px; border: 2px solid rgba(184,130,154,0.15); border-top-color: rgba(184,130,154,0.6); border-radius: 50%; animation: spin 0.8s linear infinite; margin: 0 auto 14px; }

/* History */
.history-list { display: flex; flex-direction: column; gap: 9px; }
.history-item { display: flex; align-items: flex-start; gap: 12px; padding: 14px 18px; background: #fff; border-radius: 14px; box-shadow: 0 2px 10px rgba(160,110,145,0.09); animation: fadeUp 0.3s ease both; }
.history-icon { width: 34px; height: 34px; border-radius: 9px; background: rgba(184,130,154,0.08); display: flex; align-items: center; justify-content: center; font-size: 15px; flex-shrink: 0; }
.history-content { flex: 1; }
.history-action { font-size: 13px; font-weight: 500; }
.history-detail { font-size: 11px; color: var(--text3); margin-top: 2px; }
.history-time { font-size: 10px; color: var(--text3); white-space: nowrap; }

/* Due list */
.due-item { display: flex; align-items: center; justify-content: space-between; padding: 12px 16px; background: rgba(208,120,136,0.06); border: 1px solid rgba(208,120,136,0.18); border-radius: 10px; }
.due-item + .due-item { margin-top: 8px; }

/* Juz bars */
.juz-bar { background: #fff; border-radius: 14px; padding: 14px 18px; box-shadow: 0 3px 14px rgba(160,110,145,0.09); margin-bottom: 12px; }

/* Comparison chart */
.compare-wrap { background: #fff; border-radius: var(--radius); padding: 24px; box-shadow: 0 4px 20px rgba(160,110,145,0.12); margin-bottom: 24px; }

/* Notification badge */
.notif-badge { display: inline-block; background: var(--red); color: #fff; border-radius: 10px; font-size: 10px; font-weight: 700; padding: 1px 6px; min-width: 18px; text-align: center; margin-left: 4px; }

/* Loading overlay */
#loadingOverlay { position: fixed; inset: 0; background: var(--bg); z-index: 9999; display: flex; align-items: center; justify-content: center; flex-direction: column; gap: 16px; transition: opacity 0.4s; }
#loadingOverlay.hide { opacity: 0; pointer-events: none; }
.loading-spinner { width: 40px; height: 40px; border: 3px solid rgba(184,130,154,0.15); border-top-color: #b8829a; border-radius: 50%; animation: spin 0.8s linear infinite; }

/* Empty states */
.empty-state { text-align: center; padding: 48px 20px; color: var(--text3); }
.empty-state .empty-icon { font-size: 40px; margin-bottom: 12px; }
.empty-state p { font-size: 14px; }

/* Pill tabs for sub-sections */
.pill-tabs { display: flex; gap: 6px; margin-bottom: 20px; flex-wrap: wrap; }
.pill-tab { padding: 7px 16px; border-radius: 20px; border: 1px solid var(--border); background: transparent; color: var(--text3); font-family: var(--font); font-size: 12px; font-weight: 500; cursor: pointer; transition: all 0.2s; }
.pill-tab.active { background: #b8829a; border-color: #b8829a; color: #fff; font-weight: 600; }

/* Toast */
.toast { position: fixed; bottom: 24px; left: 50%; transform: translateX(-50%) translateY(80px); background: #fff; border: 1px solid rgba(184,130,154,0.3); border-radius: 14px; padding: 14px 22px; display: flex; align-items: center; gap: 12px; box-shadow: 0 8px 40px rgba(0,0,0,0.2); z-index: 9000; transition: transform 0.4s cubic-bezier(0.34,1.56,0.64,1), opacity 0.4s; opacity: 0; min-width: 260px; }
.toast.show { transform: translateX(-50%) translateY(0); opacity: 1; }

/* Responsive */
@media (max-width: 900px) {
  header, nav, main { padding-left: 16px; padding-right: 16px; }
  .charts-grid { grid-template-columns: 1fr; }
  .goals-grid { grid-template-columns: 1fr; }
  .role-cards { grid-template-columns: 1fr 1fr; }
}
@media (max-width: 600px) {
  .role-cards { grid-template-columns: 1fr; }
  nav { top: 61px; }
}

/* Animations */
@keyframes fadeUp { from { opacity:0; transform:translateY(14px); } to { opacity:1; transform:translateY(0); } }
@keyframes spin { to { transform:rotate(360deg); } }

/* Scrollbar */
::-webkit-scrollbar { width: 5px; height: 5px; }
::-webkit-scrollbar-track { background: var(--bg); }
::-webkit-scrollbar-thumb { background: var(--border2); border-radius: 3px; }

/* ‚îÄ‚îÄ DARK MODE ‚îÄ‚îÄ */
body.dark-mode {
  --bg: #0e080c; --card: #1f1319; --border: #3a2030; --border2: #4a2a3c;
  --teal: #e8a4b8; --gold: #f0c8d8; --amber: #e8b4c4; --blue: #c8a8d4;
  --red: #e07888; --green: #c8a8b8; --text: #fdf0f4; --text2: #c49cac; --text3: #7a5868;
}
body.dark-mode header, body.dark-mode nav { background: rgba(14,8,12,0.97) !important; border-bottom-color: var(--border) !important; }
body.dark-mode .card, body.dark-mode .kpi-card, body.dark-mode .chart-card,
body.dark-mode .table-wrap, body.dark-mode .heatmap-wrap, body.dark-mode .goal-card,
body.dark-mode .badge-card, body.dark-mode .juz-bar, body.dark-mode .student-card,
body.dark-mode .child-card, body.dark-mode .history-item, body.dark-mode .compare-wrap { background: var(--card) !important; border: 1px solid var(--border) !important; box-shadow: none !important; }
body.dark-mode thead { background: #261820 !important; }
body.dark-mode .auth-box, body.dark-mode .modal { background: var(--card) !important; }
body.dark-mode .form-input, body.dark-mode .form-select, body.dark-mode .modal-input,
body.dark-mode .search-box { background: var(--bg) !important; border-color: var(--border) !important; color: var(--text) !important; }
body.dark-mode .auth-tabs { background: var(--bg) !important; }
body.dark-mode .auth-tab.active { background: var(--card) !important; color: var(--text) !important; }
body.dark-mode .tab-btn.active { background: #f0c8d8 !important; border-color: #f0c8d8 !important; color: #1f1319 !important; }
body.dark-mode .star { color: #3a2030 !important; }
body.dark-mode .star.filled { color: #e8a4b8 !important; }
body.dark-mode .filter-btn { background: transparent !important; border-color: var(--border) !important; box-shadow: none !important; }
body.dark-mode .filter-btn.active-filter { background: #f0c8d8 !important; border-color: #f0c8d8 !important; color: #1f1319 !important; }
body.dark-mode .btn-primary { background: #f0c8d8 !important; color: #1f1319 !important; }
body.dark-mode .message-bubble.received { background: var(--card) !important; }
body.dark-mode .heatmap-cell { background: var(--border) !important; }
body.dark-mode .heatmap-cell.l1 { background: rgba(232,164,184,0.22) !important; }
body.dark-mode .heatmap-cell.l2 { background: rgba(232,164,184,0.48) !important; }
body.dark-mode .heatmap-cell.l3 { background: rgba(232,164,184,0.72) !important; }
body.dark-mode .heatmap-cell.l4 { background: rgba(232,164,184,1) !important; }
body.dark-mode .sv-banner { background: linear-gradient(160deg,#1a1014,#16080e,#1c1018) !important; }
body.dark-mode .sv-modal, body.dark-mode .sv-body { background: #120a0e !important; }
body.dark-mode .sv-arabic, body.dark-mode .sv-bismillah { color: #fdf0f4 !important; }
body.dark-mode #loadingOverlay { background: var(--bg) !important; }
body.dark-mode .user-menu-btn { background: var(--card) !important; border-color: var(--border) !important; }
body.dark-mode .header-dropdown { background: var(--card) !important; border-color: var(--border) !important; }
body.dark-mode .message-compose input { background: var(--bg) !important; border-color: var(--border) !important; color: var(--text) !important; }
body.dark-mode .invite-box { background: rgba(240,200,216,0.05) !important; border-color: rgba(240,200,216,0.15) !important; }
body.dark-mode .invite-link { background: var(--bg) !important; border-color: var(--border) !important; color: var(--text2) !important; }
body.dark-mode .pill-tab { border-color: var(--border) !important; }
body.dark-mode .pill-tab.active { background: #f0c8d8 !important; border-color: #f0c8d8 !important; color: #1f1319 !important; }
body.dark-mode .role-card { border-color: var(--border) !important; }
body.dark-mode .role-card.selected { border-color: #f0c8d8 !important; background: rgba(240,200,216,0.08) !important; }
body.dark-mode .google-btn { background: var(--card) !important; border-color: var(--border) !important; color: var(--text) !important; }
body.dark-mode .google-role-box { background: var(--card) !important; }
body.dark-mode .arabic-col { color: #f0c8d8 !important; }
body.dark-mode .date-input { color-scheme: dark; }
body.dark-mode .notes-input:focus { background: var(--border) !important; }
</style>
</head>
<body>

<!-- Loading -->
<div id="loadingOverlay">
  <div style="text-align:center">
    <div style="font-size:36px;margin-bottom:14px">‚ò™Ô∏è</div>
    <div class="loading-spinner"></div>
    <div style="font-size:13px;color:var(--text3);margin-top:14px">Loading Quran Tracker‚Ä¶</div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     AUTH SCREEN
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="authScreen" class="screen">
  <div class="auth-box">
    <div class="auth-logo">
      <div class="auth-logo-icon">‚ò™Ô∏è</div>
      <h1>Quran Tracker</h1>
      <p>ÿ®Ÿêÿ≥ŸíŸÖŸê ÿßŸÑŸÑŸéŸëŸáŸê ÿßŸÑÿ±ŸéŸëÿ≠ŸíŸÖŸéŸÜŸê ÿßŸÑÿ±ŸéŸëÿ≠ŸêŸäŸÖŸê</p>
    </div>

    <div id="authError" class="auth-error"></div>

    <!-- Tabs -->
    <div class="auth-tabs">
      <button class="auth-tab active" onclick="switchAuthTab('login')">Sign In</button>
      <button class="auth-tab" onclick="switchAuthTab('signup')">Create Account</button>
    </div>

    <!-- Login -->
    <div id="loginForm" class="auth-form active">
      <div class="form-group">
        <label class="form-label">Email</label>
        <input type="email" class="form-input" id="loginEmail" placeholder="your@email.com" autocomplete="email">
      </div>
      <div class="form-group">
        <label class="form-label">Password</label>
        <input type="password" class="form-input" id="loginPassword" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="current-password">
      </div>
      <button class="btn btn-primary" onclick="handleLogin()">Sign In</button>
      <div class="auth-divider"><span>or</span></div>
      <button class="google-btn" onclick="handleGoogleSignIn()">
        <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" alt="Google">
        Continue with Google
      </button>
      <div class="auth-link"><a onclick="handleForgotPassword()">Forgot password?</a></div>
    </div>

    <!-- Signup -->
    <div id="signupForm" class="auth-form">
      <div class="form-group">
        <label class="form-label">Full Name</label>
        <input type="text" class="form-input" id="signupName" placeholder="Your name">
      </div>
      <div class="form-group">
        <label class="form-label">Email</label>
        <input type="email" class="form-input" id="signupEmail" placeholder="your@email.com" autocomplete="email">
      </div>
      <div class="form-group">
        <label class="form-label">Password</label>
        <input type="password" class="form-input" id="signupPassword" placeholder="Min. 6 characters" autocomplete="new-password">
      </div>
      <div class="form-group">
        <label class="form-label">I am a‚Ä¶</label>
        <div class="role-cards" id="roleCards">
          <div class="role-card selected" data-role="student" onclick="selectRole('student',this)">
            <div class="role-emoji">üßë‚Äçüéì</div>
            <div class="role-name">Student</div>
            <div class="role-desc">Track my own memorisation</div>
          </div>
          <div class="role-card" data-role="parent" onclick="selectRole('parent',this)">
            <div class="role-emoji">üë®‚Äçüë©‚Äçüëß</div>
            <div class="role-name">Parent</div>
            <div class="role-desc">Monitor my child's progress</div>
          </div>
          <div class="role-card" data-role="teacher" onclick="selectRole('teacher',this)">
            <div class="role-emoji">üë©‚Äçüè´</div>
            <div class="role-name">Teacher</div>
            <div class="role-desc">Manage the whole class</div>
          </div>
        </div>
      </div>
      <div class="form-group" id="classCodeGroup">
        <label class="form-label">Class Code (optional ‚Äî join teacher's class)</label>
        <input type="text" class="form-input" id="classCode" placeholder="e.g. ABC123">
      </div>
      <button class="btn btn-primary" onclick="handleSignup()">Create Account</button>
      <div class="auth-divider"><span>or</span></div>
      <button class="google-btn" onclick="handleGoogleSignIn()">
        <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" alt="Google">
        Continue with Google
      </button>
    </div>
  </div>
</div>

<!-- Google Role Picker ‚Äî shown when new Google user hasn't picked a role yet -->
<div id="googleRoleOverlay" style="display:none" class="google-role-overlay">
  <div class="google-role-box">
    <div style="text-align:center;margin-bottom:24px">
      <div style="font-size:28px;margin-bottom:8px">üëã</div>
      <div style="font-size:18px;font-weight:700;margin-bottom:4px">Welcome!</div>
      <div style="font-size:13px;color:var(--text3)">One last step ‚Äî what is your role?</div>
    </div>
    <div id="authError2" class="auth-error"></div>
    <div class="role-cards" id="googleRoleCards">
      <div class="role-card selected" data-role="student" onclick="selectGoogleRole('student',this)">
        <div class="role-emoji">üßë‚Äçüéì</div>
        <div class="role-name">Student</div>
        <div class="role-desc">Track my memorisation</div>
      </div>
      <div class="role-card" data-role="parent" onclick="selectGoogleRole('parent',this)">
        <div class="role-emoji">üë®‚Äçüë©‚Äçüëß</div>
        <div class="role-name">Parent</div>
        <div class="role-desc">Monitor my child</div>
      </div>
      <div class="role-card" data-role="teacher" onclick="selectGoogleRole('teacher',this)">
        <div class="role-emoji">üë©‚Äçüè´</div>
        <div class="role-name">Teacher</div>
        <div class="role-desc">Manage the class</div>
      </div>
    </div>
    <div id="googleClassCodeGroup" style="margin-top:14px">
      <label class="form-label">Class Code (optional)</label>
      <input type="text" class="form-input" id="googleClassCode" placeholder="Enter teacher's class code‚Ä¶">
    </div>
    <button class="btn btn-primary" style="margin-top:16px" onclick="confirmGoogleRole()">Continue ‚Üí</button>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     MAIN APP SCREEN
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="appScreen" class="screen">

  <header>
    <div class="header-left">
      <div class="logo-icon">‚ò™Ô∏è</div>
      <div class="header-title">
        <h1>Quran Tracker</h1>
        <p>ÿ®Ÿêÿ≥ŸíŸÖŸê ÿßŸÑŸÑŸéŸëŸáŸê ÿßŸÑÿ±ŸéŸëÿ≠ŸíŸÖŸéŸÜŸê ÿßŸÑÿ±ŸéŸëÿ≠ŸêŸäŸÖŸê</p>
      </div>
    </div>
    <div class="header-right">
      <div id="roleBadge" class="role-badge"></div>
      <div class="header-dropdown-wrap">
        <div class="user-menu-btn" onclick="toggleHeaderDropdown()">
          <div class="user-avatar" id="headerAvatar"></div>
          <div class="user-name" id="headerName"></div>
          <span style="font-size:10px;color:var(--text3)">‚ñæ</span>
        </div>
        <div class="header-dropdown" id="headerDropdown">
          <div class="hd-item" onclick="copyInviteLink()">üîó Copy My Invite Link</div>
          <div class="hd-divider"></div>
          <div class="hd-item" onclick="handleForgotPassword()">üîë Reset Password</div>
          <div class="hd-divider"></div>
          <div class="hd-item danger" onclick="handleSignOut()">üö™ Sign Out</div>
        </div>
      </div>
      <button class="theme-toggle" onclick="toggleTheme()">
        <span class="tt-knob" id="themeKnob">üåô</span>
      </button>
    </div>
  </header>

  <nav id="mainNav"></nav>

  <main>
    <!-- ‚îÄ‚îÄ STUDENT TABS ‚îÄ‚îÄ -->
    <div id="tab-overview" class="tab-section">
      <div class="kpi-grid" id="kpiGrid"></div>
      <div id="badgesSectionOverview" class="badges-grid" style="margin-bottom:24px"></div>
      <div class="charts-grid">
        <div class="card">
          <div class="card-title">üç© Status Breakdown</div>
          <div class="chart-wrap"><canvas id="donutChart"></canvas><div class="donut-center"><div class="big" id="donutNum">0</div><div class="small">of 114</div></div></div>
          <div class="donut-legend">
            <div class="legend-item"><div class="legend-dot" style="background:var(--green)"></div>Memorised</div>
            <div class="legend-item"><div class="legend-dot" style="background:var(--blue)"></div>Memorising</div>
            <div class="legend-item"><div class="legend-dot" style="background:var(--amber)"></div>Revision</div>
            <div class="legend-item"><div class="legend-dot" style="background:var(--border2)"></div>Not Started</div>
          </div>
        </div>
        <div class="card">
          <div class="card-title">üìä Progress by Juz</div>
          <div class="chart-wrap" style="height:280px"><canvas id="juzChart"></canvas></div>
        </div>
      </div>
    </div>

    <div id="tab-surahs" class="tab-section">
      <div class="table-controls">
        <input type="text" class="search-box" id="searchInput" placeholder="üîç  Search surah‚Ä¶" oninput="filterTable()">
        <button class="filter-btn active-filter" onclick="setFilter('all',this)">All</button>
        <button class="filter-btn" onclick="setFilter('memorised',this)">‚úÖ Memorised</button>
        <button class="filter-btn" onclick="setFilter('memorising',this)">üìù Memorising</button>
        <button class="filter-btn" onclick="setFilter('revision',this)">üîÑ Revision</button>
        <button class="filter-btn" onclick="setFilter('not-started',this)">‚¨ú Not Started</button>
      </div>
      <div class="table-wrap">
        <table>
          <thead><tr>
            <th>#</th><th>Surah</th><th>Arabic</th><th>Juz</th><th>Verses</th>
            <th>Status</th><th>Last Revised</th><th>Confidence</th><th>Notes</th>
          </tr></thead>
          <tbody id="surahTableBody"></tbody>
        </table>
      </div>
    </div>

    <div id="tab-juz" class="tab-section">
      <div style="margin-bottom:18px"><h2 style="font-size:19px;font-weight:600;margin-bottom:4px">Progress by Juz</h2><p style="color:var(--text3);font-size:13px">30 sections of the Quran</p></div>
      <div id="juzBarsContainer"></div>
    </div>

    <div id="tab-heatmap" class="tab-section">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:20px;flex-wrap:wrap;gap:10px">
        <h2 style="font-size:19px;font-weight:600">Revision Calendar</h2>
        <button class="btn btn-primary" style="width:auto;margin:0" onclick="logTodayRevision()">‚úÖ Log Today's Revision</button>
      </div>
      <div class="heatmap-wrap">
        <div class="heatmap-months" id="heatmapMonths"></div>
        <div class="heatmap-body">
          <div class="day-labels">
            <div class="day-label"></div><div class="day-label">Mon</div><div class="day-label"></div>
            <div class="day-label">Wed</div><div class="day-label"></div><div class="day-label">Fri</div><div class="day-label"></div>
          </div>
          <div class="heatmap-cols" id="heatmapCols"></div>
        </div>
        <div style="display:flex;align-items:center;gap:5px;font-size:10px;color:var(--text3);margin-top:12px">
          Less
          <div style="width:12px;height:12px;border-radius:2px;background:var(--border)"></div>
          <div style="width:12px;height:12px;border-radius:2px;background:rgba(184,130,154,0.2)"></div>
          <div style="width:12px;height:12px;border-radius:2px;background:rgba(184,130,154,0.45)"></div>
          <div style="width:12px;height:12px;border-radius:2px;background:rgba(184,130,154,0.72)"></div>
          <div style="width:12px;height:12px;border-radius:2px;background:rgba(184,130,154,1)"></div>
          More
        </div>
      </div>
      <div class="card">
        <div class="card-title">‚ö†Ô∏è Due for Revision (7+ days)</div>
        <div id="dueList"></div>
      </div>
    </div>

    <div id="tab-goals" class="tab-section">
      <div style="margin-bottom:20px"><h2 style="font-size:19px;font-weight:600;margin-bottom:4px">Your Goals</h2><p style="color:var(--text3);font-size:13px">Set targets and track your journey</p></div>
      <div class="goals-grid" id="goalsGrid"></div>
    </div>

    <div id="tab-history" class="tab-section">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:20px;flex-wrap:wrap;gap:10px">
        <div><h2 style="font-size:19px;font-weight:600;margin-bottom:3px">Activity History</h2><p style="color:var(--text3);font-size:13px">Every change you've made</p></div>
        <button class="btn btn-sm btn-danger" onclick="clearHistory()">üóë Clear History</button>
      </div>
      <div id="historyList" class="history-list"></div>
    </div>

    <div id="tab-connect" class="tab-section">
      <div style="margin-bottom:20px"><h2 style="font-size:19px;font-weight:600;margin-bottom:4px">Connect with Family</h2><p style="color:var(--text3);font-size:13px">Share your progress with parents or link a child's account</p></div>
      <div id="connectContent"></div>
    </div>

    <!-- ‚îÄ‚îÄ TEACHER TABS ‚îÄ‚îÄ -->
    <div id="tab-teacher-overview" class="tab-section">
      <div style="margin-bottom:20px"><h2 style="font-size:19px;font-weight:600;margin-bottom:4px">Class Overview</h2><p style="color:var(--text3);font-size:13px">All students at a glance</p></div>
      <div class="pill-tabs">
        <button class="pill-tab active" onclick="setTeacherSubTab('students',this)">üë• Students</button>
        <button class="pill-tab" onclick="setTeacherSubTab('alerts',this)">‚ö†Ô∏è Alerts</button>
        <button class="pill-tab" onclick="setTeacherSubTab('compare',this)">üìä Compare</button>
      </div>
      <div id="teacherStudentsPane">
        <div id="revisedTodayBar" style="margin-bottom:16px;padding:12px 16px;background:#fff;border-radius:12px;box-shadow:0 2px 10px rgba(160,110,145,0.1);display:flex;align-items:center;gap:16px;flex-wrap:wrap"></div>
        <div class="class-overview-grid" id="classOverviewGrid"></div>
      </div>
      <div id="teacherAlertsPane" style="display:none">
        <div id="alertsList"></div>
      </div>
      <div id="teacherComparePane" style="display:none">
        <div class="compare-wrap"><div class="card-title">üìä Memorisation Comparison</div><div style="height:320px"><canvas id="compareChart"></canvas></div></div>
      </div>
    </div>

    <div id="tab-teacher-messages" class="tab-section">
      <div style="margin-bottom:20px"><h2 style="font-size:19px;font-weight:600;margin-bottom:4px">Messages from Parents</h2><p style="color:var(--text3);font-size:13px">Direct communication with families</p></div>
      <div id="teacherMessagesContent"></div>
    </div>

    <div id="tab-teacher-invite" class="tab-section">
      <div style="margin-bottom:20px"><h2 style="font-size:19px;font-weight:600;margin-bottom:4px">Invite & Manage</h2><p style="color:var(--text3);font-size:13px">Invite students and manage the class</p></div>
      <div id="teacherInviteContent"></div>
    </div>

    <!-- ‚îÄ‚îÄ PARENT TABS ‚îÄ‚îÄ -->
    <div id="tab-parent-children" class="tab-section">
      <div style="margin-bottom:20px"><h2 style="font-size:19px;font-weight:600;margin-bottom:4px">My Children</h2><p style="color:var(--text3);font-size:13px">Monitor your children's Quran progress</p></div>
      <div id="parentChildrenContent"></div>
    </div>

    <div id="tab-parent-messages" class="tab-section">
      <div style="margin-bottom:20px"><h2 style="font-size:19px;font-weight:600;margin-bottom:4px">Message Teacher</h2><p style="color:var(--text3);font-size:13px">Send notes or questions to the class teacher</p></div>
      <div id="parentMessagesContent"></div>
    </div>

    <div id="tab-parent-connect" class="tab-section">
      <div style="margin-bottom:20px"><h2 style="font-size:19px;font-weight:600;margin-bottom:4px">Link a Child</h2><p style="color:var(--text3);font-size:13px">Connect to your child's account</p></div>
      <div id="parentConnectContent"></div>
    </div>
  </main>
</div>

<!-- Surah Viewer Modal -->
<div class="sv-overlay" id="svOverlay">
  <div class="sv-modal">
    <div class="sv-banner">
      <button class="sv-close" onclick="closeSurahViewer()">‚úï</button>
      <div class="sv-arabic" id="svArabic"></div>
      <div class="sv-translit" id="svTranslit"></div>
      <div class="sv-meaning" id="svMeaning"></div>
      <div class="sv-chips" id="svChips"></div>
    </div>
    <div class="sv-controls">
      <div class="sv-ctrl-title">Verses</div>
      <div class="sv-ctrl-btns">
        <button class="sv-ctrl-btn active" id="btnArabicOnly" onclick="setVerseMode('arabic')">Arabic</button>
        <button class="sv-ctrl-btn" id="btnWithTrans" onclick="setVerseMode('translation')">+ Translation</button>
      </div>
    </div>
    <div class="sv-body">
      <div class="sv-bismillah" id="svBismillah">ÿ®Ÿêÿ≥ŸíŸÖŸê ÿßŸÑŸÑŸéŸëŸáŸê ÿßŸÑÿ±ŸéŸëÿ≠ŸíŸÖŸéŸÜŸê ÿßŸÑÿ±ŸéŸëÿ≠ŸêŸäŸÖŸê</div>
      <div id="svVerses"></div>
    </div>
  </div>
</div>

<!-- Goal Edit Modal -->
<div class="modal-overlay" id="goalModal">
  <div class="modal">
    <div class="modal-title">Edit Goal</div>
    <label class="modal-label">Title</label>
    <input type="text" class="modal-input" id="goalTitle">
    <label class="modal-label">Target (surahs)</label>
    <input type="number" class="modal-input" id="goalTarget" min="1" max="114">
    <label class="modal-label">Deadline</label>
    <input type="date" class="modal-input" id="goalDeadline">
    <div class="modal-actions">
      <button class="btn btn-secondary" onclick="closeGoalModal()">Cancel</button>
      <button class="btn btn-primary" style="width:auto;margin:0" onclick="saveGoal()">Save</button>
    </div>
  </div>
</div>

<!-- Student Detail Modal (Teacher view) -->
<div class="modal-overlay" id="studentDetailModal">
  <div class="modal" style="width:560px">
    <div class="modal-title" id="sdmTitle">Student Progress</div>
    <div id="sdmContent"></div>
    <div class="modal-actions">
      <button class="btn btn-secondary" onclick="closeStudentModal()">Close</button>
    </div>
  </div>
</div>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// DATA CONSTANTS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const SURAHS=[
  {n:114,en:"An-Nas",ar:"ÿßŸÑŸÜÿßÿ≥",juz:30,v:6},{n:113,en:"Al-Falaq",ar:"ÿßŸÑŸÅŸÑŸÇ",juz:30,v:5},
  {n:112,en:"Al-Ikhlas",ar:"ÿßŸÑÿ•ÿÆŸÑÿßÿµ",juz:30,v:4},{n:111,en:"Al-Masad",ar:"ÿßŸÑŸÖÿ≥ÿØ",juz:30,v:5},
  {n:110,en:"An-Nasr",ar:"ÿßŸÑŸÜÿµÿ±",juz:30,v:3},{n:109,en:"Al-Kafirun",ar:"ÿßŸÑŸÉÿßŸÅÿ±ŸàŸÜ",juz:30,v:6},
  {n:108,en:"Al-Kawthar",ar:"ÿßŸÑŸÉŸàÿ´ÿ±",juz:30,v:3},{n:107,en:"Al-Ma'un",ar:"ÿßŸÑŸÖÿßÿπŸàŸÜ",juz:30,v:7},
  {n:106,en:"Quraysh",ar:"ŸÇÿ±Ÿäÿ¥",juz:30,v:4},{n:105,en:"Al-Fil",ar:"ÿßŸÑŸÅŸäŸÑ",juz:30,v:5},
  {n:104,en:"Al-Humazah",ar:"ÿßŸÑŸáŸÖÿ≤ÿ©",juz:30,v:9},{n:103,en:"Al-Asr",ar:"ÿßŸÑÿπÿµÿ±",juz:30,v:3},
  {n:102,en:"At-Takathur",ar:"ÿßŸÑÿ™ŸÉÿßÿ´ÿ±",juz:30,v:8},{n:101,en:"Al-Qari'ah",ar:"ÿßŸÑŸÇÿßÿ±ÿπÿ©",juz:30,v:11},
  {n:100,en:"Al-Adiyat",ar:"ÿßŸÑÿπÿßÿØŸäÿßÿ™",juz:30,v:11},{n:99,en:"Az-Zalzalah",ar:"ÿßŸÑÿ≤ŸÑÿ≤ŸÑÿ©",juz:30,v:8},
  {n:98,en:"Al-Bayyinah",ar:"ÿßŸÑÿ®ŸäŸÜÿ©",juz:30,v:8},{n:97,en:"Al-Qadr",ar:"ÿßŸÑŸÇÿØÿ±",juz:30,v:5},
  {n:96,en:"Al-Alaq",ar:"ÿßŸÑÿπŸÑŸÇ",juz:30,v:19},{n:95,en:"At-Tin",ar:"ÿßŸÑÿ™ŸäŸÜ",juz:30,v:8},
  {n:94,en:"Ash-Sharh",ar:"ÿßŸÑÿ¥ÿ±ÿ≠",juz:30,v:8},{n:93,en:"Ad-Duhaa",ar:"ÿßŸÑÿ∂ÿ≠Ÿâ",juz:30,v:11},
  {n:92,en:"Al-Layl",ar:"ÿßŸÑŸÑŸäŸÑ",juz:30,v:21},{n:91,en:"Ash-Shams",ar:"ÿßŸÑÿ¥ŸÖÿ≥",juz:30,v:15},
  {n:90,en:"Al-Balad",ar:"ÿßŸÑÿ®ŸÑÿØ",juz:30,v:20},{n:89,en:"Al-Fajr",ar:"ÿßŸÑŸÅÿ¨ÿ±",juz:30,v:30},
  {n:88,en:"Al-Ghashiyah",ar:"ÿßŸÑÿ∫ÿßÿ¥Ÿäÿ©",juz:30,v:26},{n:87,en:"Al-A'la",ar:"ÿßŸÑÿ£ÿπŸÑŸâ",juz:30,v:19},
  {n:86,en:"At-Tariq",ar:"ÿßŸÑÿ∑ÿßÿ±ŸÇ",juz:30,v:17},{n:85,en:"Al-Buruj",ar:"ÿßŸÑÿ®ÿ±Ÿàÿ¨",juz:30,v:22},
  {n:84,en:"Al-Inshiqaq",ar:"ÿßŸÑÿßŸÜÿ¥ŸÇÿßŸÇ",juz:30,v:25},{n:83,en:"Al-Mutaffifin",ar:"ÿßŸÑŸÖÿ∑ŸÅŸÅŸäŸÜ",juz:30,v:36},
  {n:82,en:"Al-Infitar",ar:"ÿßŸÑÿßŸÜŸÅÿ∑ÿßÿ±",juz:30,v:19},{n:81,en:"At-Takwir",ar:"ÿßŸÑÿ™ŸÉŸàŸäÿ±",juz:30,v:29},
  {n:80,en:"Abasa",ar:"ÿπÿ®ÿ≥",juz:30,v:42},{n:79,en:"An-Nazi'at",ar:"ÿßŸÑŸÜÿßÿ≤ÿπÿßÿ™",juz:30,v:46},
  {n:78,en:"An-Naba",ar:"ÿßŸÑŸÜÿ®ÿ£",juz:30,v:40},{n:77,en:"Al-Mursalat",ar:"ÿßŸÑŸÖÿ±ÿ≥ŸÑÿßÿ™",juz:29,v:50},
  {n:76,en:"Al-Insan",ar:"ÿßŸÑÿ•ŸÜÿ≥ÿßŸÜ",juz:29,v:31},{n:75,en:"Al-Qiyamah",ar:"ÿßŸÑŸÇŸäÿßŸÖÿ©",juz:29,v:40},
  {n:74,en:"Al-Muddaththir",ar:"ÿßŸÑŸÖÿØÿ´ÿ±",juz:29,v:56},{n:73,en:"Al-Muzzammil",ar:"ÿßŸÑŸÖÿ≤ŸÖŸÑ",juz:29,v:20},
  {n:72,en:"Al-Jinn",ar:"ÿßŸÑÿ¨ŸÜ",juz:29,v:28},{n:71,en:"Nuh",ar:"ŸÜŸàÿ≠",juz:29,v:28},
  {n:70,en:"Al-Ma'arij",ar:"ÿßŸÑŸÖÿπÿßÿ±ÿ¨",juz:29,v:44},{n:69,en:"Al-Haqqah",ar:"ÿßŸÑÿ≠ÿßŸÇÿ©",juz:29,v:52},
  {n:68,en:"Al-Qalam",ar:"ÿßŸÑŸÇŸÑŸÖ",juz:29,v:52},{n:67,en:"Al-Mulk",ar:"ÿßŸÑŸÖŸÑŸÉ",juz:29,v:30},
  {n:66,en:"At-Tahrim",ar:"ÿßŸÑÿ™ÿ≠ÿ±ŸäŸÖ",juz:28,v:12},{n:65,en:"At-Talaq",ar:"ÿßŸÑÿ∑ŸÑÿßŸÇ",juz:28,v:12},
  {n:64,en:"At-Taghabun",ar:"ÿßŸÑÿ™ÿ∫ÿßÿ®ŸÜ",juz:28,v:18},{n:63,en:"Al-Munafiqun",ar:"ÿßŸÑŸÖŸÜÿßŸÅŸÇŸàŸÜ",juz:28,v:11},
  {n:62,en:"Al-Jumu'ah",ar:"ÿßŸÑÿ¨ŸÖÿπÿ©",juz:28,v:11},{n:61,en:"As-Saf",ar:"ÿßŸÑÿµŸÅ",juz:28,v:14},
  {n:60,en:"Al-Mumtahanah",ar:"ÿßŸÑŸÖŸÖÿ™ÿ≠ŸÜÿ©",juz:28,v:13},{n:59,en:"Al-Hashr",ar:"ÿßŸÑÿ≠ÿ¥ÿ±",juz:28,v:24},
  {n:58,en:"Al-Mujadila",ar:"ÿßŸÑŸÖÿ¨ÿßÿØŸÑÿ©",juz:28,v:22},{n:57,en:"Al-Hadid",ar:"ÿßŸÑÿ≠ÿØŸäÿØ",juz:27,v:29},
  {n:56,en:"Al-Waqi'ah",ar:"ÿßŸÑŸàÿßŸÇÿπÿ©",juz:27,v:96},{n:55,en:"Ar-Rahman",ar:"ÿßŸÑÿ±ÿ≠ŸÖŸÜ",juz:27,v:78},
  {n:54,en:"Al-Qamar",ar:"ÿßŸÑŸÇŸÖÿ±",juz:27,v:55},{n:53,en:"An-Najm",ar:"ÿßŸÑŸÜÿ¨ŸÖ",juz:27,v:62},
  {n:52,en:"At-Tur",ar:"ÿßŸÑÿ∑Ÿàÿ±",juz:27,v:49},{n:51,en:"Adh-Dhariyat",ar:"ÿßŸÑÿ∞ÿßÿ±Ÿäÿßÿ™",juz:26,v:60},
  {n:50,en:"Qaf",ar:"ŸÇ",juz:26,v:45},{n:49,en:"Al-Hujurat",ar:"ÿßŸÑÿ≠ÿ¨ÿ±ÿßÿ™",juz:26,v:18},
  {n:48,en:"Al-Fath",ar:"ÿßŸÑŸÅÿ™ÿ≠",juz:26,v:29},{n:47,en:"Muhammad",ar:"ŸÖÿ≠ŸÖÿØ",juz:26,v:38},
  {n:46,en:"Al-Ahqaf",ar:"ÿßŸÑÿ£ÿ≠ŸÇÿßŸÅ",juz:26,v:35},{n:45,en:"Al-Jathiyah",ar:"ÿßŸÑÿ¨ÿßÿ´Ÿäÿ©",juz:25,v:37},
  {n:44,en:"Ad-Dukhan",ar:"ÿßŸÑÿØÿÆÿßŸÜ",juz:25,v:59},{n:43,en:"Az-Zukhruf",ar:"ÿßŸÑÿ≤ÿÆÿ±ŸÅ",juz:25,v:89},
  {n:42,en:"Ash-Shura",ar:"ÿßŸÑÿ¥Ÿàÿ±Ÿâ",juz:25,v:53},{n:41,en:"Fussilat",ar:"ŸÅÿµŸÑÿ™",juz:24,v:54},
  {n:40,en:"Ghafir",ar:"ÿ∫ÿßŸÅÿ±",juz:24,v:85},{n:39,en:"Az-Zumar",ar:"ÿßŸÑÿ≤ŸÖÿ±",juz:23,v:75},
  {n:38,en:"Sad",ar:"ÿµ",juz:23,v:88},{n:37,en:"As-Saffat",ar:"ÿßŸÑÿµÿßŸÅÿßÿ™",juz:23,v:182},
  {n:36,en:"Ya-Sin",ar:"Ÿäÿ≥",juz:22,v:83},{n:35,en:"Fatir",ar:"ŸÅÿßÿ∑ÿ±",juz:22,v:45},
  {n:34,en:"Saba",ar:"ÿ≥ÿ®ÿ£",juz:22,v:54},{n:33,en:"Al-Ahzab",ar:"ÿßŸÑÿ£ÿ≠ÿ≤ÿßÿ®",juz:21,v:73},
  {n:32,en:"As-Sajdah",ar:"ÿßŸÑÿ≥ÿ¨ÿØÿ©",juz:21,v:30},{n:31,en:"Luqman",ar:"ŸÑŸÇŸÖÿßŸÜ",juz:21,v:34},
  {n:30,en:"Ar-Rum",ar:"ÿßŸÑÿ±ŸàŸÖ",juz:21,v:60},{n:29,en:"Al-Ankabut",ar:"ÿßŸÑÿπŸÜŸÉÿ®Ÿàÿ™",juz:20,v:69},
  {n:28,en:"Al-Qasas",ar:"ÿßŸÑŸÇÿµÿµ",juz:20,v:88},{n:27,en:"An-Naml",ar:"ÿßŸÑŸÜŸÖŸÑ",juz:19,v:93},
  {n:26,en:"Ash-Shu'ara",ar:"ÿßŸÑÿ¥ÿπÿ±ÿßÿ°",juz:19,v:227},{n:25,en:"Al-Furqan",ar:"ÿßŸÑŸÅÿ±ŸÇÿßŸÜ",juz:18,v:77},
  {n:24,en:"An-Nur",ar:"ÿßŸÑŸÜŸàÿ±",juz:18,v:64},{n:23,en:"Al-Mu'minun",ar:"ÿßŸÑŸÖÿ§ŸÖŸÜŸàŸÜ",juz:18,v:118},
  {n:22,en:"Al-Hajj",ar:"ÿßŸÑÿ≠ÿ¨",juz:17,v:78},{n:21,en:"Al-Anbiya",ar:"ÿßŸÑÿ£ŸÜÿ®Ÿäÿßÿ°",juz:17,v:112},
  {n:20,en:"Ta-Ha",ar:"ÿ∑Ÿá",juz:16,v:135},{n:19,en:"Maryam",ar:"ŸÖÿ±ŸäŸÖ",juz:16,v:98},
  {n:18,en:"Al-Kahf",ar:"ÿßŸÑŸÉŸáŸÅ",juz:15,v:110},{n:17,en:"Al-Isra",ar:"ÿßŸÑÿ•ÿ≥ÿ±ÿßÿ°",juz:15,v:111},
  {n:16,en:"An-Nahl",ar:"ÿßŸÑŸÜÿ≠ŸÑ",juz:14,v:128},{n:15,en:"Al-Hijr",ar:"ÿßŸÑÿ≠ÿ¨ÿ±",juz:14,v:99},
  {n:14,en:"Ibrahim",ar:"ÿ•ÿ®ÿ±ÿßŸáŸäŸÖ",juz:13,v:52},{n:13,en:"Ar-Ra'd",ar:"ÿßŸÑÿ±ÿπÿØ",juz:13,v:43},
  {n:12,en:"Yusuf",ar:"ŸäŸàÿ≥ŸÅ",juz:12,v:111},{n:11,en:"Hud",ar:"ŸáŸàÿØ",juz:11,v:123},
  {n:10,en:"Yunus",ar:"ŸäŸàŸÜÿ≥",juz:11,v:109},{n:9,en:"At-Tawbah",ar:"ÿßŸÑÿ™Ÿàÿ®ÿ©",juz:10,v:129},
  {n:8,en:"Al-Anfal",ar:"ÿßŸÑÿ£ŸÜŸÅÿßŸÑ",juz:9,v:75},{n:7,en:"Al-A'raf",ar:"ÿßŸÑÿ£ÿπÿ±ÿßŸÅ",juz:8,v:206},
  {n:6,en:"Al-An'am",ar:"ÿßŸÑÿ£ŸÜÿπÿßŸÖ",juz:7,v:165},{n:5,en:"Al-Ma'idah",ar:"ÿßŸÑŸÖÿßÿ¶ÿØÿ©",juz:6,v:120},
  {n:4,en:"An-Nisa",ar:"ÿßŸÑŸÜÿ≥ÿßÿ°",juz:4,v:176},{n:3,en:"Aali Imran",ar:"ÿ¢ŸÑ ÿπŸÖÿ±ÿßŸÜ",juz:3,v:200},
  {n:2,en:"Al-Baqarah",ar:"ÿßŸÑÿ®ŸÇÿ±ÿ©",juz:1,v:286},{n:1,en:"Al-Fatiha",ar:"ÿßŸÑŸÅÿßÿ™ÿ≠ÿ©",juz:1,v:7}
];

const STATUS_CYCLE=['not-started','memorising','memorised','revision'];
const STATUS_LABELS={'not-started':'‚¨ú Not Started','memorising':'üìù Memorising','memorised':'‚úÖ Memorised','revision':'üîÑ Revision'};

const SURAH_MEANING={1:'The Opener',2:'The Cow',3:'Family of Imran',4:'The Women',5:'The Table Spread',6:'The Cattle',7:'The Heights',8:'Spoils of War',9:'The Repentance',10:'Jonah',11:'Hud',12:'Joseph',13:'The Thunder',14:'Abraham',15:'The Rocky Tract',16:'The Bee',17:'The Night Journey',18:'The Cave',19:'Mary',20:'Ta-Ha',21:'The Prophets',22:'The Pilgrimage',23:'The Believers',24:'The Light',25:'The Criterion',26:'The Poets',27:'The Ant',28:'The Stories',29:'The Spider',30:'The Romans',31:'Luqman',32:'The Prostration',33:'The Combined Forces',34:'Sheba',35:'Originator',36:'Ya-Sin',37:'Those Who Set the Ranks',38:'Sad',39:'The Troops',40:'The Forgiver',41:'Explained in Detail',42:'The Consultation',43:'Ornaments of Gold',44:'The Smoke',45:'The Crouching',46:'The Sandhills',47:'Muhammad',48:'The Victory',49:'The Rooms',50:'Qaf',51:'The Winds',52:'The Mount',53:'The Star',54:'The Moon',55:'The Beneficent',56:'The Inevitable',57:'The Iron',58:'The Pleading Woman',59:'The Exile',60:'She That Is Examined',61:'The Ranks',62:'The Congregation',63:'The Hypocrites',64:'Mutual Disillusion',65:'The Divorce',66:'The Prohibition',67:'The Sovereignty',68:'The Pen',69:'The Reality',70:'The Ascending Stairways',71:'Noah',72:'The Jinn',73:'The Enshrouded One',74:'The Cloaked One',75:'The Resurrection',76:'The Man',77:'The Emissaries',78:'The Tidings',79:'Those Who Drag Forth',80:'He Frowned',81:'The Overthrowing',82:'The Cleaving',83:'The Defrauding',84:'The Sundering',85:'The Stars',86:'The Night-Comer',87:'The Most High',88:'The Overwhelming',89:'The Dawn',90:'The City',91:'The Sun',92:'The Night',93:'The Morning Hours',94:'The Relief',95:'The Fig',96:'The Clot',97:'The Power',98:'The Clear Proof',99:'The Earthquake',100:'The Courser',101:'The Calamity',102:'Rivalry',103:'The Declining Day',104:'The Traducer',105:'The Elephant',106:'Quraysh',107:'Small Kindnesses',108:'The Abundance',109:'The Disbelievers',110:'Divine Support',111:'The Palm Fibre',112:'The Sincerity',113:'The Daybreak',114:'Mankind'};
const SURAH_TRANSLIT={1:'Al-Fatihah',2:'Al-Baqarah',3:"Ali 'Imran",4:"An-Nisa'",5:"Al-Ma'idah",6:"Al-An'am",7:"Al-A'raf",8:'Al-Anfal',9:'At-Tawbah',10:'Yunus',11:'Hud',12:'Yusuf',13:"Ar-Ra'd",14:'Ibrahim',15:'Al-Hijr',16:'An-Nahl',17:"Al-Isra'",18:'Al-Kahf',19:'Maryam',20:'Ta-Ha',21:'Al-Anbya',22:'Al-Hajj',23:"Al-Mu'minun",24:'An-Nur',25:'Al-Furqan',26:"Ash-Shu'ara",27:'An-Naml',28:'Al-Qasas',29:"Al-'Ankabut",30:'Ar-Rum',31:'Luqman',32:'As-Sajdah',33:'Al-Ahzab',34:"Saba'",35:'Fatir',36:'Ya-Sin',37:'As-Saffat',38:'Sad',39:'Az-Zumar',40:'Ghafir',41:'Fussilat',42:'Ash-Shura',43:'Az-Zukhruf',44:'Ad-Dukhan',45:'Al-Jathiyah',46:'Al-Ahqaf',47:'Muhammad',48:'Al-Fath',49:'Al-Hujurat',50:'Qaf',51:'Adh-Dhariyat',52:'At-Tur',53:'An-Najm',54:'Al-Qamar',55:'Ar-Rahman',56:"Al-Waqi'ah",57:'Al-Hadid',58:'Al-Mujadila',59:'Al-Hashr',60:'Al-Mumtahanah',61:'As-Saf',62:"Al-Jumu'ah",63:'Al-Munafiqun',64:'At-Taghabun',65:'At-Talaq',66:'At-Tahrim',67:'Al-Mulk',68:'Al-Qalam',69:'Al-Haqqah',70:"Al-Ma'arij",71:'Nuh',72:'Al-Jinn',73:'Al-Muzzammil',74:'Al-Muddaththir',75:'Al-Qiyamah',76:'Al-Insan',77:'Al-Mursalat',78:'An-Naba',79:"An-Nazi'at",80:"'Abasa",81:'At-Takwir',82:'Al-Infitar',83:'Al-Mutaffifin',84:'Al-Inshiqaq',85:'Al-Buruj',86:'At-Tariq',87:"Al-A'la",88:'Al-Ghashiyah',89:'Al-Fajr',90:'Al-Balad',91:'Ash-Shams',92:'Al-Layl',93:'Ad-Duhaa',94:'Ash-Sharh',95:'At-Tin',96:"Al-'Alaq",97:'Al-Qadr',98:'Al-Bayyinah',99:'Az-Zalzalah',100:"Al-'Adiyat",101:"Al-Qari'ah",102:'At-Takathur',103:"Al-'Asr",104:'Al-Humazah',105:'Al-Fil',106:'Quraysh',107:"Al-Ma'un",108:'Al-Kawthar',109:'Al-Kafirun',110:'An-Nasr',111:'Al-Masad',112:'Al-Ikhlas',113:'Al-Falaq',114:'An-Nas'};
const SURAH_PLACE={1:'Makkah',2:'Madinah',3:'Madinah',4:'Madinah',5:'Madinah',6:'Makkah',7:'Makkah',8:'Madinah',9:'Madinah',10:'Makkah',11:'Makkah',12:'Makkah',13:'Madinah',14:'Makkah',15:'Makkah',16:'Makkah',17:'Makkah',18:'Makkah',19:'Makkah',20:'Makkah',21:'Makkah',22:'Madinah',23:'Makkah',24:'Madinah',25:'Makkah',26:'Makkah',27:'Makkah',28:'Makkah',29:'Makkah',30:'Makkah',31:'Makkah',32:'Makkah',33:'Madinah',34:'Makkah',35:'Makkah',36:'Makkah',37:'Makkah',38:'Makkah',39:'Makkah',40:'Makkah',41:'Makkah',42:'Makkah',43:'Makkah',44:'Makkah',45:'Makkah',46:'Makkah',47:'Madinah',48:'Madinah',49:'Madinah',50:'Makkah',51:'Makkah',52:'Makkah',53:'Makkah',54:'Makkah',55:'Madinah',56:'Makkah',57:'Madinah',58:'Madinah',59:'Madinah',60:'Madinah',61:'Madinah',62:'Madinah',63:'Madinah',64:'Madinah',65:'Madinah',66:'Madinah',67:'Makkah',68:'Makkah',69:'Makkah',70:'Makkah',71:'Makkah',72:'Makkah',73:'Makkah',74:'Makkah',75:'Makkah',76:'Madinah',77:'Makkah',78:'Makkah',79:'Makkah',80:'Makkah',81:'Makkah',82:'Makkah',83:'Makkah',84:'Makkah',85:'Makkah',86:'Makkah',87:'Makkah',88:'Makkah',89:'Makkah',90:'Makkah',91:'Makkah',92:'Makkah',93:'Makkah',94:'Makkah',95:'Makkah',96:'Makkah',97:'Makkah',98:'Madinah',99:'Madinah',100:'Makkah',101:'Makkah',102:'Makkah',103:'Makkah',104:'Makkah',105:'Makkah',106:'Makkah',107:'Makkah',108:'Makkah',109:'Makkah',110:'Madinah',111:'Makkah',112:'Makkah',113:'Makkah',114:'Makkah'};

const BADGES=[
  {id:'first_step',emoji:'üå±',name:'First Step',desc:'Memorise your first surah',check:s=>s.filter(x=>x.status==='memorised').length>=1},
  {id:'five',emoji:'‚úã',name:'High Five',desc:'Memorise 5 surahs',check:s=>s.filter(x=>x.status==='memorised').length>=5},
  {id:'ten',emoji:'üéØ',name:'Ten Strong',desc:'Memorise 10 surahs',check:s=>s.filter(x=>x.status==='memorised').length>=10},
  {id:'twenty',emoji:'üìö',name:'Scholar',desc:'Memorise 20 surahs',check:s=>s.filter(x=>x.status==='memorised').length>=20},
  {id:'juz_amma',emoji:'üïå',name:'Juz Amma',desc:'Memorise all of Juz 30',check:s=>s.filter(x=>x.juz===30&&x.status==='memorised').length===s.filter(x=>x.juz===30).length},
  {id:'half',emoji:'üåô',name:'Halfway',desc:'Memorise 57+ surahs',check:s=>s.filter(x=>x.status==='memorised').length>=57},
  {id:'full',emoji:'üìñ',name:'Hafidh/Hafidha',desc:'Memorise all 114 surahs',check:s=>s.filter(x=>x.status==='memorised').length===114},
  {id:'first_rev',emoji:'üîÑ',name:'Revisor',desc:'First surah in revision',check:s=>s.filter(x=>x.status==='revision').length>=1},
  {id:'annotator',emoji:'üìù',name:'Annotator',desc:'Add notes to 5 surahs',check:s=>s.filter(x=>x.notes&&x.notes.trim()).length>=5},
  {id:'first_star',emoji:'‚≠ê',name:'First Star',desc:'Rate confidence on a surah',check:s=>s.filter(x=>x.confidence>0).length>=1},
];

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// GLOBAL STATE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let currentUser = null;
let userProfile = null;
let userState   = null; // surahs, heatmap, history, goals, earnedBadges
let activeFilter = 'all';
let activeTab   = '';
let donutChart_ = null;
let juzChart_   = null;
let compareChart_ = null;
let verseCache  = {};
let verseMode   = 'arabic';
let editGoalId  = null;
let unsubListeners = [];

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// FRESH STATE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function freshState() {
  return {
    surahs: SURAHS.map(s=>({...s,status:'not-started',lastRevised:'',notes:'',confidence:0})),
    heatmap: {},
    history: [],
    earnedBadges: [],
    goals:[
      {id:1,title:'Memorise Short Surahs',target:20,deadline:'',metric:'memorised'},
      {id:2,title:'Juz Amma Complete',target:37,deadline:'',metric:'memorised'},
      {id:3,title:'Overall Memorisation',target:114,deadline:'',metric:'memorised'},
      {id:4,title:'Active Revision',target:10,deadline:'',metric:'revision'},
    ]
  };
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// FIREBASE HELPERS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function db()  { return window.__db; }
function auth(){ return window.__auth; }
function fn()  { return window.__firebaseFns; }

async function saveState() {
  if (!currentUser || !userState) return;
  const {doc,setDoc} = fn();
  await setDoc(doc(db(),'users',currentUser.uid,'data','state'), userState);
}

async function loadState() {
  const {doc,getDoc} = fn();
  const snap = await getDoc(doc(db(),'users',currentUser.uid,'data','state'));
  if (snap.exists()) {
    const saved = snap.data();
    // Merge to ensure all 114 surahs present
    const base = freshState();
    if (saved.surahs && saved.surahs.length === 114) base.surahs = saved.surahs;
    base.heatmap = saved.heatmap || {};
    base.history = saved.history || [];
    base.earnedBadges = saved.earnedBadges || [];
    base.goals = saved.goals || base.goals;
    userState = base;
  } else {
    userState = freshState();
    await saveState();
  }
}

async function loadProfile() {
  const {doc,getDoc} = fn();
  const snap = await getDoc(doc(db(),'users',currentUser.uid));
  if (snap.exists()) userProfile = snap.data();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// AUTH SCREEN
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let selectedRole = 'student';

function switchAuthTab(tab) {
  document.querySelectorAll('.auth-tab').forEach((t,i)=>t.classList.toggle('active',['login','signup'][i]===tab));
  document.getElementById('loginForm').classList.toggle('active',tab==='login');
  document.getElementById('signupForm').classList.toggle('active',tab==='signup');
  clearAuthError();
}

function selectRole(role, el) {
  selectedRole = role;
  document.querySelectorAll('.role-card').forEach(c=>c.classList.remove('selected'));
  el.classList.add('selected');
  document.getElementById('classCodeGroup').style.display = (role==='student')?'block':'none';
}

function showAuthError(msg) {
  const el=document.getElementById('authError');
  el.textContent=msg; el.classList.add('visible');
}
function clearAuthError() { document.getElementById('authError').classList.remove('visible'); }

async function handleLogin() {
  const email=document.getElementById('loginEmail').value.trim();
  const pass=document.getElementById('loginPassword').value;
  if(!email||!pass){showAuthError('Please fill in all fields');return;}
  clearAuthError();
  try {
    await fn().signInWithEmailAndPassword(auth(),email,pass);
  } catch(e) {
    showAuthError(e.code==='auth/invalid-credential'?'Invalid email or password.':e.message);
  }
}

async function handleSignup() {
  const name=document.getElementById('signupName').value.trim();
  const email=document.getElementById('signupEmail').value.trim();
  const pass=document.getElementById('signupPassword').value;
  if(!name||!email||!pass){showAuthError('Please fill in all fields');return;}
  if(pass.length<6){showAuthError('Password must be at least 6 characters');return;}
  clearAuthError();
  try {
    const cred = await fn().createUserWithEmailAndPassword(auth(),email,pass);
    const uid = cred.user.uid;
    const classCode = document.getElementById('classCode')?.value.trim()||'';
    const inviteToken = 'inv_'+uid+'_'+Math.random().toString(36).slice(2,8);
    const profile = {name,email,role:selectedRole,uid,inviteToken,classCode,createdAt:new Date().toISOString(),linkedChildren:[],linkedParents:[],linkedTeacher:null};
    const {doc,setDoc} = fn();
    await setDoc(doc(db(),'users',uid),profile);
    // If student with class code, find teacher and link
    if(selectedRole==='student'&&classCode){
      await linkToTeacherByCode(uid,classCode);
    }
  } catch(e) {
    showAuthError(e.code==='auth/email-already-in-use'?'This email is already registered.':e.message);
  }
}

async function linkToTeacherByCode(studentUid, code) {
  const {collection,query,where,getDocs,doc,updateDoc} = fn();
  const q = query(collection(db(),'users'),where('inviteToken','==',code));
  const snap = await getDocs(q);
  if(!snap.empty){
    const teacherDoc = snap.docs[0];
    const teacherData = teacherDoc.data();
    // Add student to teacher's students list
    const students = teacherData.students||[];
    if(!students.includes(studentUid)) students.push(studentUid);
    await updateDoc(doc(db(),'users',teacherDoc.id),{students});
    // Set student's linked teacher
    await updateDoc(doc(db(),'users',studentUid),{linkedTeacher:teacherDoc.id});
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// GOOGLE SIGN-IN
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let pendingGoogleUser = null;
let selectedGoogleRole = 'student';

async function handleGoogleSignIn() {
  clearAuthError();
  try {
    const {GoogleAuthProvider, signInWithPopup} = fn();
    const provider = new GoogleAuthProvider();
    const result = await signInWithPopup(auth(), provider);
    const user = result.user;
    // Check if profile already exists
    const {doc, getDoc} = fn();
    const snap = await getDoc(doc(db(), 'users', user.uid));
    if (snap.exists()) {
      // Existing user ‚Äî onAuthStateChanged will handle the rest
      return;
    }
    // New Google user ‚Äî need to pick a role
    pendingGoogleUser = user;
    selectedGoogleRole = 'student';
    document.getElementById('googleRoleOverlay').style.display = 'flex';
    document.getElementById('googleClassCodeGroup').style.display = 'block';
  } catch(e) {
    if (e.code !== 'auth/popup-closed-by-user') {
      showAuthError(e.message);
    }
  }
}

function selectGoogleRole(role, el) {
  selectedGoogleRole = role;
  document.querySelectorAll('#googleRoleCards .role-card').forEach(c => c.classList.remove('selected'));
  el.classList.add('selected');
  document.getElementById('googleClassCodeGroup').style.display = role === 'student' ? 'block' : 'none';
}

async function confirmGoogleRole() {
  if (!pendingGoogleUser) return;
  const user = pendingGoogleUser;
  const classCode = document.getElementById('googleClassCode')?.value.trim() || '';
  const inviteToken = 'inv_' + user.uid + '_' + Math.random().toString(36).slice(2, 8);
  const name = user.displayName || user.email.split('@')[0];
  const profile = {
    name, email: user.email, role: selectedGoogleRole, uid: user.uid,
    inviteToken, classCode, createdAt: new Date().toISOString(),
    linkedChildren: [], linkedParents: [], linkedTeacher: null,
    photoURL: user.photoURL || null
  };
  const {doc, setDoc} = fn();
  await setDoc(doc(db(), 'users', user.uid), profile);
  if (selectedGoogleRole === 'student' && classCode) {
    await linkToTeacherByCode(user.uid, classCode);
  }
  document.getElementById('googleRoleOverlay').style.display = 'none';
  pendingGoogleUser = null;
  // onAuthStateChanged will now fire and load the app
}

async function handleForgotPassword() {
  const email = prompt('Enter your email address to reset your password:');
  if(!email) return;
  try {
    await fn().sendPasswordResetEmail(auth(),email);
    showToast('üìß','Password reset email sent!','Check your inbox');
  } catch(e) { showToast('‚ùå','Error',e.message); }
}

async function handleSignOut() {
  closeHeaderDropdown();
  unsubListeners.forEach(u=>u&&u());
  unsubListeners=[];
  await fn().signOut(auth());
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// APP INIT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function initApp(user) {
  currentUser = user;
  await loadProfile();
  await loadState();

  // Handle invite token in URL
  const urlParams = new URLSearchParams(window.location.search);
  const inviteToken = urlParams.get('invite');
  if(inviteToken) await handleInviteFromURL(inviteToken);

  // Setup UI
  document.getElementById('authScreen').classList.remove('active');
  document.getElementById('appScreen').classList.add('active');
  updateHeaderUser();
  buildNav();
  showFirstTab();
  hideLoading();
}

function updateHeaderUser() {
  if(!userProfile) return;
  const initial = (userProfile.name||'U')[0].toUpperCase();
  const avatarEl = document.getElementById('headerAvatar');
  if(userProfile.photoURL) {
    avatarEl.innerHTML = `<img src="${userProfile.photoURL}" style="width:100%;height:100%;border-radius:50%;object-fit:cover" referrerpolicy="no-referrer">`;
  } else {
    avatarEl.textContent = initial;
  }
  document.getElementById('headerName').textContent = userProfile.name||'User';
  const badge = document.getElementById('roleBadge');
  badge.textContent = {teacher:'üë©‚Äçüè´ Teacher',parent:'üë®‚Äçüë©‚Äçüëß Parent',student:'üßë‚Äçüéì Student'}[userProfile.role]||'';
  badge.className = 'role-badge '+(userProfile.role||'student');
}

function buildNav() {
  const role = userProfile?.role||'student';
  const nav = document.getElementById('mainNav');
  let tabs = [];
  if(role==='student'||role==='teacher') {
    if(role==='student') {
      tabs=[
        {id:'overview',label:'üìä Overview'},
        {id:'surahs',label:'üìñ Surahs'},
        {id:'juz',label:'üìö By Juz'},
        {id:'heatmap',label:'üìÖ Revision Calendar'},
        {id:'goals',label:'üéØ Goals'},
        {id:'history',label:'üìú History'},
        {id:'connect',label:'üîó Connect'},
      ];
    } else {
      tabs=[
        {id:'teacher-overview',label:'üë• Class Overview'},
        {id:'teacher-messages',label:'üí¨ Messages'},
        {id:'teacher-invite',label:'üîó Invite & Manage'},
        {id:'overview',label:'üìä My Progress'},
        {id:'surahs',label:'üìñ My Surahs'},
        {id:'heatmap',label:'üìÖ My Calendar'},
      ];
    }
  } else {
    tabs=[
      {id:'parent-children',label:'üë¶üëß My Children'},
      {id:'parent-messages',label:'üí¨ Message Teacher'},
      {id:'parent-connect',label:'üîó Link a Child'},
    ];
  }
  nav.innerHTML = tabs.map(t=>`<button class="tab-btn" id="navbtn-${t.id}" onclick="showTab('${t.id}')">${t.label}</button>`).join('');
}

function showFirstTab() {
  const role = userProfile?.role||'student';
  if(role==='teacher') showTab('teacher-overview');
  else if(role==='parent') showTab('parent-children');
  else showTab('overview');
}

function showTab(name) {
  document.querySelectorAll('.tab-section').forEach(s=>s.classList.remove('active'));
  document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
  const sec = document.getElementById('tab-'+name);
  if(sec) sec.classList.add('active');
  const btn = document.getElementById('navbtn-'+name);
  if(btn) btn.classList.add('active');
  activeTab = name;
  renderTab(name);
}

function renderTab(name) {
  if(name==='overview')          { renderKPIs(); renderCharts(); renderBadges(); }
  if(name==='surahs')            renderTable();
  if(name==='juz')               renderJuzBars();
  if(name==='heatmap')           { renderHeatmap(); renderDueList(); }
  if(name==='goals')             renderGoals();
  if(name==='history')           renderHistory();
  if(name==='connect')           renderConnectTab();
  if(name==='teacher-overview')  renderTeacherOverview();
  if(name==='teacher-messages')  renderTeacherMessages();
  if(name==='teacher-invite')    renderTeacherInvite();
  if(name==='parent-children')   renderParentChildren();
  if(name==='parent-messages')   renderParentMessages();
  if(name==='parent-connect')    renderParentConnect();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// KPIs
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function getStats(surahs) {
  const s = surahs||userState.surahs;
  const m=s.filter(x=>x.status==='memorised').length;
  const mg=s.filter(x=>x.status==='memorising').length;
  const r=s.filter(x=>x.status==='revision').length;
  return {m,mg,r,ns:114-m-mg-r,pct:Math.round(m/114*100)};
}

function todayStr() { return new Date().toISOString().slice(0,10); }

function calcStreak() {
  let streak=0;
  const today=new Date(todayStr());
  for(let i=0;i<365;i++){
    const d=new Date(today); d.setDate(d.getDate()-i);
    const ds=d.toISOString().slice(0,10);
    if(userState.heatmap[ds]) streak++; else if(i>0) break;
  }
  return streak;
}

function renderKPIs() {
  const {m,mg,r,pct}=getStats();
  const streak=calcStreak();
  const rated=userState.surahs.filter(s=>s.confidence>0);
  const avg=rated.length?(rated.reduce((a,s)=>a+s.confidence,0)/rated.length).toFixed(1):'‚Äî';
  document.getElementById('kpiGrid').innerHTML=`
    <div class="kpi-card c1"><div class="kpi-icon">üìñ</div><div class="kpi-value" style="color:var(--teal)">${m+mg+r}</div><div class="kpi-label">Total Tracked</div></div>
    <div class="kpi-card c2"><div class="kpi-icon">‚úÖ</div><div class="kpi-value" style="color:var(--green)">${m}</div><div class="kpi-label">Memorised</div></div>
    <div class="kpi-card c3"><div class="kpi-icon">üìù</div><div class="kpi-value" style="color:var(--blue)">${mg}</div><div class="kpi-label">Memorising</div></div>
    <div class="kpi-card c4"><div class="kpi-icon">üîÑ</div><div class="kpi-value" style="color:var(--amber)">${r}</div><div class="kpi-label">In Revision</div></div>
    <div class="kpi-card c1"><div class="kpi-icon">üåü</div><div class="kpi-value" style="color:var(--teal)">${pct}%</div><div class="kpi-label">Completion</div><div class="kpi-bar"><div class="kpi-bar-fill" style="width:${pct}%"></div></div></div>
    <div class="kpi-card c5"><div class="kpi-icon">üî•</div><div class="kpi-value" style="color:#e8a4b8">${streak}</div><div class="kpi-label">Day Streak</div></div>
    <div class="kpi-card c3"><div class="kpi-icon">‚≠ê</div><div class="kpi-value" style="color:var(--blue)">${avg==='‚Äî'?'‚Äî':avg+'‚òÖ'}</div><div class="kpi-label">Avg Confidence</div></div>`;
  document.getElementById('donutNum').textContent=m;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CHARTS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderCharts() {
  const {m,mg,r,ns}=getStats();
  if(donutChart_) donutChart_.destroy();
  donutChart_=new Chart(document.getElementById('donutChart').getContext('2d'),{
    type:'doughnut',
    data:{labels:['Memorised','Memorising','Revision','Not Started'],datasets:[{data:[m,mg,r,ns],backgroundColor:['#88aa88','#b8829a','#c4a0b4','#e8dde4'],borderWidth:0,hoverOffset:5}]},
    options:{cutout:'72%',plugins:{legend:{display:false},tooltip:{backgroundColor:'#fff',borderColor:'#e8dde4',borderWidth:1,titleColor:'#3a2a34',bodyColor:'#7a6070',padding:10}},animation:{animateRotate:true,duration:700}}
  });
  const jd=buildJuzData();
  if(juzChart_) juzChart_.destroy();
  juzChart_=new Chart(document.getElementById('juzChart').getContext('2d'),{
    type:'bar',
    data:{labels:jd.map(j=>'J'+j.juz),datasets:[
      {label:'Memorised',data:jd.map(j=>j.m),backgroundColor:'#88aa88',borderRadius:3,borderSkipped:false},
      {label:'Memorising',data:jd.map(j=>j.mg),backgroundColor:'#b8829a',borderRadius:3,borderSkipped:false},
      {label:'Revision',data:jd.map(j=>j.r),backgroundColor:'#c4a0b4',borderRadius:3,borderSkipped:false},
    ]},
    options:{responsive:true,maintainAspectRatio:false,scales:{x:{stacked:true,grid:{color:'rgba(232,221,228,0.7)'},ticks:{color:'#a898a4',font:{size:9}}},y:{stacked:true,grid:{color:'rgba(232,221,228,0.7)'},ticks:{color:'#a898a4',stepSize:1}}},plugins:{legend:{labels:{color:'#7a6070',font:{size:11},boxWidth:10}},tooltip:{backgroundColor:'#fff',borderColor:'#e8dde4',borderWidth:1,titleColor:'#3a2a34',bodyColor:'#7a6070',padding:9}},animation:{duration:500}}
  });
}

function buildJuzData(surahs) {
  const s=surahs||userState.surahs;
  return Array.from({length:30},(_,i)=>{
    const j=i+1,ss=s.filter(x=>x.juz===j);
    return{juz:j,m:ss.filter(x=>x.status==='memorised').length,mg:ss.filter(x=>x.status==='memorising').length,r:ss.filter(x=>x.status==='revision').length,total:ss.length};
  });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// BADGES
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderBadges() {
  const prev=userState.earnedBadges||[];
  const now=BADGES.filter(b=>b.check(userState.surahs)).map(b=>b.id);
  const newOnes=now.filter(id=>!prev.includes(id));
  if(newOnes.length){
    userState.earnedBadges=now;
    newOnes.forEach(id=>{const b=BADGES.find(x=>x.id===id);if(b){logActivity('üèÜ',`Badge: ${b.name}`,b.desc);showToast('üèÜ','Badge Earned: '+b.name,b.desc);}});
    saveState();
  }
  const grid=document.getElementById('badgesSectionOverview');
  if(grid) grid.innerHTML=BADGES.map(b=>{const e=now.includes(b.id);return`<div class="badge-card ${e?'earned':'locked'}">${e?'<div class="badge-earned-tag">‚úì EARNED</div>':''}<div class="badge-emoji">${b.emoji}</div><div class="badge-name">${b.name}</div><div class="badge-desc">${b.desc}</div></div>`;}).join('');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SURAH TABLE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderTable() {
  const tbody=document.getElementById('surahTableBody');
  tbody.innerHTML='';
  userState.surahs.forEach((s,i)=>{
    const tr=document.createElement('tr');
    tr.dataset.name=s.en.toLowerCase(); tr.dataset.status=s.status;
    tr.innerHTML=`
      <td><div class="surah-num">${s.n}</div></td>
      <td><button class="surah-name-btn" onclick="openSurahViewer(${s.n})">${s.en}</button></td>
      <td><div class="arabic-col">${s.ar}</div></td>
      <td style="color:var(--text3)">${s.juz}</td>
      <td style="color:var(--text3)">${s.v}</td>
      <td><button class="status-badge ${s.status}" onclick="cycleStatus(${i})">${STATUS_LABELS[s.status]}</button></td>
      <td><input type="date" class="date-input" value="${s.lastRevised||''}" onchange="updateRevised(${i},this.value)"></td>
      <td><div class="star-rating">${[1,2,3,4,5].map(x=>`<span class="star ${x<=(s.confidence||0)?'filled':''}" onclick="setConf(${i},${x})">‚òÖ</span>`).join('')}</div></td>
      <td><input type="text" class="notes-input" value="${(s.notes||'').replace(/"/g,'&quot;')}" placeholder="Add notes‚Ä¶" onchange="updateNotes(${i},this.value)"></td>`;
    tbody.appendChild(tr);
  });
  filterTable();
}

function cycleStatus(i) {
  const s=userState.surahs[i];
  const prev=s.status;
  s.status=STATUS_CYCLE[(STATUS_CYCLE.indexOf(prev)+1)%STATUS_CYCLE.length];
  logActivity({memorised:'‚úÖ',memorising:'üìù',revision:'üîÑ','not-started':'‚¨ú'}[s.status],`Status: ${s.en}`,`${STATUS_LABELS[prev]} ‚Üí ${STATUS_LABELS[s.status]}`);
  saveState(); renderTable(); renderKPIs(); renderBadges();
}

function updateRevised(i,val) {
  userState.surahs[i].lastRevised=val;
  if(val) logActivity('üìÖ',`Revised: ${userState.surahs[i].en}`,new Date(val).toLocaleDateString('en-GB',{day:'numeric',month:'short',year:'numeric'}));
  saveState();
}

function updateNotes(i,val) {
  userState.surahs[i].notes=val;
  if(val.trim()) logActivity('üìù',`Note: ${userState.surahs[i].en}`,val.slice(0,60));
  saveState();
}

function setConf(i,val) {
  const s=userState.surahs[i];
  s.confidence=s.confidence===val?0:val;
  logActivity('‚≠ê',`Confidence: ${s.en}`,s.confidence?`${s.confidence}/5‚òÖ`:'Cleared');
  saveState(); renderTable(); renderKPIs();
}

function setFilter(f,btn) {
  activeFilter=f;
  document.querySelectorAll('.filter-btn').forEach(b=>b.classList.remove('active-filter'));
  btn.classList.add('active-filter');
  filterTable();
}

function filterTable() {
  const q=(document.getElementById('searchInput')?.value||'').toLowerCase();
  document.querySelectorAll('#surahTableBody tr').forEach(row=>{
    const match=(!q||row.dataset.name.includes(q))&&(activeFilter==='all'||row.dataset.status===activeFilter);
    row.style.display=match?'':'none';
  });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// JUZ BARS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderJuzBars() {
  document.getElementById('juzBarsContainer').innerHTML=buildJuzData().map(j=>{
    const pct=j.total?Math.round(j.m/j.total*100):0;
    return`<div class="juz-bar">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:5px">
        <div style="font-size:13px;font-weight:600">Juz ${j.juz}</div>
        <div style="font-size:12px;color:var(--text3)">${j.m}/${j.total} memorised</div>
        <div style="font-size:12px;font-weight:600;color:var(--teal)">${pct}%</div>
      </div>
      <div style="height:8px;background:var(--border);border-radius:4px;overflow:hidden;display:flex">
        <div style="width:${j.total?Math.round(j.m/j.total*100):0}%;background:var(--green);transition:width 0.6s"></div>
        <div style="width:${j.total?Math.round(j.mg/j.total*100):0}%;background:var(--blue);transition:width 0.6s"></div>
        <div style="width:${j.total?Math.round(j.r/j.total*100):0}%;background:var(--amber);transition:width 0.6s"></div>
      </div>
    </div>`;
  }).join('');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// HEATMAP
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function logTodayRevision() {
  const today=todayStr();
  userState.heatmap[today]=(userState.heatmap[today]||0)+1;
  logActivity('üóìÔ∏è','Revision logged',`Session ${userState.heatmap[today]} today`);
  await saveState(); renderHeatmap(); renderDueList();
  showToast('‚úÖ','Revision logged!','Keep it up!');
}

function renderHeatmap() {
  const today=new Date();
  const start=new Date(today); start.setDate(start.getDate()-52*7+1);
  const dow=start.getDay()||7; if(dow!==1) start.setDate(start.getDate()-(dow-1));
  const cols=document.getElementById('heatmapCols');
  const monthsEl=document.getElementById('heatmapMonths');
  cols.innerHTML=''; monthsEl.innerHTML='';
  const months=['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
  let colDate=new Date(start),lastMonth=-1,monthSpans=[];
  for(let c=0;c<53;c++){
    const col=document.createElement('div'); col.className='heatmap-col';
    for(let r=0;r<7;r++){
      const d=new Date(colDate); d.setDate(d.getDate()+r);
      const ds=d.toISOString().slice(0,10);
      const count=(userState.heatmap||{})[ds]||0;
      const cell=document.createElement('div'); cell.className='heatmap-cell';
      if(count>=4) cell.classList.add('l4'); else if(count===3) cell.classList.add('l3'); else if(count===2) cell.classList.add('l2'); else if(count===1) cell.classList.add('l1');
      if(ds===todayStr()) cell.classList.add('today');
      cell.title=ds+(count?` ‚Äî ${count} session${count>1?'s':''}`:'');
      cell.onclick=()=>{userState.heatmap[ds]=(userState.heatmap[ds]||0)+1;saveState();renderHeatmap();};
      col.appendChild(cell);
      const m=d.getMonth(); if(m!==lastMonth&&r===0){monthSpans.push({col:c,label:months[m]});lastMonth=m;}
    }
    colDate.setDate(colDate.getDate()+7); cols.appendChild(col);
  }
  monthsEl.innerHTML=monthSpans.map((ms,i)=>{
    const gap=i<monthSpans.length-1?(monthSpans[i+1].col-ms.col)*16:50;
    return`<div class="month-label" style="min-width:${gap}px">${ms.label}</div>`;
  }).join('');
}

function renderDueList() {
  const todayD=new Date(todayStr());
  const due=userState.surahs.filter(s=>{
    if(s.status!=='memorised'&&s.status!=='revision') return false;
    if(!s.lastRevised) return true;
    return(todayD-new Date(s.lastRevised))/(86400000)>=7;
  });
  const el=document.getElementById('dueList');
  if(!due.length){el.innerHTML='<div class="empty-state"><div class="empty-icon">‚úÖ</div><p>All caught up! No surahs overdue.</p></div>';return;}
  el.innerHTML=due.map(s=>{
    const days=!s.lastRevised?'Never revised':`${Math.round((new Date(todayStr())-new Date(s.lastRevised))/86400000)}d ago`;
    return`<div class="due-item"><div><div style="font-size:13px;font-weight:600">${s.n}. ${s.en} <span style="font-family:var(--arabic);color:var(--gold)">${s.ar}</span></div><div style="font-size:11px;color:var(--text3);margin-top:2px">${STATUS_LABELS[s.status]}</div></div><div style="font-size:12px;color:var(--red);font-weight:600">‚ö†Ô∏è ${days}</div></div>`;
  }).join('');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// GOALS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderGoals() {
  const {m,mg,r}=getStats();
  const mm={'memorised':m,'memorising':mg,'revision':r};
  document.getElementById('goalsGrid').innerHTML=userState.goals.map(g=>{
    const cur=mm[g.metric]||0,pct=Math.min(100,Math.round(cur/g.target*100));
    const dl=g.deadline?`üóìÔ∏è ${new Date(g.deadline).toLocaleDateString('en-GB',{day:'numeric',month:'short',year:'numeric'})}`:'üóìÔ∏è No deadline set';
    return`<div class="goal-card">
      <div style="display:flex;justify-content:space-between;align-items:center"><div style="font-size:15px;font-weight:600">${g.title}</div><button class="btn btn-sm btn-secondary" onclick="openGoalModal(${g.id})">‚úèÔ∏è Edit</button></div>
      <div class="goal-nums"><div class="goal-current">${cur}</div><div class="goal-sep">/</div><div class="goal-target">${g.target}</div></div>
      <div style="font-size:12px;color:var(--text3);margin-bottom:6px">${g.metric==='memorised'?'surahs memorised':g.metric==='revision'?'in revision':'memorising'}</div>
      <div class="goal-bar"><div class="goal-bar-fill" style="width:${pct}%"></div></div>
      <div style="display:flex;justify-content:space-between"><div style="font-size:12px;color:var(--text3)">${dl}</div><div style="font-size:12px;font-weight:600;color:${pct>=100?'var(--green)':'var(--teal)'}">${pct}%${pct>=100?' üéâ':''}</div></div>
    </div>`;
  }).join('');
}

function openGoalModal(id) {
  editGoalId=id;
  const g=userState.goals.find(x=>x.id===id);
  document.getElementById('goalTitle').value=g.title;
  document.getElementById('goalTarget').value=g.target;
  document.getElementById('goalDeadline').value=g.deadline||'';
  document.getElementById('goalModal').classList.add('open');
}
function closeGoalModal(){document.getElementById('goalModal').classList.remove('open');}
async function saveGoal(){
  const g=userState.goals.find(x=>x.id===editGoalId);
  g.title=document.getElementById('goalTitle').value;
  g.target=parseInt(document.getElementById('goalTarget').value)||g.target;
  g.deadline=document.getElementById('goalDeadline').value;
  logActivity('üéØ',`Goal updated: ${g.title}`,`Target: ${g.target}`);
  await saveState(); closeGoalModal(); renderGoals();
}
document.getElementById('goalModal').addEventListener('click',e=>{if(e.target===e.currentTarget)closeGoalModal();});

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// HISTORY
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function logActivity(icon,action,detail){
  if(!userState.history) userState.history=[];
  userState.history.unshift({icon,action,detail,ts:new Date().toISOString()});
  if(userState.history.length>200) userState.history=userState.history.slice(0,200);
}

function renderHistory(){
  const el=document.getElementById('historyList');
  if(!userState.history?.length){el.innerHTML='<div class="empty-state"><div class="empty-icon">üìú</div><p>No activity yet. Start by updating a surah!</p></div>';return;}
  el.innerHTML=userState.history.map(h=>{
    const d=new Date(h.ts),now=new Date();
    const mins=Math.floor((now-d)/60000),hrs=Math.floor((now-d)/3600000),days=Math.floor((now-d)/86400000);
    const t=mins<1?'Just now':mins<60?mins+'m ago':hrs<24?hrs+'h ago':days===1?'Yesterday':days+'d ago';
    return`<div class="history-item"><div class="history-icon">${h.icon}</div><div class="history-content"><div class="history-action">${h.action}</div><div class="history-detail">${h.detail}</div></div><div class="history-time">${t}</div></div>`;
  }).join('');
}

async function clearHistory(){
  if(!confirm('Clear all activity history?')) return;
  userState.history=[]; await saveState(); renderHistory();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CONNECT TAB (STUDENT)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function renderConnectTab() {
  // Re-fetch so linked parents info is always current
  const {doc,getDoc}=fn();
  const freshSnap=await getDoc(doc(db(),'users',currentUser.uid));
  if(freshSnap.exists()) userProfile=freshSnap.data();
  const el=document.getElementById('connectContent');
  const inviteLink=`${window.location.origin}${window.location.pathname}?invite=${userProfile.inviteToken}`;
  el.innerHTML=`
    <div class="card" style="margin-bottom:16px">
      <div class="card-title">üë®‚Äçüë©‚Äçüëß Share with Parents</div>
      <p style="font-size:13px;color:var(--text2);margin-bottom:12px">Send this link to your parents so they can link to your account and view your progress.</p>
      <div class="invite-box">
        <div style="font-size:12px;color:var(--text3);margin-bottom:6px">Your invite link:</div>
        <code class="invite-link">${inviteLink}</code>
        <div class="invite-actions">
          <button class="btn btn-sm btn-primary" style="width:auto;margin:0" onclick="navigator.clipboard.writeText('${inviteLink}').then(()=>showToast('üìã','Copied!','Link copied to clipboard'))">üìã Copy Link</button>
          <button class="btn btn-sm btn-secondary" onclick="shareInviteLink('${inviteLink}')">üì§ Share</button>
        </div>
      </div>
    </div>
    <div class="card" style="margin-bottom:16px">
      <div class="card-title">üë®‚Äçüë©‚Äçüëß Linked Parents</div>
      <div id="linkedParentsInfo"></div>
    </div>
    <div class="card">
      <div class="card-title">üë©‚Äçüè´ Linked Teacher</div>
      <div id="linkedTeacherInfo"></div>
    </div>`;
  loadLinkedParentsInfo();
  loadLinkedTeacherInfo();
}

async function loadLinkedParentsInfo() {
  const el=document.getElementById('linkedParentsInfo');
  if(!el) return;
  const parents=userProfile.linkedParents||[];
  if(!parents.length){
    el.innerHTML=`<div class="empty-state" style="padding:16px"><div class="empty-icon" style="font-size:28px">üë®‚Äçüë©‚Äçüëß</div><p>No parents linked yet. Share your invite link above with your parents.</p></div>`;
    return;
  }
  const {doc,getDoc}=fn();
  let html='';
  for(const uid of parents){
    const snap=await getDoc(doc(db(),'users',uid));
    if(!snap.exists()) continue;
    const p=snap.data();
    html+=`<div style="display:flex;align-items:center;gap:12px;padding:10px;background:rgba(136,170,136,0.08);border-radius:10px;margin-bottom:8px">
      <div class="student-avatar" style="width:34px;height:34px;font-size:13px;background:linear-gradient(135deg,#88aa88,#a8c8a8)">${(p.name||'P')[0]}</div>
      <div><div style="font-size:13px;font-weight:600">${p.name}</div><div style="font-size:11px;color:var(--text3)">${p.email}</div></div>
      <div style="margin-left:auto;font-size:11px;color:var(--green);font-weight:600">‚úì Linked</div>
    </div>`;
  }
  el.innerHTML=html;
}

async function loadLinkedTeacherInfo() {
  const el=document.getElementById('linkedTeacherInfo');
  if(!el) return;
  if(userProfile.linkedTeacher){
    const {doc,getDoc}=fn();
    const snap=await getDoc(doc(db(),'users',userProfile.linkedTeacher));
    if(snap.exists()){
      const t=snap.data();
      el.innerHTML=`<div style="display:flex;align-items:center;gap:12px;padding:12px;background:rgba(168,160,200,0.08);border-radius:10px"><div class="student-avatar" style="width:36px;height:36px;font-size:14px">${(t.name||'T')[0]}</div><div><div style="font-size:13px;font-weight:600">${t.name}</div><div style="font-size:11px;color:var(--text3)">${t.email}</div></div></div>`;
    }
  } else {
    el.innerHTML=`<div class="empty-state" style="padding:20px"><div class="empty-icon">üë©‚Äçüè´</div><p>Not yet linked to a class. Ask your teacher for their class code when signing up.</p></div>`;
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// INVITE HANDLING
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function handleInviteFromURL(token) {
  // Find user with this invite token
  const {collection,query,where,getDocs,doc,updateDoc,arrayUnion} = fn();
  const q=query(collection(db(),'users'),where('inviteToken','==',token));
  const snap=await getDocs(q);
  if(snap.empty) return;
  const invitedUser=snap.docs[0].data();
  const role=userProfile?.role;
  if(!role) return;

  if(role==='parent'&&invitedUser.role==='student'){
    // Parent linking to child
    const childUid=invitedUser.uid;
    if(!(userProfile.linkedChildren||[]).includes(childUid)){
      await updateDoc(doc(db(),'users',currentUser.uid),{linkedChildren:arrayUnion(childUid)});
      await updateDoc(doc(db(),'users',childUid),{linkedParents:arrayUnion(currentUser.uid)});
      userProfile.linkedChildren=[...(userProfile.linkedChildren||[]),childUid];
      showToast('üîó',`Linked to ${invitedUser.name}!`,'You can now view their progress');
    }
  } else if(role==='student'&&invitedUser.role==='parent'){
    // Student linking to parent
    const parentUid=invitedUser.uid;
    if(!(userProfile.linkedParents||[]).includes(parentUid)){
      await updateDoc(doc(db(),'users',currentUser.uid),{linkedParents:arrayUnion(parentUid)});
      await updateDoc(doc(db(),'users',parentUid),{linkedChildren:arrayUnion(currentUser.uid)});
      userProfile.linkedParents=[...(userProfile.linkedParents||[]),parentUid];
      showToast('üîó',`Linked to ${invitedUser.name}!`,'They can now view your progress');
    }
  }
  // Clean URL
  window.history.replaceState({},'',window.location.pathname);
}

function copyInviteLink() {
  const inviteLink=`${window.location.origin}${window.location.pathname}?invite=${userProfile.inviteToken}`;
  navigator.clipboard.writeText(inviteLink).then(()=>showToast('üìã','Copied!','Share this link with parents or children'));
  closeHeaderDropdown();
}

function shareInviteLink(link) {
  if(navigator.share){navigator.share({title:'Quran Tracker Invite',url:link});}
  else{navigator.clipboard.writeText(link).then(()=>showToast('üìã','Copied!',''));}
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// TEACHER DASHBOARD
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let teacherSubTab='students';
let compareChart2=null;

function setTeacherSubTab(tab,btn){
  teacherSubTab=tab;
  document.querySelectorAll('.pill-tab').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
  document.getElementById('teacherStudentsPane').style.display=tab==='students'?'':'none';
  document.getElementById('teacherAlertsPane').style.display=tab==='alerts'?'':'none';
  document.getElementById('teacherComparePane').style.display=tab==='compare'?'':'none';
  if(tab==='compare') renderCompareChart();
}

async function renderTeacherOverview() {
  const {doc,getDoc,collection,query,where,getDocs}=fn();
  const grid=document.getElementById('classOverviewGrid');
  const todayBar=document.getElementById('revisedTodayBar');
  grid.innerHTML='<div style="color:var(--text3);font-size:13px;padding:20px">Loading students‚Ä¶</div>';

  // Always re-fetch teacher profile so students list is up to date
  const freshSnap=await getDoc(doc(db(),'users',currentUser.uid));
  if(freshSnap.exists()) userProfile=freshSnap.data();

  const students=userProfile.students||[];
  if(!students.length){
    grid.innerHTML='<div class="empty-state"><div class="empty-icon">üë•</div><p>No students yet. Share your class code to invite students.</p></div>';
    todayBar.innerHTML='';
    return;
  }

  const today=todayStr();
  const studentData=[];
  for(const uid of students){
    const snap=await getDoc(doc(db(),'users',uid));
    if(!snap.exists()) continue;
    const profile=snap.data();
    const stateSnap=await getDoc(doc(db(),'users',uid,'data','state'));
    const st=stateSnap.exists()?stateSnap.data():freshState();
    studentData.push({uid,profile,st});
  }

  window._teacherStudentData=studentData;

  let revisedToday=0;
  grid.innerHTML=studentData.map(({uid,profile,st})=>{
    const s=st.surahs||freshState().surahs;
    const m=s.filter(x=>x.status==='memorised').length;
    const mg=s.filter(x=>x.status==='memorising').length;
    const r=s.filter(x=>x.status==='revision').length;
    const pct=Math.round(m/114*100);
    const didRevise=st.heatmap&&st.heatmap[today];
    if(didRevise) revisedToday++;
    return`<div class="student-card" onclick="openStudentDetail('${uid}')">
      <div class="student-card-header">
        <div class="student-avatar">${(profile.name||'S')[0].toUpperCase()}</div>
        <div><div class="student-name">${profile.name}</div><div class="student-email">${profile.email}</div></div>
        <div class="revised-today-dot ${didRevise?'yes':'no'}" title="${didRevise?'Revised today':'Not yet today'}" style="margin-left:auto"></div>
      </div>
      <div class="student-mini-stats">
        <div class="mini-stat m">‚úÖ ${m}</div>
        <div class="mini-stat mg">üìù ${mg}</div>
        <div class="mini-stat r">üîÑ ${r}</div>
      </div>
      <div class="student-progress-bar"><div class="student-progress-fill" style="width:${pct}%"></div></div>
      <div style="font-size:11px;color:var(--text3);margin-top:6px">${pct}% memorised</div>
    </div>`;
  }).join('');

  todayBar.innerHTML=`
    <div style="font-size:13px;font-weight:600">Today's Revision</div>
    <div style="display:flex;align-items:center;gap:6px"><div class="revised-today-dot yes"></div><span style="font-size:13px;color:var(--text2)">${revisedToday} revised</span></div>
    <div style="display:flex;align-items:center;gap:6px"><div class="revised-today-dot no"></div><span style="font-size:13px;color:var(--text2)">${students.length-revisedToday} not yet</span></div>`;

  renderTeacherAlerts(studentData);
}

function renderTeacherAlerts(studentData) {
  const todayD=new Date(todayStr());
  const el=document.getElementById('alertsList');
  let html='';
  (studentData||window._teacherStudentData||[]).forEach(({profile,st})=>{
    const s=st.surahs||[];
    s.filter(x=>(x.status==='memorised'||x.status==='revision')&&(!x.lastRevised||(todayD-new Date(x.lastRevised))/86400000>=7)).forEach(x=>{
      const days=!x.lastRevised?'Never revised':`${Math.round((todayD-new Date(x.lastRevised))/86400000)}d ago`;
      html+=`<div class="alert-card" style="margin-bottom:10px">
        <div class="alert-info">
          <div class="alert-name">${profile.name} ‚Äî ${x.en} <span style="font-family:var(--arabic);color:var(--gold)">${x.ar}</span></div>
          <div class="alert-detail">${STATUS_LABELS[x.status]}</div>
        </div>
        <div class="alert-days">‚ö†Ô∏è ${days}</div>
      </div>`;
    });
  });
  el.innerHTML=html||'<div class="empty-state"><div class="empty-icon">‚úÖ</div><p>No overdue revisions!</p></div>';
}

function renderCompareChart(){
  const data=window._teacherStudentData||[];
  if(!data.length) return;
  const labels=data.map(d=>d.profile.name);
  const vals=data.map(d=>(d.st.surahs||[]).filter(x=>x.status==='memorised').length);
  const canvas=document.getElementById('compareChart');
  if(compareChart2) compareChart2.destroy();
  compareChart2=new Chart(canvas.getContext('2d'),{
    type:'bar',
    data:{labels,datasets:[{label:'Memorised Surahs',data:vals,backgroundColor:'#b8829a',borderRadius:6}]},
    options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false},tooltip:{backgroundColor:'#fff',borderColor:'#e8dde4',borderWidth:1,titleColor:'#3a2a34',bodyColor:'#7a6070',padding:10}},scales:{y:{beginAtZero:true,max:114,ticks:{color:'#a898a4'},grid:{color:'rgba(232,221,228,0.7)'}},x:{ticks:{color:'#a898a4'},grid:{display:false}}}}
  });
}

function openStudentDetail(uid) {
  const data=(window._teacherStudentData||[]).find(d=>d.uid===uid);
  if(!data) return;
  const {profile,st}=data;
  const s=st.surahs||[];
  const m=s.filter(x=>x.status==='memorised').length;
  const mg=s.filter(x=>x.status==='memorising').length;
  const r=s.filter(x=>x.status==='revision').length;
  const pct=Math.round(m/114*100);
  document.getElementById('sdmTitle').textContent=profile.name+"'s Progress";
  document.getElementById('sdmContent').innerHTML=`
    <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin-bottom:16px">
      <div style="text-align:center;background:rgba(136,170,136,0.1);border-radius:10px;padding:12px"><div style="font-size:22px;font-weight:700;color:var(--green)">${m}</div><div style="font-size:11px;color:var(--text3)">Memorised</div></div>
      <div style="text-align:center;background:rgba(184,130,154,0.1);border-radius:10px;padding:12px"><div style="font-size:22px;font-weight:700;color:var(--teal)">${mg}</div><div style="font-size:11px;color:var(--text3)">Memorising</div></div>
      <div style="text-align:center;background:rgba(196,160,180,0.1);border-radius:10px;padding:12px"><div style="font-size:22px;font-weight:700;color:var(--amber)">${r}</div><div style="font-size:11px;color:var(--text3)">Revision</div></div>
      <div style="text-align:center;background:rgba(168,160,200,0.1);border-radius:10px;padding:12px"><div style="font-size:22px;font-weight:700;color:var(--blue)">${pct}%</div><div style="font-size:11px;color:var(--text3)">Complete</div></div>
    </div>
    <div style="font-size:12px;font-weight:600;color:var(--text3);text-transform:uppercase;letter-spacing:0.4px;margin-bottom:8px">Recent Activity</div>
    <div style="max-height:200px;overflow-y:auto">${(st.history||[]).slice(0,10).map(h=>`<div style="display:flex;gap:10px;padding:8px 0;border-bottom:1px solid var(--border)"><span>${h.icon}</span><div><div style="font-size:12px;font-weight:500">${h.action}</div><div style="font-size:11px;color:var(--text3)">${h.detail}</div></div></div>`).join('')||'<div style="font-size:13px;color:var(--text3);padding:10px 0">No activity yet</div>'}</div>`;
  document.getElementById('studentDetailModal').classList.add('open');
}
function closeStudentModal(){document.getElementById('studentDetailModal').classList.remove('open');}
document.getElementById('studentDetailModal').addEventListener('click',e=>{if(e.target===e.currentTarget)closeStudentModal();});

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// TEACHER MESSAGES
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function renderTeacherMessages() {
  const {collection,query,where,getDocs,onSnapshot,doc,addDoc,orderBy,serverTimestamp}=fn();
  const el=document.getElementById('teacherMessagesContent');

  // Get all parents who have messaged
  const messagesRef=collection(db(),'messages');
  const q=query(messagesRef,where('teacherId','==',currentUser.uid),orderBy('createdAt','asc'));
  const snap=await getDocs(q);

  // Group by parent
  const threads={};
  snap.forEach(d=>{const m={id:d.id,...d.data()};const key=m.fromParent?m.senderId:m.recipientId;if(!threads[key]) threads[key]=[];threads[key].push(m);});

  if(!Object.keys(threads).length){
    el.innerHTML=`<div class="card"><div class="empty-state"><div class="empty-icon">üí¨</div><p>No messages yet from parents.</p></div></div>`;
    return;
  }

  const threadIds=Object.keys(threads);
  el.innerHTML='';

  for(const parentId of threadIds){
    const pSnap=await getDocs(query(collection(db(),'users'),where('uid','==',parentId)));
    const pName=pSnap.empty?'Parent':pSnap.docs[0].data().name;
    const msgs=threads[parentId];
    const div=document.createElement('div');
    div.className='card'; div.style.marginBottom='16px';
    div.innerHTML=`
      <div class="card-title">üí¨ ${pName}</div>
      <div class="message-thread" id="thread-${parentId}">
        ${msgs.map(m=>`<div class="message-bubble ${m.fromParent?'received':'sent'}">${m.text}<div class="message-meta">${new Date(m.createdAt?.toDate?m.createdAt.toDate():m.createdAt).toLocaleTimeString('en-GB',{hour:'2-digit',minute:'2-digit'})}</div></div>`).join('')}
      </div>
      <div class="message-compose">
        <input type="text" placeholder="Reply to ${pName}‚Ä¶" id="reply-${parentId}" onkeydown="if(event.key==='Enter')sendTeacherReply('${parentId}')">
        <button class="btn btn-primary btn-sm" style="width:auto;margin:0" onclick="sendTeacherReply('${parentId}')">Send</button>
      </div>`;
    el.appendChild(div);
  }
}

async function sendTeacherReply(parentId) {
  const input=document.getElementById('reply-'+parentId);
  const text=input.value.trim(); if(!text) return;
  const {collection,addDoc,serverTimestamp}=fn();
  await addDoc(collection(db(),'messages'),{
    teacherId:currentUser.uid,senderId:currentUser.uid,recipientId:parentId,
    text,fromParent:false,createdAt:serverTimestamp()
  });
  input.value='';
  renderTeacherMessages();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// TEACHER INVITE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function renderTeacherInvite() {
  // Re-fetch so enrolled students list is always current
  const {doc,getDoc}=fn();
  const freshSnap=await getDoc(doc(db(),'users',currentUser.uid));
  if(freshSnap.exists()) userProfile=freshSnap.data();
  const classLink=`${window.location.origin}${window.location.pathname}?invite=${userProfile.inviteToken}`;
  const el=document.getElementById('teacherInviteContent');
  const students=userProfile.students||[];
  el.innerHTML=`
    <div class="card" style="margin-bottom:16px">
      <div class="card-title">üîó Your Class Invite Link</div>
      <p style="font-size:13px;color:var(--text2);margin-bottom:12px">Share this link or code with students so they can join your class when signing up.</p>
      <div class="invite-box">
        <div style="font-size:12px;color:var(--text3);margin-bottom:4px">Class invite link:</div>
        <code class="invite-link">${classLink}</code>
        <div style="font-size:12px;color:var(--text3);margin:8px 0 4px">Or share just the code:</div>
        <code class="invite-link" style="font-size:14px;font-weight:700;letter-spacing:2px">${userProfile.inviteToken}</code>
        <div class="invite-actions">
          <button class="btn btn-sm btn-primary" style="width:auto;margin:0" onclick="navigator.clipboard.writeText('${classLink}').then(()=>showToast('üìã','Copied!','Share this with your students'))">üìã Copy Link</button>
          <button class="btn btn-sm btn-secondary" onclick="navigator.clipboard.writeText('${userProfile.inviteToken}').then(()=>showToast('üìã','Code copied!',''))">Copy Code Only</button>
        </div>
      </div>
    </div>
    <div class="card">
      <div class="card-title">üë• Enrolled Students (${students.length})</div>
      <div id="enrolledStudentsList"></div>
    </div>`;
  loadEnrolledStudents();
}

async function loadEnrolledStudents() {
  const el=document.getElementById('enrolledStudentsList');
  if(!el) return;
  const students=userProfile.students||[];
  if(!students.length){el.innerHTML='<div class="empty-state" style="padding:20px"><div class="empty-icon">üë•</div><p>No students enrolled yet.</p></div>';return;}
  const {doc,getDoc}=fn();
  let html='';
  for(const uid of students){
    const snap=await getDoc(doc(db(),'users',uid));
    if(!snap.exists()) continue;
    const p=snap.data();
    html+=`<div style="display:flex;align-items:center;gap:12px;padding:10px 0;border-bottom:1px solid var(--border)">
      <div class="student-avatar" style="width:34px;height:34px;font-size:13px">${(p.name||'S')[0]}</div>
      <div style="flex:1"><div style="font-size:13px;font-weight:600">${p.name}</div><div style="font-size:11px;color:var(--text3)">${p.email}</div></div>
    </div>`;
  }
  el.innerHTML=html;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// PARENT DASHBOARD
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function renderParentChildren() {
  const el=document.getElementById('parentChildrenContent');
  // Re-fetch so linkedChildren is always current
  const {doc,getDoc}=fn();
  const freshSnap=await getDoc(doc(db(),'users',currentUser.uid));
  if(freshSnap.exists()) userProfile=freshSnap.data();
  const children=userProfile.linkedChildren||[];
  if(!children.length){
    el.innerHTML=`<div class="card"><div class="empty-state"><div class="empty-icon">üë¶</div><p>No children linked yet. Go to "Link a Child" to connect to your child's account.</p></div></div>`;
    return;
  }
  el.innerHTML='<div class="children-grid" id="childrenGrid"></div>';
  const grid=document.getElementById('childrenGrid');
  const {doc,getDoc}=fn();
  for(const uid of children){
    const snap=await getDoc(doc(db(),'users',uid));
    if(!snap.exists()) continue;
    const p=snap.data();
    const stSnap=await getDoc(doc(db(),'users',uid,'data','state'));
    const st=stSnap.exists()?stSnap.data():freshState();
    const s=st.surahs||[];
    const m=s.filter(x=>x.status==='memorised').length;
    const mg=s.filter(x=>x.status==='memorising').length;
    const r=s.filter(x=>x.status==='revision').length;
    const pct=Math.round(m/114*100);
    const streak=calcStreakFromHeatmap(st.heatmap||{});
    const todayD=new Date(todayStr());
    const due=s.filter(x=>(x.status==='memorised'||x.status==='revision')&&(!x.lastRevised||(todayD-new Date(x.lastRevised))/86400000>=7));
    const div=document.createElement('div');
    div.className='child-card';
    div.innerHTML=`
      <div class="child-header">
        <div class="child-avatar">${(p.name||'S')[0]}</div>
        <div><div style="font-size:16px;font-weight:700">${p.name}</div><div style="font-size:12px;color:var(--text3)">${p.email}</div></div>
      </div>
      <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:14px">
        <div style="text-align:center;background:rgba(136,170,136,0.1);border-radius:8px;padding:10px"><div style="font-size:20px;font-weight:700;color:var(--green)">${m}</div><div style="font-size:10px;color:var(--text3)">Memorised</div></div>
        <div style="text-align:center;background:rgba(184,130,154,0.1);border-radius:8px;padding:10px"><div style="font-size:20px;font-weight:700;color:var(--teal)">${mg}</div><div style="font-size:10px;color:var(--text3)">Memorising</div></div>
        <div style="text-align:center;background:rgba(232,164,184,0.1);border-radius:8px;padding:10px"><div style="font-size:20px;font-weight:700;color:#e8a4b8">${streak}</div><div style="font-size:10px;color:var(--text3)">Day Streak</div></div>
      </div>
      <div style="margin-bottom:10px">
        <div style="display:flex;justify-content:space-between;font-size:12px;color:var(--text3);margin-bottom:4px"><span>Overall Progress</span><span>${pct}%</span></div>
        <div class="goal-bar"><div class="goal-bar-fill" style="width:${pct}%"></div></div>
      </div>
      ${due.length?`<div style="background:rgba(208,120,136,0.07);border:1px solid rgba(208,120,136,0.18);border-radius:8px;padding:10px;font-size:12px;color:var(--red)">‚ö†Ô∏è ${due.length} surah${due.length>1?'s':''} overdue for revision</div>`:'<div style="font-size:12px;color:var(--green)">‚úÖ All revisions up to date</div>'}`;
    grid.appendChild(div);
  }
}

function calcStreakFromHeatmap(heatmap){
  let streak=0; const today=new Date(todayStr());
  for(let i=0;i<365;i++){const d=new Date(today);d.setDate(d.getDate()-i);const ds=d.toISOString().slice(0,10);if(heatmap[ds]) streak++;else if(i>0) break;}
  return streak;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// PARENT MESSAGES
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function renderParentMessages() {
  const el=document.getElementById('parentMessagesContent');
  // Find teacher (via child's linkedTeacher)
  const children=userProfile.linkedChildren||[];
  let teacherId=null;
  if(children.length){
    const {doc,getDoc}=fn();
    const childSnap=await getDoc(doc(db(),'users',children[0]));
    if(childSnap.exists()) teacherId=childSnap.data().linkedTeacher;
  }

  if(!teacherId){
    el.innerHTML=`<div class="card"><div class="empty-state"><div class="empty-icon">üë©‚Äçüè´</div><p>No teacher linked yet. Link a child first to message their teacher.</p></div></div>`;
    return;
  }

  const {collection,query,where,getDocs,addDoc,serverTimestamp,orderBy}=fn();
  const q=query(collection(db(),'messages'),where('teacherId','==',teacherId),where('senderId','in',[currentUser.uid,teacherId]),orderBy('createdAt','asc'));
  const snap=await getDocs(q);
  const msgs=[];
  snap.forEach(d=>msgs.push({id:d.id,...d.data()}));
  const filtered=msgs.filter(m=>m.senderId===currentUser.uid||m.recipientId===currentUser.uid);

  el.innerHTML=`
    <div class="card">
      <div class="card-title">üí¨ Message to Teacher</div>
      <div class="message-thread" id="parentThread">
        ${filtered.map(m=>`<div class="message-bubble ${m.senderId===currentUser.uid?'sent':'received'}">${m.text}<div class="message-meta">${new Date(m.createdAt?.toDate?m.createdAt.toDate():m.createdAt).toLocaleTimeString('en-GB',{hour:'2-digit',minute:'2-digit'})}</div></div>`).join('')||'<div style="text-align:center;color:var(--text3);font-size:13px;padding:20px">No messages yet. Start the conversation!</div>'}
      </div>
      <div class="message-compose">
        <input type="text" placeholder="Type a message‚Ä¶" id="parentMsgInput" onkeydown="if(event.key==='Enter')sendParentMessage('${teacherId}')">
        <button class="btn btn-primary btn-sm" style="width:auto;margin:0" onclick="sendParentMessage('${teacherId}')">Send</button>
      </div>
    </div>`;
  // Scroll to bottom
  const thread=document.getElementById('parentThread');
  if(thread) setTimeout(()=>thread.scrollTop=thread.scrollHeight,100);
}

async function sendParentMessage(teacherId){
  const input=document.getElementById('parentMsgInput');
  const text=input.value.trim(); if(!text) return;
  const {collection,addDoc,serverTimestamp}=fn();
  await addDoc(collection(db(),'messages'),{
    teacherId,senderId:currentUser.uid,recipientId:teacherId,
    text,fromParent:true,createdAt:serverTimestamp()
  });
  input.value='';
  renderParentMessages();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// PARENT CONNECT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function renderParentConnect(){
  // Re-fetch so profile is current
  const {doc,getDoc}=fn();
  const freshSnap=await getDoc(doc(db(),'users',currentUser.uid));
  if(freshSnap.exists()) userProfile=freshSnap.data();
  const el=document.getElementById('parentConnectContent');
  const myLink=`${window.location.origin}${window.location.pathname}?invite=${userProfile.inviteToken}`;
  el.innerHTML=`
    <div class="card" style="margin-bottom:16px">
      <div class="card-title">Option 1 ‚Äî Share YOUR link with your child</div>
      <p style="font-size:13px;color:var(--text2);margin-bottom:12px">Your child opens this link while signed in to link themselves to your account.</p>
      <div class="invite-box">
        <code class="invite-link">${myLink}</code>
        <div class="invite-actions">
          <button class="btn btn-sm btn-primary" style="width:auto;margin:0" onclick="navigator.clipboard.writeText('${myLink}').then(()=>showToast('üìã','Copied!',''))">üìã Copy</button>
          <button class="btn btn-sm btn-secondary" onclick="shareInviteLink('${myLink}')">üì§ Share</button>
        </div>
      </div>
    </div>
    <div class="card">
      <div class="card-title">Option 2 ‚Äî Paste your child's invite link</div>
      <p style="font-size:13px;color:var(--text2);margin-bottom:12px">Ask your child to copy their invite link and paste it below.</p>
      <div style="display:flex;gap:10px">
        <input type="text" class="form-input" id="childLinkInput" placeholder="Paste child's invite link here‚Ä¶" style="flex:1">
        <button class="btn btn-primary" style="width:auto;margin:0" onclick="linkChildFromPaste()">Link</button>
      </div>
    </div>`;
}

async function linkChildFromPaste(){
  const val=document.getElementById('childLinkInput').value.trim();
  const match=val.match(/invite=([^&\s]+)/);
  if(!match){showToast('‚ùå','Invalid link','Please paste a valid invite link');return;}
  await handleInviteFromURL(match[1]);
  renderParentConnect();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SURAH VIEWER
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function openSurahViewer(num){
  const sd=SURAHS.find(s=>s.n===num); if(!sd) return;
  document.getElementById('svArabic').textContent=sd.ar;
  document.getElementById('svTranslit').textContent=SURAH_TRANSLIT[num]||sd.en;
  document.getElementById('svMeaning').textContent=SURAH_MEANING[num]?`"${SURAH_MEANING[num]}"`:'' ;
  const myS=userState.surahs.find(s=>s.n===num);
  document.getElementById('svChips').innerHTML=`<div class="sv-chip">Surah ${num}</div><div class="sv-chip">${sd.v} Ayahs</div><div class="sv-chip">Juz ${sd.juz}</div><div class="sv-chip">${SURAH_PLACE[num]||''}</div><div class="sv-chip">${STATUS_LABELS[myS?.status||'not-started']}</div>`;
  document.getElementById('svBismillah').style.display=num===9?'none':'block';
  verseMode='arabic';
  document.getElementById('btnArabicOnly').classList.add('active');
  document.getElementById('btnWithTrans').classList.remove('active');
  document.getElementById('svOverlay').classList.add('open');
  document.getElementById('svVerses').innerHTML=`<div class="sv-loading"><div class="sv-spinner"></div>Loading ${sd.en}‚Ä¶</div>`;
  try {
    if(verseCache[num]){renderVerses(verseCache[num]);return;}
    const [arRes,trRes]=await Promise.all([fetch(`https://api.alquran.cloud/v1/surah/${num}`),fetch(`https://api.alquran.cloud/v1/surah/${num}/en.sahih`)]);
    if(!arRes.ok) throw new Error();
    const arData=await arRes.json(); let tr=[];
    if(trRes.ok){const td=await trRes.json();tr=td.data.ayahs.map(a=>a.text);}
    verseCache[num]=arData.data.ayahs.map((a,i)=>({...a,translation:tr[i]||''}));
    renderVerses(verseCache[num]);
  } catch {
    document.getElementById('svVerses').innerHTML='<div class="sv-loading"><div style="font-size:32px;margin-bottom:12px">üåê</div><div>Internet connection required to load verses.</div></div>';
  }
}

function renderVerses(ayahs){
  document.getElementById('svVerses').innerHTML=ayahs.map(a=>`<div class="sv-verse"><div class="sv-verse-top"><div class="sv-vnum">${a.numberInSurah}</div><div class="sv-varabic">${a.text}</div></div>${a.translation?`<div class="sv-vtranslation ${verseMode==='translation'?'show':''}">${a.translation}</div>`:''}</div>`).join('');
}

function setVerseMode(mode){
  verseMode=mode;
  document.getElementById('btnArabicOnly').classList.toggle('active',mode==='arabic');
  document.getElementById('btnWithTrans').classList.toggle('active',mode==='translation');
  document.querySelectorAll('.sv-vtranslation').forEach(el=>el.classList.toggle('show',mode==='translation'));
}

function closeSurahViewer(){document.getElementById('svOverlay').classList.remove('open');}
document.getElementById('svOverlay').addEventListener('click',e=>{if(e.target===e.currentTarget)closeSurahViewer();});

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// HEADER DROPDOWN & THEME
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function toggleHeaderDropdown(){document.getElementById('headerDropdown').classList.toggle('open');}
function closeHeaderDropdown(){document.getElementById('headerDropdown').classList.remove('open');}
document.addEventListener('click',e=>{const wrap=document.querySelector('.header-dropdown-wrap');if(wrap&&!wrap.contains(e.target))closeHeaderDropdown();});

function toggleTheme(){
  const dark=document.body.classList.toggle('dark-mode');
  document.getElementById('themeKnob').textContent=dark?'‚òÄÔ∏è':'üåô';
  localStorage.setItem('qtTheme',dark?'dark':'light');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// TOAST
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function showToast(icon,title,desc){
  const t=document.createElement('div'); t.className='toast';
  t.innerHTML=`<div style="font-size:24px">${icon}</div><div><div style="font-size:14px;font-weight:600;color:var(--text)">${title}</div><div style="font-size:12px;color:var(--text3)">${desc}</div></div>`;
  document.body.appendChild(t);
  setTimeout(()=>t.classList.add('show'),30);
  setTimeout(()=>{t.classList.remove('show');setTimeout(()=>t.remove(),400);},3500);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// LOADING
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function hideLoading(){
  const el=document.getElementById('loadingOverlay');
  el.classList.add('hide');
  setTimeout(()=>el.style.display='none',400);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// INIT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
if(localStorage.getItem('qtTheme')==='dark'){
  document.body.classList.add('dark-mode');
  document.getElementById('themeKnob').textContent='‚òÄÔ∏è';
}

function startAuthListener() {
  // Show config error if Firebase failed to init
  if(window.__firebaseError || !window.__firebaseReady) {
    document.getElementById('loadingOverlay').style.display = 'none';
    document.getElementById('authScreen').classList.add('active');
    const errEl = document.getElementById('authError');
    errEl.textContent = window.__firebaseError
      ? '‚ö†Ô∏è Firebase config error: ' + window.__firebaseError + ' ‚Äî Please check your API keys in the HTML file.'
      : '‚ö†Ô∏è Firebase failed to load. Check your internet connection and config values.';
    errEl.classList.add('visible');
    return;
  }

  // Set a 10-second timeout fallback in case onAuthStateChanged never fires
  const timeout = setTimeout(() => {
    if(document.getElementById('loadingOverlay').style.display !== 'none' &&
       !document.getElementById('loadingOverlay').classList.contains('hide')) {
      hideLoading();
      document.getElementById('authScreen').classList.add('active');
      const errEl = document.getElementById('authError');
      errEl.textContent = '‚ö†Ô∏è Connection timed out. Check your Firebase config values and internet connection.';
      errEl.classList.add('visible');
    }
  }, 10000);

  fn().onAuthStateChanged(auth(), async user => {
    clearTimeout(timeout);
    if(user) {
      await initApp(user);
    } else {
      document.getElementById('authScreen').classList.add('active');
      document.getElementById('appScreen').classList.remove('active');
      hideLoading();
    }
  });
}

// Listen for firebaseReady event, with a polling fallback
// in case the event fired before this script ran
document.addEventListener('firebaseReady', startAuthListener);

// Fallback: if module already fired before listener was attached, poll for it
const _fbPoll = setInterval(() => {
  if(window.__firebaseReady !== undefined) {
    clearInterval(_fbPoll);
    // Only run if startAuthListener hasn't been triggered via event yet
    if(!window.__authListenerStarted) {
      window.__authListenerStarted = true;
      startAuthListener();
    }
  }
}, 100);

// Mark listener as started when event fires to avoid double-run
document.addEventListener('firebaseReady', () => { window.__authListenerStarted = true; });

// Keyboard listeners
document.addEventListener('keydown',e=>{
  if(e.key==='Escape'){
    closeSurahViewer();
    closeGoalModal();
    closeStudentModal();
  }
});
</script>
</body>
</html>
