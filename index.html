<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Quran Tracker</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Amiri:ital,wght@0,400;0,700;1,400&family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     FIREBASE CONFIG ‚Äî REPLACE THESE VALUES
     1. Go to console.firebase.google.com
     2. Create a project ‚Üí Add web app
     3. Copy your config values below
     ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged, sendPasswordResetEmail, GoogleAuthProvider, signInWithPopup }
  from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
import { getFirestore, doc, setDoc, getDoc, updateDoc, collection, getDocs, query, where, addDoc, onSnapshot, serverTimestamp, deleteDoc, orderBy, arrayUnion }
  from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// üîß REPLACE WITH YOUR FIREBASE CONFIG
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const firebaseConfig = {
  apiKey: "AIzaSyBCcxh41j0dkoUOAQ2CJB0mRkiSzStrxkw",
  authDomain: "quran-tracker-3c491.firebaseapp.com",
  projectId: "quran-tracker-3c491",
  storageBucket: "quran-tracker-3c491.firebasestorage.app",
  messagingSenderId: "822600976467",
  appId: "1:822600976467:web:257dd6497cf55dfb4c9ea6",
  measurementId: "G-TGTYNGWB4T"
};
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

try {
  const app  = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db   = getFirestore(app);

  window.__firebaseReady = true;
  window.__auth = auth;
  window.__db   = db;
  window.__firebaseFns = {
    createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut,
    onAuthStateChanged, sendPasswordResetEmail, GoogleAuthProvider, signInWithPopup,
    doc, setDoc, getDoc, updateDoc, collection, getDocs, query, where,
    addDoc, onSnapshot, serverTimestamp, deleteDoc, orderBy,
    arrayUnion  /* FIX #2: import arrayUnion properly */
  };
  document.dispatchEvent(new Event('firebaseReady'));
} catch(err) {
  window.__firebaseError = err.message;
  document.dispatchEvent(new Event('firebaseReady'));
}
</script>

<style>
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

:root {
  --bg: #f2f3f8;
  --surface: #eaecf4;
  --card: #ffffff;
  --border: #e6e9f4;
  --border2: #d0d4e4;
  --teal: #7366ff;
  --teal2: #5b4fdb;
  --gold: #f4a53a;
  --amber: #ff9f43;
  --blue: #2697f3;
  --red: #f73164;
  --green: #51bb25;
  --text: #2c323f;
  --text2: #6c757d;
  --text3: #98a2b3;
  --font: 'Outfit', sans-serif;
  --arabic: 'Amiri', serif;
  --radius: 20px;
  --shadow-sm: 0 1px 3px rgba(44,50,63,0.04), 0 1px 2px rgba(44,50,63,0.06);
  --shadow: 0 4px 6px rgba(44,50,63,0.04), 0 10px 24px rgba(44,50,63,0.06);
  --shadow-lg: 0 8px 16px rgba(44,50,63,0.04), 0 20px 48px rgba(44,50,63,0.08);
  --shadow-xl: 0 12px 28px rgba(44,50,63,0.06), 0 32px 64px rgba(44,50,63,0.1);
}

html { scroll-behavior: smooth; }
body { background: var(--bg); color: var(--text); font-family: var(--font); min-height: 100vh; overflow-x: hidden; -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; }

body::before {
  content: '';
  position: fixed; inset: 0; pointer-events: none; z-index: 0;
  background-image:
    radial-gradient(800px 500px at 15% 5%, rgba(115,102,255,0.06) 0%, transparent 70%),
    radial-gradient(600px 400px at 85% 80%, rgba(38,151,243,0.05) 0%, transparent 70%),
    radial-gradient(500px 350px at 50% 50%, rgba(244,165,58,0.03) 0%, transparent 70%);
}

/* ‚îÄ‚îÄ SCREENS ‚îÄ‚îÄ */
.screen { display: none !important; position: relative; z-index: 1; }
.screen.active { display: block !important; }
#authScreen.active { display: flex !important; }

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   AUTH SCREEN ‚Äî Premium Dark Glass
   ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
#authScreen {
  position: fixed; inset: 0; background: #09090b;
  display: flex; align-items: center; justify-content: center; padding: 20px;
  overflow-y: auto;
}

#authParticles { position: absolute; inset: 0; width: 100%; height: 100%; opacity: 0.4; mix-blend-mode: screen; pointer-events: none; }

#authScreen::before {
  content: ''; position: absolute; inset: 0; pointer-events: none;
  background: radial-gradient(80% 60% at 50% 30%, rgba(115,102,255,0.12), transparent 65%);
}

.auth-lines { position: absolute; inset: 0; pointer-events: none; opacity: 0.5; }
.auth-hline, .auth-vline { position: absolute; background: #1a1a2e; will-change: transform,opacity; }
.auth-hline { left:0; right:0; height:1px; transform:scaleX(0); transform-origin:50% 50%; animation: authDrawX 0.9s cubic-bezier(.22,.61,.36,1) forwards; }
.auth-vline { top:0; bottom:0; width:1px; transform:scaleY(0); transform-origin:50% 0%; animation: authDrawY 1s cubic-bezier(.22,.61,.36,1) forwards; }
.auth-hline:nth-child(1){top:20%;animation-delay:.1s} .auth-hline:nth-child(2){top:50%;animation-delay:.22s} .auth-hline:nth-child(3){top:80%;animation-delay:.34s}
.auth-vline:nth-child(4){left:22%;animation-delay:.44s} .auth-vline:nth-child(5){left:50%;animation-delay:.56s} .auth-vline:nth-child(6){left:78%;animation-delay:.68s}
@keyframes authDrawX{0%{transform:scaleX(0);opacity:0}60%{opacity:.9}100%{transform:scaleX(1);opacity:.5}}
@keyframes authDrawY{0%{transform:scaleY(0);opacity:0}60%{opacity:.9}100%{transform:scaleY(1);opacity:.5}}

.auth-topbar {
  position: absolute; top: 0; left: 0; right: 0;
  display: flex; align-items: center; justify-content: space-between;
  padding: 18px 32px; border-bottom: 1px solid rgba(255,255,255,0.04); z-index: 10;
}
.auth-topbar-brand { font-size: 12px; letter-spacing: 0.18em; text-transform: uppercase; color: rgba(255,255,255,0.25); font-weight: 600; }
.auth-topbar-arabic { font-family: var(--arabic); font-size: 14px; color: rgba(255,255,255,0.15); }

.auth-box {
  background: rgba(20,20,28,0.82); border: 1px solid rgba(255,255,255,0.07);
  border-radius: 28px; padding: 44px 38px; width: 100%; max-width: 440px;
  backdrop-filter: blur(40px) saturate(180%); -webkit-backdrop-filter: blur(40px) saturate(180%);
  position: relative; z-index: 5;
  animation: fadeUp 0.7s cubic-bezier(.22,.61,.36,1) 0.2s both;
  box-shadow: 0 0 0 1px rgba(255,255,255,0.03), 0 32px 80px rgba(0,0,0,0.5), 0 2px 4px rgba(0,0,0,0.3);
}

.auth-logo { text-align: center; margin-bottom: 32px; }
.auth-logo-icon {
  width: 64px; height: 64px; background: linear-gradient(135deg, #7366ff, #a78bfa);
  border-radius: 20px; display: flex; align-items: center; justify-content: center;
  font-size: 28px; margin: 0 auto 16px; box-shadow: 0 12px 40px rgba(115,102,255,0.4), 0 2px 8px rgba(115,102,255,0.2);
}
.auth-logo h1 { font-size: 24px; font-weight: 700; color: #fafafa; letter-spacing: -0.3px; }
.auth-logo p { font-family: var(--arabic); font-size: 14px; color: rgba(255,255,255,0.25); margin-top: 6px; }

.auth-tabs { display: flex; background: rgba(0,0,0,0.35); border-radius: 14px; padding: 4px; margin-bottom: 28px; border: 1px solid rgba(255,255,255,0.05); }
.auth-tab {
  flex: 1; padding: 10px; border: none; background: transparent; border-radius: 11px;
  font-family: var(--font); font-size: 13px; font-weight: 500; color: rgba(255,255,255,0.35); cursor: pointer; transition: all 0.25s;
}
.auth-tab.active { background: rgba(115,102,255,0.2); color: #fafafa; font-weight: 600; box-shadow: 0 2px 8px rgba(115,102,255,0.15); }

.auth-form { display: none; }
.auth-form.active { display: block; }

.form-group { margin-bottom: 16px; }
.form-label { font-size: 11px; color: rgba(255,255,255,0.4); font-weight: 600; display: block; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 0.8px; }

.auth-input-wrap { position: relative; }
.auth-input-icon { position: absolute; left: 14px; top: 50%; transform: translateY(-50%); font-size: 14px; color: rgba(255,255,255,0.2); pointer-events: none; }
.form-input {
  width: 100%; background: rgba(0,0,0,0.4); border: 1px solid rgba(255,255,255,0.08); border-radius: 14px;
  padding: 12px 16px; color: #fafafa; font-family: var(--font); font-size: 14px; outline: none;
  transition: border-color 0.3s, box-shadow 0.3s, background 0.3s;
}
.form-input.has-icon { padding-left: 42px; }
.form-input::placeholder { color: rgba(255,255,255,0.18); }
.form-input:focus { border-color: rgba(115,102,255,0.6); box-shadow: 0 0 0 4px rgba(115,102,255,0.12); background: rgba(0,0,0,0.5); }
.form-select {
  width: 100%; background: rgba(0,0,0,0.4); border: 1px solid rgba(255,255,255,0.08); border-radius: 14px;
  padding: 12px 16px; color: #fafafa; font-family: var(--font); font-size: 14px; outline: none;
  cursor: pointer; appearance: none; transition: border-color 0.3s;
  color-scheme: dark;
}
.form-select:focus { border-color: rgba(115,102,255,0.6); }

/* ‚îÄ‚îÄ BUTTONS ‚îÄ‚îÄ */
.btn { padding: 12px 24px; border: none; border-radius: 14px; font-family: var(--font); font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.25s cubic-bezier(.4,0,.2,1); position: relative; overflow: hidden; }
.btn-primary { background: linear-gradient(135deg, #7366ff, #8b7fff); color: #fff; width: 100%; margin-top: 8px; box-shadow: 0 4px 16px rgba(115,102,255,0.3); }
.btn-primary:hover { box-shadow: 0 8px 28px rgba(115,102,255,0.45); transform: translateY(-2px); filter: brightness(1.08); }
.btn-primary:active { transform: translateY(0); }
.btn-secondary { background: transparent; border: 1px solid var(--border2); color: var(--text2); }
.btn-secondary:hover { border-color: var(--teal); color: var(--teal); background: rgba(115,102,255,0.04); }
.btn-sm { padding: 8px 18px; font-size: 12px; border-radius: 10px; }
.btn-danger { background: rgba(247,49,100,0.08); color: var(--red); border: 1px solid rgba(247,49,100,0.15); }
.btn-danger:hover { background: rgba(247,49,100,0.14); border-color: rgba(247,49,100,0.3); }
.btn-green { background: rgba(81,187,37,0.1); color: var(--green); border: 1px solid rgba(81,187,37,0.2); }
.btn-green:hover { background: rgba(81,187,37,0.18); }

.auth-link { text-align: center; margin-top: 16px; font-size: 13px; color: rgba(255,255,255,0.3); }
.auth-link a { color: rgba(255,255,255,0.6); cursor: pointer; text-decoration: none; font-weight: 500; transition: color 0.2s; }
.auth-link a:hover { color: #a78bfa; }
.auth-error { background: rgba(247,49,100,0.1); border: 1px solid rgba(247,49,100,0.2); color: #ff6b8a; border-radius: 12px; padding: 12px 16px; font-size: 13px; margin-bottom: 16px; display: none; }
.auth-error.visible { display: block; animation: fadeUp 0.2s ease; }

.google-btn {
  width: 100%; padding: 12px 16px; border-radius: 14px; margin-top: 0;
  border: 1px solid rgba(255,255,255,0.08); background: rgba(255,255,255,0.04); cursor: pointer;
  font-family: var(--font); font-size: 14px; font-weight: 500; color: rgba(255,255,255,0.8);
  display: flex; align-items: center; justify-content: center; gap: 10px;
  transition: all 0.25s;
}
.google-btn:hover { border-color: rgba(255,255,255,0.18); background: rgba(255,255,255,0.08); transform: translateY(-1px); }
.google-btn img { width: 18px; height: 18px; }
.auth-divider { display: flex; align-items: center; gap: 12px; margin: 18px 0; }
.auth-divider::before, .auth-divider::after { content: ''; flex: 1; height: 1px; background: rgba(255,255,255,0.06); }
.auth-divider span { font-size: 11px; color: rgba(255,255,255,0.2); text-transform: uppercase; letter-spacing: 0.15em; }

.google-role-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.85); backdrop-filter: blur(12px); z-index: 2000; display: flex; align-items: center; justify-content: center; padding: 20px; }
.google-role-box { background: #14141c; border: 1px solid rgba(255,255,255,0.07); border-radius: 28px; padding: 38px; width: 100%; max-width: 460px; box-shadow: 0 32px 80px rgba(0,0,0,0.5); animation: fadeUp 0.3s ease both; color: #fafafa; }

.role-cards { display: grid; grid-template-columns: repeat(3,1fr); gap: 12px; margin: 16px 0; }
.role-card {
  border: 1px solid rgba(255,255,255,0.08); border-radius: 16px; padding: 20px 12px; text-align: center;
  cursor: pointer; transition: all 0.25s; background: rgba(255,255,255,0.02);
}
.role-card:hover { border-color: rgba(115,102,255,0.4); background: rgba(115,102,255,0.05); transform: translateY(-3px); }
.role-card.selected { border-color: rgba(115,102,255,0.7); background: rgba(115,102,255,0.1); box-shadow: 0 0 0 3px rgba(115,102,255,0.12), 0 8px 24px rgba(115,102,255,0.15); }
.role-card .role-emoji { font-size: 28px; margin-bottom: 8px; }
.role-card .role-name { font-size: 13px; font-weight: 600; color: #fafafa; }
.role-card .role-desc { font-size: 10px; color: rgba(255,255,255,0.3); margin-top: 3px; }

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   MAIN LAYOUT ‚Äî Maxton-Inspired Dashboard
   ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
#appScreen { min-height: 100vh; }

header {
  position: sticky; top: 0; z-index: 100;
  padding: 16px 44px; border-bottom: 1px solid var(--border);
  display: flex; align-items: center; justify-content: space-between;
  background: rgba(255,255,255,0.82); backdrop-filter: blur(20px) saturate(180%); -webkit-backdrop-filter: blur(20px) saturate(180%);
}
.header-left { display: flex; align-items: center; gap: 16px; }
.logo-icon { width: 44px; height: 44px; background: linear-gradient(135deg, #7366ff, #a78bfa); border-radius: 14px; display: flex; align-items: center; justify-content: center; font-size: 20px; box-shadow: 0 6px 20px rgba(115,102,255,0.25); transition: transform 0.3s, box-shadow 0.3s; }
.logo-icon:hover { transform: scale(1.05); box-shadow: 0 8px 28px rgba(115,102,255,0.35); }
.header-title h1 { font-size: 20px; font-weight: 700; color: var(--text); letter-spacing: -0.3px; }
.header-title p { font-size: 11px; color: var(--text3); font-family: var(--arabic); }

.header-right { display: flex; align-items: center; gap: 12px; }

.role-badge { padding: 6px 14px; border-radius: 24px; font-size: 11px; font-weight: 600; letter-spacing: 0.3px; }
.role-badge.teacher { background: linear-gradient(135deg, rgba(115,102,255,0.1), rgba(115,102,255,0.05)); color: #7366ff; border: 1px solid rgba(115,102,255,0.2); }
.role-badge.parent  { background: linear-gradient(135deg, rgba(81,187,37,0.1), rgba(81,187,37,0.05)); color: #51bb25; border: 1px solid rgba(81,187,37,0.2); }
.role-badge.student { background: linear-gradient(135deg, rgba(38,151,243,0.1), rgba(38,151,243,0.05)); color: #2697f3; border: 1px solid rgba(38,151,243,0.2); }

.user-menu-btn { display: flex; align-items: center; gap: 10px; padding: 8px 16px 8px 10px; background: #fff; border: 1px solid var(--border); border-radius: 50px; cursor: pointer; transition: all 0.25s; box-shadow: var(--shadow-sm); }
.user-menu-btn:hover { border-color: var(--teal); box-shadow: var(--shadow), 0 0 0 3px rgba(115,102,255,0.06); transform: translateY(-1px); }
.user-avatar { width: 30px; height: 30px; border-radius: 50%; background: linear-gradient(135deg, #7366ff, #a78bfa); display: flex; align-items: center; justify-content: center; font-size: 13px; color: #fff; font-weight: 700; }
.user-name { font-size: 13px; font-weight: 600; max-width: 100px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }

.header-dropdown-wrap { position: relative; }
.header-dropdown {
  position: absolute; top: calc(100% + 10px); right: 0; background: #fff;
  border: 1px solid var(--border); border-radius: 18px; box-shadow: var(--shadow-xl);
  min-width: 220px; z-index: 200; overflow: hidden; display: none;
}
.header-dropdown.open { display: block; animation: fadeUp 0.2s ease both; }
.hd-item { padding: 13px 18px; font-size: 13px; color: var(--text2); cursor: pointer; transition: all 0.15s; display: flex; align-items: center; gap: 10px; }
.hd-item:hover { background: rgba(115,102,255,0.04); color: var(--teal); }
.hd-item.danger { color: var(--red); }
.hd-item.danger:hover { background: rgba(247,49,100,0.04); }
.hd-divider { height: 1px; background: var(--border); }

.theme-toggle { width: 48px; height: 26px; border-radius: 13px; border: none; background: var(--surface); cursor: pointer; position: relative; transition: background 0.3s; padding: 3px; display: flex; align-items: center; box-shadow: inset 0 1px 3px rgba(0,0,0,0.08); }
body.dark-mode .theme-toggle { background: #2a2040; justify-content: flex-end; }
.tt-knob { width: 20px; height: 20px; border-radius: 50%; background: #fff; display: flex; align-items: center; justify-content: center; font-size: 11px; box-shadow: 0 2px 6px rgba(0,0,0,0.15); transition: all 0.3s cubic-bezier(.4,0,.2,1); }

/* ‚îÄ‚îÄ NAV ‚îÄ‚îÄ */
nav { display: flex; gap: 4px; padding: 14px 44px; border-bottom: 1px solid var(--border); background: rgba(255,255,255,0.72); backdrop-filter: blur(16px); -webkit-backdrop-filter: blur(16px); overflow-x: auto; position: sticky; top: 77px; z-index: 90; }
.tab-btn { padding: 10px 20px; border-radius: 12px; border: 1px solid transparent; background: transparent; color: var(--text3); font-family: var(--font); font-size: 13px; font-weight: 500; cursor: pointer; transition: all 0.25s; white-space: nowrap; display: flex; align-items: center; gap: 7px; }
.tab-btn:hover { color: var(--text); background: rgba(115,102,255,0.04); }
.tab-btn.active { background: linear-gradient(135deg, #7366ff, #8b7fff); border-color: transparent; color: #fff; font-weight: 600; box-shadow: 0 4px 16px rgba(115,102,255,0.3); }
.tab-btn .badge-count { background: rgba(255,255,255,0.3); border-radius: 10px; padding: 1px 7px; font-size: 11px; }

/* ‚îÄ‚îÄ MAIN ‚îÄ‚îÄ */
main { max-width: 1440px; margin: 0 auto; padding: 36px 44px; position: relative; z-index: 1; }
.tab-section { display: none; }
.tab-section.active { display: block; animation: fadeUp 0.3s ease both; }

/* ‚îÄ‚îÄ CARDS ‚Äî Maxton-style ‚îÄ‚îÄ */
.card { background: #fff; border-radius: var(--radius); padding: 28px; box-shadow: var(--shadow); border: 1px solid rgba(0,0,0,0.04); transition: box-shadow 0.3s, transform 0.3s; }
.card:hover { box-shadow: var(--shadow-lg); }
.card-title { font-size: 14px; font-weight: 700; color: var(--text); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 20px; display: flex; align-items: center; gap: 10px; }

/* ‚îÄ‚îÄ KPI GRID ‚Äî Premium Dashboard Cards ‚îÄ‚îÄ */
.kpi-grid { display: grid; grid-template-columns: repeat(auto-fit,minmax(180px,1fr)); gap: 20px; margin-bottom: 28px; }
.kpi-card { background: #fff; border-radius: var(--radius); padding: 24px; position: relative; overflow: hidden; box-shadow: var(--shadow); border: 1px solid rgba(0,0,0,0.04); transition: all 0.3s cubic-bezier(.4,0,.2,1); animation: fadeUp 0.4s ease both; }
.kpi-card:hover { transform: translateY(-4px); box-shadow: var(--shadow-lg); }
.kpi-card::before { content:''; position:absolute; top:0; left:0; right:0; height:4px; border-radius: var(--radius) var(--radius) 0 0; }
.kpi-card.c1::before { background: linear-gradient(90deg, #7366ff, #a78bfa); }
.kpi-card.c2::before { background: linear-gradient(90deg, #51bb25, #7dd356); }
.kpi-card.c3::before { background: linear-gradient(90deg, #2697f3, #58b4f6); }
.kpi-card.c4::before { background: linear-gradient(90deg, #f4a53a, #f7be6d); }
.kpi-card.c5::before { background: linear-gradient(90deg, #f73164, #ff6b8a); }
.kpi-icon { width: 40px; height: 40px; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 16px; margin-bottom: 14px; }
.kpi-card.c1 .kpi-icon { background: linear-gradient(135deg, rgba(115,102,255,0.12), rgba(115,102,255,0.06)); }
.kpi-card.c2 .kpi-icon { background: linear-gradient(135deg, rgba(81,187,37,0.12), rgba(81,187,37,0.06)); }
.kpi-card.c3 .kpi-icon { background: linear-gradient(135deg, rgba(38,151,243,0.12), rgba(38,151,243,0.06)); }
.kpi-card.c4 .kpi-icon { background: linear-gradient(135deg, rgba(244,165,58,0.12), rgba(244,165,58,0.06)); }
.kpi-card.c5 .kpi-icon { background: linear-gradient(135deg, rgba(247,49,100,0.12), rgba(247,49,100,0.06)); }
.kpi-value { font-size: 36px; font-weight: 800; letter-spacing: -1.5px; }
.kpi-card.c1 .kpi-value { color: #7366ff; } .kpi-card.c2 .kpi-value { color: #51bb25; }
.kpi-card.c3 .kpi-value { color: #2697f3; } .kpi-card.c4 .kpi-value { color: #f4a53a; }
.kpi-card.c5 .kpi-value { color: #f73164; }
.kpi-label { font-size: 11px; color: var(--text3); font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; margin-top: 4px; }
.kpi-bar { margin-top: 14px; height: 4px; background: var(--surface); border-radius: 2px; overflow: hidden; }
.kpi-bar-fill { height: 100%; background: linear-gradient(90deg, #7366ff, #2697f3); border-radius: 2px; transition: width 1s cubic-bezier(.4,0,.2,1); }

/* ‚îÄ‚îÄ TABLE ‚Äî Premium Data Grid ‚îÄ‚îÄ */
.table-controls { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; align-items: center; }
.search-box { flex: 1; min-width: 200px; background: #fff; border: 1px solid var(--border); border-radius: 14px; box-shadow: var(--shadow-sm); padding: 11px 16px; color: var(--text); font-family: var(--font); font-size: 14px; outline: none; transition: all 0.25s; }
.search-box:focus { border-color: #7366ff; box-shadow: 0 0 0 4px rgba(115,102,255,0.08); }
.filter-btn { padding: 10px 16px; border-radius: 12px; border: 1px solid var(--border); background: #fff; box-shadow: var(--shadow-sm); color: var(--text3); font-family: var(--font); font-size: 12px; font-weight: 600; cursor: pointer; transition: all 0.25s; white-space: nowrap; }
.filter-btn:hover { border-color: var(--teal); color: var(--teal); }
.filter-btn.active-filter { background: linear-gradient(135deg, #7366ff, #8b7fff); border-color: transparent; color: #fff; box-shadow: 0 4px 12px rgba(115,102,255,0.25); }
.table-wrap { background: #fff; border-radius: var(--radius); overflow: hidden; box-shadow: var(--shadow); border: 1px solid rgba(0,0,0,0.04); }
table { width: 100%; border-collapse: collapse; }
thead { background: linear-gradient(180deg, #f8f9fc, #f2f3f8); border-bottom: 2px solid var(--border); }
th { padding: 14px 16px; text-align: left; font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.6px; color: var(--text3); }
tbody tr { border-bottom: 1px solid rgba(0,0,0,0.04); transition: all 0.2s; }
tbody tr:last-child { border-bottom: none; }
tbody tr:hover { background: rgba(115,102,255,0.02); }
td { padding: 14px 16px; font-size: 13px; color: var(--text); vertical-align: middle; }
.surah-num { width: 32px; height: 32px; background: var(--surface); border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 11px; font-weight: 700; color: var(--text3); }
.arabic-col { font-family: var(--arabic); font-size: 18px; color: #7366ff; }
.status-badge { display: inline-flex; align-items: center; gap: 5px; padding: 6px 14px; border-radius: 24px; font-size: 11px; font-weight: 600; cursor: pointer; border: none; font-family: var(--font); transition: all 0.2s; }
.status-badge:hover { filter: brightness(1.06); transform: scale(1.04); }
.status-badge.memorised  { background: rgba(81,187,37,0.1); color: #51bb25; border: 1px solid rgba(81,187,37,0.2); }
.status-badge.memorising { background: rgba(38,151,243,0.1); color: #2697f3; border: 1px solid rgba(38,151,243,0.2); }
.status-badge.revision   { background: rgba(244,165,58,0.1); color: #d4891a; border: 1px solid rgba(244,165,58,0.2); }
.status-badge.not-started{ background: var(--surface); color: var(--text3); border: 1px solid var(--border); }
.star-rating { display: flex; gap: 2px; }
.star { font-size: 15px; cursor: pointer; color: #dce0ec; transition: all 0.15s; }
.star.filled { color: #f4a53a; filter: drop-shadow(0 1px 2px rgba(244,165,58,0.3)); }
.star:hover { transform: scale(1.2); }
.notes-input { background: transparent; border: none; color: var(--text2); font-family: var(--font); font-size: 12px; outline: none; width: 100%; padding: 4px 8px; border-radius: 8px; transition: all 0.2s; }
.notes-input:focus { background: var(--surface); box-shadow: inset 0 1px 3px rgba(0,0,0,0.06); }
.date-input { background: transparent; border: 1px solid transparent; color: var(--text2); font-family: var(--font); font-size: 12px; padding: 4px 8px; border-radius: 8px; outline: none; transition: all 0.2s; }
.date-input:hover,.date-input:focus { border-color: var(--border2); background: var(--surface); }
.surah-name-btn { background: transparent; border: none; color: var(--text); font-family: var(--font); font-size: 13px; font-weight: 600; cursor: pointer; text-decoration: none; transition: color 0.2s; position: relative; }
.surah-name-btn::after { content:''; position: absolute; bottom: -1px; left: 0; right: 0; height: 1px; background: var(--teal); transform: scaleX(0); transition: transform 0.25s; }
.surah-name-btn:hover { color: #7366ff; }
.surah-name-btn:hover::after { transform: scaleX(1); }

/* ‚îÄ‚îÄ CHARTS ‚îÄ‚îÄ */
.charts-grid { display: grid; grid-template-columns: 360px 1fr; gap: 24px; margin-bottom: 28px; }
.chart-wrap { position: relative; height: 260px; display: flex; align-items: center; justify-content: center; }
.donut-center { position: absolute; text-align: center; pointer-events: none; }
.donut-center .big { font-size: 34px; font-weight: 800; color: var(--teal); letter-spacing: -1px; }
.donut-center .small { font-size: 10px; color: var(--text3); text-transform: uppercase; font-weight: 600; letter-spacing: 0.5px; }
.donut-legend { margin-top: 20px; display: flex; flex-direction: column; gap: 10px; }
.legend-item { display: flex; align-items: center; gap: 10px; font-size: 13px; color: var(--text2); font-weight: 500; }
.legend-dot { width: 10px; height: 10px; border-radius: 50%; flex-shrink: 0; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }

/* ‚îÄ‚îÄ HEATMAP ‚îÄ‚îÄ */
.heatmap-wrap { background: #fff; border-radius: var(--radius); padding: 28px; overflow-x: auto; box-shadow: var(--shadow); border: 1px solid rgba(0,0,0,0.04); margin-bottom: 24px; }
.heatmap-months { display: flex; margin-bottom: 8px; padding-left: 28px; }
.month-label { font-size: 10px; color: var(--text3); text-transform: uppercase; font-weight: 600; letter-spacing: 0.3px; }
.heatmap-body { display: flex; }
.day-labels { display: flex; flex-direction: column; gap: 3px; margin-right: 5px; padding-top: 2px; }
.day-label { height: 13px; font-size: 9px; color: var(--text3); line-height: 13px; font-weight: 500; }
.heatmap-cols { display: flex; gap: 3px; }
.heatmap-col { display: flex; flex-direction: column; gap: 3px; }
.heatmap-cell { width: 13px; height: 13px; border-radius: 3px; background: #eef0f8; cursor: pointer; transition: all 0.15s; }
.heatmap-cell:hover { transform: scale(1.4); border-radius: 4px; }
.heatmap-cell.l1 { background: rgba(115,102,255,0.15); }
.heatmap-cell.l2 { background: rgba(115,102,255,0.35); }
.heatmap-cell.l3 { background: rgba(115,102,255,0.6); }
.heatmap-cell.l4 { background: rgba(115,102,255,0.9); }
.heatmap-cell.today { outline: 2px solid var(--gold); outline-offset: 1px; border-radius: 3px; }

/* ‚îÄ‚îÄ GOALS ‚îÄ‚îÄ */
.goals-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
.goal-card { background: #fff; border-radius: var(--radius); padding: 26px; box-shadow: var(--shadow); border: 1px solid rgba(0,0,0,0.04); transition: all 0.3s; }
.goal-card:hover { box-shadow: var(--shadow-lg); transform: translateY(-2px); }
.goal-nums { display: flex; align-items: baseline; gap: 6px; margin: 14px 0 8px; }
.goal-current { font-size: 42px; font-weight: 800; color: var(--teal); letter-spacing: -2px; }
.goal-sep { font-size: 22px; color: var(--text3); }
.goal-target { font-size: 22px; font-weight: 600; color: var(--text2); }
.goal-bar { height: 8px; background: var(--surface); border-radius: 4px; overflow: hidden; margin: 12px 0 10px; }
.goal-bar-fill { height: 100%; background: linear-gradient(90deg, #7366ff, #2697f3); border-radius: 4px; transition: width 1s cubic-bezier(.4,0,.2,1); }

/* ‚îÄ‚îÄ BADGES ‚îÄ‚îÄ */
.badges-grid { display: grid; grid-template-columns: repeat(auto-fill,minmax(165px,1fr)); gap: 14px; }
.badge-card { background: #fff; border-radius: 18px; padding: 20px; text-align: center; box-shadow: var(--shadow-sm); border: 1px solid rgba(0,0,0,0.04); transition: all 0.3s; position: relative; }
.badge-card.earned { background: linear-gradient(145deg, rgba(115,102,255,0.04), #fff); box-shadow: var(--shadow); border-color: rgba(115,102,255,0.1); }
.badge-card.earned:hover { transform: translateY(-4px); box-shadow: var(--shadow-lg); }
.badge-card.locked { opacity: 0.35; filter: grayscale(0.9); }
.badge-emoji { font-size: 32px; display: block; margin-bottom: 10px; }
.badge-name { font-size: 13px; font-weight: 700; margin-bottom: 4px; color: var(--text); }
.badge-desc { font-size: 11px; color: var(--text3); line-height: 1.5; }
.badge-earned-tag { position: absolute; top: 10px; right: 10px; font-size: 9px; color: #7366ff; font-weight: 700; background: rgba(115,102,255,0.08); padding: 2px 8px; border-radius: 6px; }

/* ‚îÄ‚îÄ TEACHER DASHBOARD ‚îÄ‚îÄ */
.class-overview-grid { display: grid; grid-template-columns: repeat(auto-fill,minmax(260px,1fr)); gap: 18px; margin-bottom: 24px; }
.student-card { background: #fff; border-radius: var(--radius); padding: 22px; box-shadow: var(--shadow-sm); border: 1px solid rgba(0,0,0,0.04); cursor: pointer; transition: all 0.3s cubic-bezier(.4,0,.2,1); }
.student-card:hover { transform: translateY(-4px); border-color: rgba(115,102,255,0.2); box-shadow: var(--shadow-lg); }
.student-card-header { display: flex; align-items: center; gap: 14px; margin-bottom: 14px; }
.student-avatar { width: 44px; height: 44px; border-radius: 50%; background: linear-gradient(135deg, #7366ff, #a78bfa); display: flex; align-items: center; justify-content: center; font-size: 17px; color: #fff; font-weight: 700; flex-shrink: 0; box-shadow: 0 4px 12px rgba(115,102,255,0.25); }
.student-name { font-size: 15px; font-weight: 700; }
.student-email { font-size: 11px; color: var(--text3); }
.student-mini-stats { display: flex; gap: 8px; margin-bottom: 12px; flex-wrap: wrap; }
.mini-stat { font-size: 11px; padding: 4px 10px; border-radius: 10px; font-weight: 600; }
.mini-stat.m { background: rgba(81,187,37,0.1); color: #51bb25; }
.mini-stat.mg { background: rgba(38,151,243,0.1); color: #2697f3; }
.mini-stat.r { background: rgba(244,165,58,0.1); color: #d4891a; }
.student-progress-bar { height: 6px; background: var(--surface); border-radius: 3px; overflow: hidden; }
.student-progress-fill { height: 100%; background: linear-gradient(90deg, #51bb25, #7dd356); border-radius: 3px; transition: width 0.8s cubic-bezier(.4,0,.2,1); }
.revised-today-dot { width: 10px; height: 10px; border-radius: 50%; flex-shrink: 0; }
.revised-today-dot.yes { background: #51bb25; box-shadow: 0 0 0 3px rgba(81,187,37,0.15); }
.revised-today-dot.no  { background: #f73164; box-shadow: 0 0 0 3px rgba(247,49,100,0.1); }

.alert-card { background: rgba(247,49,100,0.04); border: 1px solid rgba(247,49,100,0.12); border-radius: 14px; padding: 16px 18px; display: flex; align-items: center; justify-content: space-between; transition: all 0.2s; }
.alert-card:hover { background: rgba(247,49,100,0.06); }
.alert-info { display: flex; flex-direction: column; gap: 3px; }
.alert-name { font-size: 13px; font-weight: 700; }
.alert-detail { font-size: 12px; color: var(--text3); }
.alert-days { font-size: 12px; color: var(--red); font-weight: 700; }

.message-thread { display: flex; flex-direction: column; gap: 12px; max-height: 400px; overflow-y: auto; padding-right: 4px; }
.message-bubble { max-width: 75%; padding: 14px 18px; border-radius: 18px; font-size: 13px; line-height: 1.6; }
.message-bubble.sent { align-self: flex-end; background: linear-gradient(135deg, #7366ff, #8b7fff); color: #fff; border-bottom-right-radius: 6px; box-shadow: 0 4px 12px rgba(115,102,255,0.2); }
.message-bubble.received { align-self: flex-start; background: #f8f9fc; border: 1px solid var(--border); border-bottom-left-radius: 6px; }
.message-meta { font-size: 10px; opacity: 0.6; margin-top: 5px; }
.message-compose { display: flex; gap: 10px; margin-top: 18px; }
.message-compose input { flex: 1; background: var(--surface); border: 1px solid var(--border); border-radius: 14px; padding: 12px 16px; font-family: var(--font); font-size: 13px; outline: none; color: var(--text); transition: all 0.25s; }
.message-compose input:focus { border-color: #7366ff; box-shadow: 0 0 0 3px rgba(115,102,255,0.08); background: #fff; }

.children-grid { display: grid; grid-template-columns: repeat(auto-fill,minmax(320px,1fr)); gap: 20px; }
.child-card { background: #fff; border-radius: var(--radius); padding: 26px; box-shadow: var(--shadow); border: 1px solid rgba(0,0,0,0.04); }
.child-header { display: flex; align-items: center; gap: 16px; margin-bottom: 18px; }
.child-avatar { width: 52px; height: 52px; border-radius: 50%; background: linear-gradient(135deg, #7366ff, #a78bfa); display: flex; align-items: center; justify-content: center; font-size: 22px; color: #fff; font-weight: 700; box-shadow: 0 6px 16px rgba(115,102,255,0.25); }

.invite-box { background: linear-gradient(135deg, rgba(115,102,255,0.04), rgba(38,151,243,0.03)); border: 1px solid rgba(115,102,255,0.12); border-radius: 16px; padding: 20px; margin-top: 18px; }
.invite-link { font-family: 'SF Mono', 'Fira Code', monospace; font-size: 12px; color: var(--text2); background: #fff; border: 1px solid var(--border); border-radius: 10px; padding: 11px 14px; word-break: break-all; margin: 10px 0; display: block; box-shadow: inset 0 1px 3px rgba(0,0,0,0.04); }
.invite-actions { display: flex; gap: 10px; flex-wrap: wrap; }

.modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.6); backdrop-filter: blur(12px); z-index: 500; display: flex; align-items: center; justify-content: center; opacity: 0; pointer-events: none; transition: opacity 0.25s; padding: 20px; }
.modal-overlay.open { opacity: 1; pointer-events: all; }
.modal { background: #fff; border-radius: 24px; padding: 36px; width: 460px; max-width: 96vw; transform: translateY(20px) scale(0.97); transition: all 0.3s cubic-bezier(.34,1.56,.64,1); box-shadow: var(--shadow-xl); }
.modal-overlay.open .modal { transform: translateY(0) scale(1); }
.modal-title { font-size: 20px; font-weight: 700; margin-bottom: 24px; letter-spacing: -0.3px; }
.modal-label { font-size: 11px; color: var(--text3); text-transform: uppercase; letter-spacing: 0.5px; font-weight: 600; display: block; margin-bottom: 8px; }
.modal-input { width: 100%; background: var(--surface); border: 1px solid var(--border); border-radius: 12px; padding: 12px 15px; font-family: var(--font); font-size: 14px; color: var(--text); outline: none; margin-bottom: 16px; transition: all 0.25s; }
.modal-input:focus { border-color: #7366ff; box-shadow: 0 0 0 3px rgba(115,102,255,0.08); background: #fff; }
.modal-actions { display: flex; gap: 10px; justify-content: flex-end; margin-top: 24px; }

/* ‚îÄ‚îÄ SURAH VIEWER ‚îÄ‚îÄ */
.sv-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.75); backdrop-filter: blur(16px); z-index: 600; display: flex; align-items: center; justify-content: center; opacity: 0; pointer-events: none; transition: opacity 0.3s; padding: 20px; }
.sv-overlay.open { opacity: 1; pointer-events: all; }
.sv-modal { background: #fff; border-radius: 28px; width: 720px; max-width: 96vw; max-height: 86vh; display: flex; flex-direction: column; transform: translateY(24px) scale(0.96); transition: transform 0.35s cubic-bezier(0.34,1.56,0.64,1); overflow: hidden; box-shadow: 0 48px 140px rgba(0,0,0,0.35); }
.sv-overlay.open .sv-modal { transform: translateY(0) scale(1); }
.sv-banner { background: linear-gradient(160deg, #f0edf8, #eae5f4, #f5f2fa); border-bottom: 1px solid rgba(115,102,255,0.1); padding: 32px 32px 26px; text-align: center; position: relative; flex-shrink: 0; }
.sv-close { position: absolute; top: 16px; right: 16px; width: 34px; height: 34px; border-radius: 50%; border: 1px solid rgba(115,102,255,0.15); background: rgba(115,102,255,0.05); color: rgba(44,50,63,0.4); font-size: 13px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s; }
.sv-close:hover { background: rgba(115,102,255,0.1); color: var(--teal); }
.sv-arabic { font-family: var(--arabic); font-size: 48px; color: var(--text); line-height: 1.3; margin-bottom: 8px; }
.sv-translit { font-size: 18px; font-weight: 700; color: #7366ff; margin-bottom: 4px; }
.sv-meaning { font-size: 12px; color: var(--text3); margin-bottom: 18px; }
.sv-chips { display: flex; gap: 8px; flex-wrap: wrap; justify-content: center; }
.sv-chip { padding: 5px 14px; border-radius: 24px; background: rgba(115,102,255,0.06); border: 1px solid rgba(115,102,255,0.12); font-size: 11px; color: var(--text2); font-weight: 500; }
.sv-controls { display: flex; align-items: center; justify-content: space-between; padding: 14px 28px; border-bottom: 1px solid var(--border); background: #fafbfe; flex-shrink: 0; }
.sv-ctrl-title { font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.6px; color: var(--text3); }
.sv-ctrl-btns { display: flex; gap: 6px; }
.sv-ctrl-btn { padding: 6px 16px; border-radius: 10px; border: 1px solid var(--border); background: transparent; color: var(--text3); font-family: var(--font); font-size: 11px; font-weight: 500; cursor: pointer; transition: all 0.2s; }
.sv-ctrl-btn:hover { border-color: rgba(115,102,255,0.3); color: var(--teal); }
.sv-ctrl-btn.active { background: linear-gradient(135deg, #7366ff, #8b7fff); border-color: transparent; color: #fff; font-weight: 600; box-shadow: 0 2px 8px rgba(115,102,255,0.2); }
.sv-body { overflow-y: auto; flex: 1; background: #fafbfe; }
.sv-bismillah { font-family: var(--arabic); font-size: 30px; text-align: center; color: var(--text); padding: 32px; border-bottom: 1px solid var(--border); background: rgba(115,102,255,0.02); line-height: 1.9; }
.sv-verse { display: flex; flex-direction: column; padding: 20px 32px; border-bottom: 1px solid rgba(0,0,0,0.04); transition: background 0.2s; }
.sv-verse:hover { background: rgba(115,102,255,0.02); }
.sv-verse-top { display: flex; gap: 16px; align-items: flex-start; }
.sv-vnum { width: 30px; height: 30px; border-radius: 50%; border: 1px solid var(--border); background: var(--surface); display: flex; align-items: center; justify-content: center; font-size: 10px; font-weight: 700; color: var(--text3); flex-shrink: 0; margin-top: 10px; }
.sv-varabic { font-family: var(--arabic); font-size: 26px; line-height: 2.1; direction: rtl; text-align: right; color: var(--text); flex: 1; }
.sv-vtranslation { font-size: 13px; line-height: 1.8; color: var(--text3); padding: 12px 0 4px 46px; font-style: italic; display: none; }
.sv-vtranslation.show { display: block; }
.sv-loading { text-align: center; padding: 56px; color: var(--text3); font-size: 13px; }
.sv-spinner { width: 30px; height: 30px; border: 2px solid var(--border); border-top-color: #7366ff; border-radius: 50%; animation: spin 0.8s linear infinite; margin: 0 auto 16px; }

/* ‚îÄ‚îÄ HISTORY ‚îÄ‚îÄ */
.history-list { display: flex; flex-direction: column; gap: 10px; }
.history-item { display: flex; align-items: flex-start; gap: 14px; padding: 16px 20px; background: #fff; border-radius: 16px; box-shadow: var(--shadow-sm); border: 1px solid rgba(0,0,0,0.04); animation: fadeUp 0.3s ease both; transition: all 0.2s; }
.history-item:hover { box-shadow: var(--shadow); }
.history-icon { width: 38px; height: 38px; border-radius: 12px; background: linear-gradient(135deg, rgba(115,102,255,0.08), rgba(115,102,255,0.04)); display: flex; align-items: center; justify-content: center; font-size: 16px; flex-shrink: 0; }
.history-content { flex: 1; }
.history-action { font-size: 13px; font-weight: 600; }
.history-detail { font-size: 12px; color: var(--text3); margin-top: 3px; }
.history-time { font-size: 10px; color: var(--text3); white-space: nowrap; font-weight: 500; }

.due-item { display: flex; align-items: center; justify-content: space-between; padding: 14px 18px; background: rgba(247,49,100,0.04); border: 1px solid rgba(247,49,100,0.1); border-radius: 14px; transition: all 0.2s; }
.due-item:hover { background: rgba(247,49,100,0.06); }
.due-item + .due-item { margin-top: 10px; }

.juz-bar { background: #fff; border-radius: 16px; padding: 18px 22px; box-shadow: var(--shadow-sm); border: 1px solid rgba(0,0,0,0.04); margin-bottom: 14px; transition: all 0.2s; }
.juz-bar:hover { box-shadow: var(--shadow); }

.compare-wrap { background: #fff; border-radius: var(--radius); padding: 28px; box-shadow: var(--shadow); border: 1px solid rgba(0,0,0,0.04); margin-bottom: 24px; }

.notif-badge { display: inline-block; background: var(--red); color: #fff; border-radius: 10px; font-size: 10px; font-weight: 700; padding: 2px 7px; min-width: 18px; text-align: center; margin-left: 4px; }

/* ‚îÄ‚îÄ LOADING ‚îÄ‚îÄ */
#loadingOverlay { position: fixed; inset: 0; background: var(--bg); z-index: 9999; display: flex; align-items: center; justify-content: center; flex-direction: column; gap: 16px; transition: opacity 0.4s; }
#loadingOverlay.hide { opacity: 0; pointer-events: none; }
.loader { display: flex; align-items: center; justify-content: center; flex-direction: row; }
.slider { overflow: hidden; background-color: #fff; margin: 0 15px; height: 80px; width: 20px; border-radius: 30px; box-shadow: 8px 8px 16px rgba(44,50,63,0.08), -8px -8px 16px #fff, inset -3px -3px 8px rgba(115,102,255,0.06), inset 3px 3px 8px rgba(0,0,0,0.04); position: relative; }
.slider::before { content: ""; position: absolute; top: 0; left: 0; height: 20px; width: 20px; border-radius: 100%; box-shadow: inset 0px 0px 0px rgba(0,0,0,0.3), 0px 420px 0 400px #7366ff, inset 0px 0px 0px rgba(0,0,0,0.1); animation: animate_2 2.5s ease-in-out infinite; animation-delay: calc(-0.5s * var(--i)); }
@keyframes animate_2 { 0% { transform: translateY(250px); filter: hue-rotate(0deg); } 50% { transform: translateY(0); } 100% { transform: translateY(250px); filter: hue-rotate(40deg); } }

.empty-state { text-align: center; padding: 56px 20px; color: var(--text3); }
.empty-state .empty-icon { font-size: 44px; margin-bottom: 14px; }
.empty-state p { font-size: 14px; }

.pill-tabs { display: flex; gap: 8px; margin-bottom: 24px; flex-wrap: wrap; }
.pill-tab { padding: 9px 20px; border-radius: 24px; border: 1px solid var(--border); background: #fff; color: var(--text3); font-family: var(--font); font-size: 12px; font-weight: 600; cursor: pointer; transition: all 0.25s; box-shadow: var(--shadow-sm); }
.pill-tab:hover { border-color: var(--teal); color: var(--teal); }
.pill-tab.active { background: linear-gradient(135deg, #7366ff, #8b7fff); border-color: transparent; color: #fff; box-shadow: 0 4px 12px rgba(115,102,255,0.25); }

.toast { position: fixed; bottom: 28px; left: 50%; transform: translateX(-50%) translateY(80px); background: #fff; border: 1px solid var(--border); border-radius: 18px; padding: 16px 24px; display: flex; align-items: center; gap: 14px; box-shadow: var(--shadow-xl); z-index: 9000; transition: transform 0.4s cubic-bezier(0.34,1.56,0.64,1), opacity 0.4s; opacity: 0; min-width: 280px; }
.toast.show { transform: translateX(-50%) translateY(0); opacity: 1; }

/* ‚îÄ‚îÄ RESPONSIVE ‚îÄ‚îÄ */
@media (max-width: 900px) {
  header, nav, main { padding-left: 20px; padding-right: 20px; }
  .charts-grid { grid-template-columns: 1fr; }
  .goals-grid { grid-template-columns: 1fr; }
  .role-cards { grid-template-columns: 1fr 1fr; }
}
@media (max-width: 600px) {
  .role-cards { grid-template-columns: 1fr; }
  nav { top: 69px; }
}

/* ‚îÄ‚îÄ ANIMATIONS ‚îÄ‚îÄ */
@keyframes fadeUp { from { opacity:0; transform:translateY(16px); } to { opacity:1; transform:translateY(0); } }
@keyframes spin { to { transform:rotate(360deg); } }

/* ‚îÄ‚îÄ SCROLLBAR ‚îÄ‚îÄ */
::-webkit-scrollbar { width: 6px; height: 6px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { background: var(--border2); border-radius: 3px; }
::-webkit-scrollbar-thumb:hover { background: var(--text3); }

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   DARK MODE ‚Äî Premium Dark Theme
   ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
body.dark-mode {
  --bg: #0d0f1a; --surface: #161929; --card: #1a1d2e; --border: #252840; --border2: #353860;
  --teal: #a78bfa; --teal2: #8b6fef; --gold: #f4a53a; --amber: #ff9f43; --blue: #58b4f6;
  --red: #ff6b8a; --green: #7dd356; --text: #e8eaf0; --text2: #9ca3b8; --text3: #5a6078;
  --shadow-sm: 0 1px 3px rgba(0,0,0,0.2); --shadow: 0 4px 12px rgba(0,0,0,0.25); --shadow-lg: 0 8px 24px rgba(0,0,0,0.35); --shadow-xl: 0 12px 40px rgba(0,0,0,0.4);
}
body.dark-mode header, body.dark-mode nav { background: rgba(13,15,26,0.92) !important; border-bottom-color: var(--border) !important; }
body.dark-mode .card, body.dark-mode .kpi-card, body.dark-mode .chart-card,
body.dark-mode .table-wrap, body.dark-mode .heatmap-wrap, body.dark-mode .goal-card,
body.dark-mode .badge-card, body.dark-mode .juz-bar, body.dark-mode .student-card,
body.dark-mode .child-card, body.dark-mode .history-item, body.dark-mode .compare-wrap { background: var(--card) !important; border: 1px solid var(--border) !important; }
body.dark-mode thead { background: #1f2236 !important; }
body.dark-mode .auth-box, body.dark-mode .modal { background: var(--card) !important; }
body.dark-mode .form-input, body.dark-mode .form-select, body.dark-mode .modal-input,
body.dark-mode .search-box { background: var(--bg) !important; border-color: var(--border) !important; color: var(--text) !important; }
body.dark-mode .auth-tabs { background: var(--bg) !important; }
body.dark-mode .auth-tab.active { background: rgba(167,139,250,0.15) !important; color: var(--text) !important; }
body.dark-mode .tab-btn.active { background: linear-gradient(135deg, #7366ff, #8b7fff) !important; color: #fff !important; }
body.dark-mode .star { color: var(--border) !important; }
body.dark-mode .star.filled { color: #f4a53a !important; }
body.dark-mode .filter-btn { background: var(--card) !important; border-color: var(--border) !important; }
body.dark-mode .filter-btn.active-filter { background: linear-gradient(135deg, #7366ff, #8b7fff) !important; border-color: transparent !important; color: #fff !important; }
body.dark-mode .btn-primary { background: linear-gradient(135deg, #7366ff, #8b7fff) !important; color: #fff !important; }
body.dark-mode .message-bubble.received { background: var(--surface) !important; border-color: var(--border) !important; }
body.dark-mode .heatmap-cell { background: var(--border) !important; }
body.dark-mode .heatmap-cell.l1 { background: rgba(167,139,250,0.2) !important; }
body.dark-mode .heatmap-cell.l2 { background: rgba(167,139,250,0.4) !important; }
body.dark-mode .heatmap-cell.l3 { background: rgba(167,139,250,0.65) !important; }
body.dark-mode .heatmap-cell.l4 { background: rgba(167,139,250,0.9) !important; }
body.dark-mode .sv-banner { background: linear-gradient(160deg, #161929, #1a1d30, #1e2138) !important; }
body.dark-mode .sv-modal, body.dark-mode .sv-body { background: #12141f !important; }
body.dark-mode .sv-arabic, body.dark-mode .sv-bismillah { color: var(--text) !important; }
body.dark-mode #loadingOverlay { background: var(--bg) !important; }
body.dark-mode .slider { background-color: var(--card) !important; box-shadow: 8px 8px 16px rgba(0,0,0,0.3), -8px -8px 16px rgba(26,29,46,0.5), inset -3px -3px 8px rgba(167,139,250,0.06), inset 3px 3px 8px rgba(0,0,0,0.15) !important; }
body.dark-mode .user-menu-btn { background: var(--card) !important; border-color: var(--border) !important; }
body.dark-mode .header-dropdown { background: var(--card) !important; border-color: var(--border) !important; }
body.dark-mode .message-compose input { background: var(--bg) !important; border-color: var(--border) !important; color: var(--text) !important; }
body.dark-mode .invite-box { background: rgba(167,139,250,0.04) !important; border-color: rgba(167,139,250,0.12) !important; }
body.dark-mode .invite-link { background: var(--bg) !important; border-color: var(--border) !important; color: var(--text2) !important; }
body.dark-mode .pill-tab { border-color: var(--border) !important; background: var(--card) !important; }
body.dark-mode .pill-tab.active { background: linear-gradient(135deg, #7366ff, #8b7fff) !important; border-color: transparent !important; color: #fff !important; }
body.dark-mode .role-card { border-color: var(--border) !important; }
body.dark-mode .role-card.selected { border-color: rgba(167,139,250,0.5) !important; background: rgba(167,139,250,0.08) !important; }
body.dark-mode .google-btn { background: rgba(0,0,0,0.3) !important; border-color: rgba(255,255,255,0.08) !important; color: #fafafa !important; }
body.dark-mode .google-role-box { background: #14141c !important; }
#authScreen .form-input, #authScreen .form-select { background: rgba(0,0,0,0.4) !important; border-color: rgba(255,255,255,0.08) !important; color: #fafafa !important; }
body.dark-mode .arabic-col { color: #a78bfa !important; }
body.dark-mode .date-input { color-scheme: dark; }
body.dark-mode .notes-input:focus { background: var(--border) !important; }
body.dark-mode .surah-num { background: var(--surface) !important; }
body.dark-mode tbody tr:hover { background: rgba(167,139,250,0.03) !important; }
</style>
</head>
<body>

<!-- Loading -->
<div id="loadingOverlay">
  <div style="text-align:center">
    <div style="font-size:36px;margin-bottom:24px">‚ò™Ô∏è</div>
    <section class="loader">
      <div class="slider" style="--i:0"></div>
      <div class="slider" style="--i:1"></div>
      <div class="slider" style="--i:2"></div>
      <div class="slider" style="--i:3"></div>
      <div class="slider" style="--i:4"></div>
    </section>
    <div style="font-size:13px;color:var(--text3);margin-top:24px">Loading Quran Tracker‚Ä¶</div>
  </div>
</div>

<!-- AUTH SCREEN -->
<div id="authScreen" class="screen">
  <canvas id="authParticles"></canvas>
  <div style="position:absolute;inset:0;pointer-events:none;background:radial-gradient(80% 60% at 50% 30%,rgba(115,102,255,0.1),transparent 65%)"></div>
  <div class="auth-lines">
    <div class="auth-hline"></div><div class="auth-hline"></div><div class="auth-hline"></div>
    <div class="auth-vline"></div><div class="auth-vline"></div><div class="auth-vline"></div>
  </div>
  <div class="auth-topbar">
    <span class="auth-topbar-brand">Quran Tracker</span>
    <span class="auth-topbar-arabic">ÿ®Ÿêÿ≥ŸíŸÖŸê ÿßŸÑŸÑŸéŸëŸáŸê ÿßŸÑÿ±ŸéŸëÿ≠ŸíŸÖŸéŸÜŸê ÿßŸÑÿ±ŸéŸëÿ≠ŸêŸäŸÖŸê</span>
  </div>
  <div class="auth-box">
    <div class="auth-logo">
      <div class="auth-logo-icon">‚ò™Ô∏è</div>
      <h1>Welcome back</h1>
      <p>Sign in to continue your journey</p>
    </div>
    <div id="authError" class="auth-error"></div>
    <div class="auth-tabs">
      <button class="auth-tab active" onclick="switchAuthTab('login')">Sign In</button>
      <button class="auth-tab" onclick="switchAuthTab('signup')">Create Account</button>
    </div>
    <!-- Login -->
    <div id="loginForm" class="auth-form active">
      <div class="form-group">
        <label class="form-label">Email</label>
        <div class="auth-input-wrap">
          <span class="auth-input-icon">‚úâ</span>
          <input type="email" class="form-input has-icon" id="loginEmail" placeholder="you@example.com" autocomplete="email">
        </div>
      </div>
      <div class="form-group">
        <label class="form-label">Password</label>
        <div class="auth-input-wrap">
          <span class="auth-input-icon">üîí</span>
          <input type="password" class="form-input has-icon" id="loginPassword" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="current-password" style="padding-right:42px">
          <button type="button" id="togglePw" onclick="togglePasswordVisibility()" style="position:absolute;right:10px;top:50%;transform:translateY(-50%);background:none;border:none;cursor:pointer;color:#52525b;font-size:13px;padding:4px">üëÅ</button>
        </div>
      </div>
      <div style="display:flex;align-items:center;justify-content:flex-end;margin-bottom:14px">
        <a onclick="handleForgotPassword()" style="font-size:12px;color:#71717a;cursor:pointer;text-decoration:underline">Forgot password?</a>
      </div>
      <button class="btn btn-primary" onclick="handleLogin()" style="border-radius:10px;padding:11px">Continue ‚Üí</button>
      <div class="auth-divider"><span>or</span></div>
      <button class="google-btn" onclick="handleGoogleSignIn()">
        <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" alt="Google">
        Continue with Google
      </button>
      <div class="auth-link" style="margin-top:20px">Don't have an account? <a onclick="switchAuthTab('signup')">Create one</a></div>
    </div>
    <!-- Signup -->
    <div id="signupForm" class="auth-form">
      <div class="form-group">
        <label class="form-label">Full Name</label>
        <div class="auth-input-wrap">
          <span class="auth-input-icon">üë§</span>
          <input type="text" class="form-input has-icon" id="signupName" placeholder="Your name">
        </div>
      </div>
      <div class="form-group">
        <label class="form-label">Email</label>
        <div class="auth-input-wrap">
          <span class="auth-input-icon">‚úâ</span>
          <input type="email" class="form-input has-icon" id="signupEmail" placeholder="you@example.com" autocomplete="email">
        </div>
      </div>
      <div class="form-group">
        <label class="form-label">Password</label>
        <div class="auth-input-wrap">
          <span class="auth-input-icon">üîí</span>
          <input type="password" class="form-input has-icon" id="signupPassword" placeholder="Min. 6 characters" autocomplete="new-password">
        </div>
      </div>
      <div class="form-group">
        <label class="form-label">I am a‚Ä¶</label>
        <div class="role-cards" id="roleCards">
          <div class="role-card selected" data-role="student" onclick="selectRole('student',this)">
            <div class="role-emoji">üßë‚Äçüéì</div><div class="role-name">Student</div><div class="role-desc">Track my memorisation</div>
          </div>
          <div class="role-card" data-role="parent" onclick="selectRole('parent',this)">
            <div class="role-emoji">üë®‚Äçüë©‚Äçüëß</div><div class="role-name">Parent</div><div class="role-desc">Monitor my child</div>
          </div>
          <div class="role-card" data-role="teacher" onclick="selectRole('teacher',this)">
            <div class="role-emoji">üë©‚Äçüè´</div><div class="role-name">Teacher</div><div class="role-desc">Manage the class</div>
          </div>
        </div>
      </div>
      <div class="form-group" id="classCodeGroup">
        <label class="form-label">Class Code (optional)</label>
        <input type="text" class="form-input" id="classCode" placeholder="Enter teacher's class code‚Ä¶">
      </div>
      <button class="btn btn-primary" onclick="handleSignup()" style="border-radius:10px;padding:11px">Create Account ‚Üí</button>
      <div class="auth-divider"><span>or</span></div>
      <button class="google-btn" onclick="handleGoogleSignIn()">
        <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" alt="Google">
        Continue with Google
      </button>
      <div class="auth-link" style="margin-top:20px">Already have an account? <a onclick="switchAuthTab('login')">Sign in</a></div>
    </div>
  </div>
</div>

<!-- Google Role Picker -->
<div id="googleRoleOverlay" style="display:none" class="google-role-overlay">
  <div class="google-role-box">
    <div style="text-align:center;margin-bottom:24px">
      <div style="font-size:28px;margin-bottom:8px">üëã</div>
      <div style="font-size:18px;font-weight:700;margin-bottom:4px">Welcome!</div>
      <div style="font-size:13px;color:var(--text3)">One last step ‚Äî what is your role?</div>
    </div>
    <div id="authError2" class="auth-error"></div>
    <div class="role-cards" id="googleRoleCards">
      <div class="role-card selected" data-role="student" onclick="selectGoogleRole('student',this)">
        <div class="role-emoji">üßë‚Äçüéì</div><div class="role-name">Student</div><div class="role-desc">Track my memorisation</div>
      </div>
      <div class="role-card" data-role="parent" onclick="selectGoogleRole('parent',this)">
        <div class="role-emoji">üë®‚Äçüë©‚Äçüëß</div><div class="role-name">Parent</div><div class="role-desc">Monitor my child</div>
      </div>
      <div class="role-card" data-role="teacher" onclick="selectGoogleRole('teacher',this)">
        <div class="role-emoji">üë©‚Äçüè´</div><div class="role-name">Teacher</div><div class="role-desc">Manage the class</div>
      </div>
    </div>
    <div id="googleClassCodeGroup" style="margin-top:14px">
      <label class="form-label">Class Code (optional)</label>
      <input type="text" class="form-input" id="googleClassCode" placeholder="Enter teacher's class code‚Ä¶">
    </div>
    <button class="btn btn-primary" style="margin-top:16px" onclick="confirmGoogleRole()">Continue ‚Üí</button>
  </div>
</div>

<!-- MAIN APP SCREEN -->
<div id="appScreen" class="screen">
  <header>
    <div class="header-left">
      <div class="logo-icon">‚ò™Ô∏è</div>
      <div class="header-title"><h1>Quran Tracker</h1><p>ÿ®Ÿêÿ≥ŸíŸÖŸê ÿßŸÑŸÑŸéŸëŸáŸê ÿßŸÑÿ±ŸéŸëÿ≠ŸíŸÖŸéŸÜŸê ÿßŸÑÿ±ŸéŸëÿ≠ŸêŸäŸÖŸê</p></div>
    </div>
    <div class="header-right">
      <div id="roleBadge" class="role-badge"></div>
      <div class="header-dropdown-wrap">
        <div class="user-menu-btn" onclick="toggleHeaderDropdown()">
          <div class="user-avatar" id="headerAvatar"></div>
          <div class="user-name" id="headerName"></div>
          <span style="font-size:10px;color:var(--text3)">‚ñæ</span>
        </div>
        <div class="header-dropdown" id="headerDropdown">
          <div class="hd-item" onclick="copyInviteLink()">üîó Copy My Invite Link</div>
          <div class="hd-divider"></div>
          <div class="hd-item" onclick="handleForgotPassword()">üîë Reset Password</div>
          <div class="hd-divider"></div>
          <div class="hd-item danger" onclick="handleSignOut()">üö™ Sign Out</div>
        </div>
      </div>
      <button class="theme-toggle" onclick="toggleTheme()"><span class="tt-knob" id="themeKnob">üåô</span></button>
    </div>
  </header>
  <nav id="mainNav"></nav>
  <main>
    <div id="tab-overview" class="tab-section">
      <div class="kpi-grid" id="kpiGrid"></div>
      <div id="badgesSectionOverview" class="badges-grid" style="margin-bottom:24px"></div>
      <div class="charts-grid">
        <div class="card">
          <div class="card-title">üç© Status Breakdown</div>
          <div class="chart-wrap"><canvas id="donutChart"></canvas><div class="donut-center"><div class="big" id="donutNum">0</div><div class="small">of 114</div></div></div>
          <div class="donut-legend">
            <div class="legend-item"><div class="legend-dot" style="background:var(--green)"></div>Memorised</div>
            <div class="legend-item"><div class="legend-dot" style="background:var(--blue)"></div>Memorising</div>
            <div class="legend-item"><div class="legend-dot" style="background:var(--amber)"></div>Revision</div>
            <div class="legend-item"><div class="legend-dot" style="background:var(--border2)"></div>Not Started</div>
          </div>
        </div>
        <div class="card"><div class="card-title">üìä Progress by Juz</div><div class="chart-wrap" style="height:280px"><canvas id="juzChart"></canvas></div></div>
      </div>
    </div>
    <div id="tab-surahs" class="tab-section">
      <div class="table-controls">
        <input type="text" class="search-box" id="searchInput" placeholder="üîç  Search surah‚Ä¶" oninput="filterTable()">
        <button class="filter-btn active-filter" onclick="setFilter('all',this)">All</button>
        <button class="filter-btn" onclick="setFilter('memorised',this)">‚úÖ Memorised</button>
        <button class="filter-btn" onclick="setFilter('memorising',this)">üìù Memorising</button>
        <button class="filter-btn" onclick="setFilter('revision',this)">üîÑ Revision</button>
        <button class="filter-btn" onclick="setFilter('not-started',this)">‚¨ú Not Started</button>
      </div>
      <div class="table-wrap">
        <table><thead><tr><th>#</th><th>Surah</th><th>Arabic</th><th>Juz</th><th>Verses</th><th>Status</th><th>Last Revised</th><th>Confidence</th><th>Notes</th></tr></thead><tbody id="surahTableBody"></tbody></table>
      </div>
    </div>
    <div id="tab-juz" class="tab-section">
      <div style="margin-bottom:18px"><h2 style="font-size:19px;font-weight:600;margin-bottom:4px">Progress by Juz</h2><p style="color:var(--text3);font-size:13px">30 sections of the Quran</p></div>
      <div id="juzBarsContainer"></div>
    </div>
    <div id="tab-heatmap" class="tab-section">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:20px;flex-wrap:wrap;gap:10px">
        <h2 style="font-size:19px;font-weight:600">Revision Calendar</h2>
        <button class="btn btn-primary" style="width:auto;margin:0" onclick="logTodayRevision()">‚úÖ Log Today's Revision</button>
      </div>
      <div class="heatmap-wrap">
        <div class="heatmap-months" id="heatmapMonths"></div>
        <div class="heatmap-body">
          <div class="day-labels"><div class="day-label"></div><div class="day-label">Mon</div><div class="day-label"></div><div class="day-label">Wed</div><div class="day-label"></div><div class="day-label">Fri</div><div class="day-label"></div></div>
          <div class="heatmap-cols" id="heatmapCols"></div>
        </div>
        <div style="display:flex;align-items:center;gap:5px;font-size:10px;color:var(--text3);margin-top:12px">
          Less
          <div style="width:12px;height:12px;border-radius:3px;background:var(--border)"></div>
          <div style="width:12px;height:12px;border-radius:3px;background:rgba(115,102,255,0.15)"></div>
          <div style="width:12px;height:12px;border-radius:3px;background:rgba(115,102,255,0.35)"></div>
          <div style="width:12px;height:12px;border-radius:3px;background:rgba(115,102,255,0.6)"></div>
          <div style="width:12px;height:12px;border-radius:3px;background:rgba(115,102,255,0.9)"></div>
          More
        </div>
      </div>
      <div class="card"><div class="card-title">‚ö†Ô∏è Due for Revision (7+ days)</div><div id="dueList"></div></div>
    </div>
    <div id="tab-goals" class="tab-section">
      <div style="margin-bottom:20px"><h2 style="font-size:19px;font-weight:600;margin-bottom:4px">Your Goals</h2><p style="color:var(--text3);font-size:13px">Set targets and track your journey</p></div>
      <div class="goals-grid" id="goalsGrid"></div>
    </div>
    <div id="tab-history" class="tab-section">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:20px;flex-wrap:wrap;gap:10px">
        <div><h2 style="font-size:19px;font-weight:600;margin-bottom:3px">Activity History</h2><p style="color:var(--text3);font-size:13px">Every change you've made</p></div>
        <button class="btn btn-sm btn-danger" onclick="clearHistory()">üóë Clear History</button>
      </div>
      <div id="historyList" class="history-list"></div>
    </div>
    <div id="tab-connect" class="tab-section">
      <div style="margin-bottom:20px"><h2 style="font-size:19px;font-weight:600;margin-bottom:4px">Connect with Family</h2><p style="color:var(--text3);font-size:13px">Share your progress with parents or link a child's account</p></div>
      <div id="connectContent"></div>
    </div>
    <!-- Teacher Tabs -->
    <div id="tab-teacher-overview" class="tab-section">
      <div style="margin-bottom:20px"><h2 style="font-size:19px;font-weight:600;margin-bottom:4px">Class Overview</h2><p style="color:var(--text3);font-size:13px">All students at a glance</p></div>
      <div class="pill-tabs">
        <button class="pill-tab active" onclick="setTeacherSubTab('students',this)">üë• Students</button>
        <button class="pill-tab" onclick="setTeacherSubTab('alerts',this)">‚ö†Ô∏è Alerts</button>
        <button class="pill-tab" onclick="setTeacherSubTab('compare',this)">üìä Compare</button>
      </div>
      <div id="teacherStudentsPane">
        <div id="revisedTodayBar" style="margin-bottom:16px;padding:14px 18px;background:#fff;border-radius:14px;box-shadow:0 2px 8px rgba(44,50,63,0.06);display:flex;align-items:center;gap:16px;flex-wrap:wrap"></div>
        <div class="class-overview-grid" id="classOverviewGrid"></div>
      </div>
      <div id="teacherAlertsPane" style="display:none"><div id="alertsList"></div></div>
      <div id="teacherComparePane" style="display:none"><div class="compare-wrap"><div class="card-title">üìä Memorisation Comparison</div><div style="height:320px"><canvas id="compareChart"></canvas></div></div></div>
    </div>
    <div id="tab-teacher-messages" class="tab-section">
      <div style="margin-bottom:20px"><h2 style="font-size:19px;font-weight:600;margin-bottom:4px">Messages from Parents</h2><p style="color:var(--text3);font-size:13px">Direct communication with families</p></div>
      <div id="teacherMessagesContent"></div>
    </div>
    <div id="tab-teacher-invite" class="tab-section">
      <div style="margin-bottom:20px"><h2 style="font-size:19px;font-weight:600;margin-bottom:4px">Invite & Manage</h2><p style="color:var(--text3);font-size:13px">Invite students and manage the class</p></div>
      <div id="teacherInviteContent"></div>
    </div>
    <!-- Parent Tabs -->
    <div id="tab-parent-children" class="tab-section">
      <div style="margin-bottom:20px"><h2 style="font-size:19px;font-weight:600;margin-bottom:4px">My Children</h2><p style="color:var(--text3);font-size:13px">Monitor your children's Quran progress</p></div>
      <div id="parentChildrenContent"></div>
    </div>
    <div id="tab-parent-messages" class="tab-section">
      <div style="margin-bottom:20px"><h2 style="font-size:19px;font-weight:600;margin-bottom:4px">Message Teacher</h2><p style="color:var(--text3);font-size:13px">Send notes or questions to the class teacher</p></div>
      <div id="parentMessagesContent"></div>
    </div>
    <div id="tab-parent-connect" class="tab-section">
      <div style="margin-bottom:20px"><h2 style="font-size:19px;font-weight:600;margin-bottom:4px">Link a Child</h2><p style="color:var(--text3);font-size:13px">Connect to your child's account</p></div>
      <div id="parentConnectContent"></div>
    </div>
  </main>
</div>

<!-- Surah Viewer Modal -->
<div class="sv-overlay" id="svOverlay">
  <div class="sv-modal">
    <div class="sv-banner">
      <button class="sv-close" onclick="closeSurahViewer()">‚úï</button>
      <div class="sv-arabic" id="svArabic"></div>
      <div class="sv-translit" id="svTranslit"></div>
      <div class="sv-meaning" id="svMeaning"></div>
      <div class="sv-chips" id="svChips"></div>
    </div>
    <div class="sv-controls">
      <div class="sv-ctrl-title">Verses</div>
      <div class="sv-ctrl-btns">
        <button class="sv-ctrl-btn active" id="btnArabicOnly" onclick="setVerseMode('arabic')">Arabic</button>
        <button class="sv-ctrl-btn" id="btnWithTrans" onclick="setVerseMode('translation')">+ Translation</button>
      </div>
    </div>
    <div class="sv-body">
      <div class="sv-bismillah" id="svBismillah">ÿ®Ÿêÿ≥ŸíŸÖŸê ÿßŸÑŸÑŸéŸëŸáŸê ÿßŸÑÿ±ŸéŸëÿ≠ŸíŸÖŸéŸÜŸê ÿßŸÑÿ±ŸéŸëÿ≠ŸêŸäŸÖŸê</div>
      <div id="svVerses"></div>
    </div>
  </div>
</div>

<!-- Goal Edit Modal -->
<div class="modal-overlay" id="goalModal">
  <div class="modal">
    <div class="modal-title">Edit Goal</div>
    <label class="modal-label">Title</label>
    <input type="text" class="modal-input" id="goalTitle">
    <label class="modal-label">Target (surahs)</label>
    <input type="number" class="modal-input" id="goalTarget" min="1" max="114">
    <label class="modal-label">Deadline</label>
    <input type="date" class="modal-input" id="goalDeadline">
    <div class="modal-actions">
      <button class="btn btn-secondary" onclick="closeGoalModal()">Cancel</button>
      <button class="btn btn-primary" style="width:auto;margin:0" onclick="saveGoal()">Save</button>
    </div>
  </div>
</div>

<!-- Student Detail Modal -->
<div class="modal-overlay" id="studentDetailModal">
  <div class="modal" style="width:560px">
    <div class="modal-title" id="sdmTitle">Student Progress</div>
    <div id="sdmContent"></div>
    <div class="modal-actions"><button class="btn btn-secondary" onclick="closeStudentModal()">Close</button></div>
  </div>
</div>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SANITIZATION HELPER ‚Äî FIX #8 (XSS)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function esc(str) {
  if (!str) return '';
  const div = document.createElement('div');
  div.textContent = String(str);
  return div.innerHTML;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// LOCAL DATE HELPER ‚Äî FIX #13 (timezone)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function todayStr() {
  const d = new Date();
  return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
}
function localDateStr(date) {
  return `${date.getFullYear()}-${String(date.getMonth()+1).padStart(2,'0')}-${String(date.getDate()).padStart(2,'0')}`;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// DATA CONSTANTS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const SURAHS=[
  {n:114,en:"An-Nas",ar:"ÿßŸÑŸÜÿßÿ≥",juz:30,v:6},{n:113,en:"Al-Falaq",ar:"ÿßŸÑŸÅŸÑŸÇ",juz:30,v:5},
  {n:112,en:"Al-Ikhlas",ar:"ÿßŸÑÿ•ÿÆŸÑÿßÿµ",juz:30,v:4},{n:111,en:"Al-Masad",ar:"ÿßŸÑŸÖÿ≥ÿØ",juz:30,v:5},
  {n:110,en:"An-Nasr",ar:"ÿßŸÑŸÜÿµÿ±",juz:30,v:3},{n:109,en:"Al-Kafirun",ar:"ÿßŸÑŸÉÿßŸÅÿ±ŸàŸÜ",juz:30,v:6},
  {n:108,en:"Al-Kawthar",ar:"ÿßŸÑŸÉŸàÿ´ÿ±",juz:30,v:3},{n:107,en:"Al-Ma'un",ar:"ÿßŸÑŸÖÿßÿπŸàŸÜ",juz:30,v:7},
  {n:106,en:"Quraysh",ar:"ŸÇÿ±Ÿäÿ¥",juz:30,v:4},{n:105,en:"Al-Fil",ar:"ÿßŸÑŸÅŸäŸÑ",juz:30,v:5},
  {n:104,en:"Al-Humazah",ar:"ÿßŸÑŸáŸÖÿ≤ÿ©",juz:30,v:9},{n:103,en:"Al-Asr",ar:"ÿßŸÑÿπÿµÿ±",juz:30,v:3},
  {n:102,en:"At-Takathur",ar:"ÿßŸÑÿ™ŸÉÿßÿ´ÿ±",juz:30,v:8},{n:101,en:"Al-Qari'ah",ar:"ÿßŸÑŸÇÿßÿ±ÿπÿ©",juz:30,v:11},
  {n:100,en:"Al-Adiyat",ar:"ÿßŸÑÿπÿßÿØŸäÿßÿ™",juz:30,v:11},{n:99,en:"Az-Zalzalah",ar:"ÿßŸÑÿ≤ŸÑÿ≤ŸÑÿ©",juz:30,v:8},
  {n:98,en:"Al-Bayyinah",ar:"ÿßŸÑÿ®ŸäŸÜÿ©",juz:30,v:8},{n:97,en:"Al-Qadr",ar:"ÿßŸÑŸÇÿØÿ±",juz:30,v:5},
  {n:96,en:"Al-Alaq",ar:"ÿßŸÑÿπŸÑŸÇ",juz:30,v:19},{n:95,en:"At-Tin",ar:"ÿßŸÑÿ™ŸäŸÜ",juz:30,v:8},
  {n:94,en:"Ash-Sharh",ar:"ÿßŸÑÿ¥ÿ±ÿ≠",juz:30,v:8},{n:93,en:"Ad-Duhaa",ar:"ÿßŸÑÿ∂ÿ≠Ÿâ",juz:30,v:11},
  {n:92,en:"Al-Layl",ar:"ÿßŸÑŸÑŸäŸÑ",juz:30,v:21},{n:91,en:"Ash-Shams",ar:"ÿßŸÑÿ¥ŸÖÿ≥",juz:30,v:15},
  {n:90,en:"Al-Balad",ar:"ÿßŸÑÿ®ŸÑÿØ",juz:30,v:20},{n:89,en:"Al-Fajr",ar:"ÿßŸÑŸÅÿ¨ÿ±",juz:30,v:30},
  {n:88,en:"Al-Ghashiyah",ar:"ÿßŸÑÿ∫ÿßÿ¥Ÿäÿ©",juz:30,v:26},{n:87,en:"Al-A'la",ar:"ÿßŸÑÿ£ÿπŸÑŸâ",juz:30,v:19},
  {n:86,en:"At-Tariq",ar:"ÿßŸÑÿ∑ÿßÿ±ŸÇ",juz:30,v:17},{n:85,en:"Al-Buruj",ar:"ÿßŸÑÿ®ÿ±Ÿàÿ¨",juz:30,v:22},
  {n:84,en:"Al-Inshiqaq",ar:"ÿßŸÑÿßŸÜÿ¥ŸÇÿßŸÇ",juz:30,v:25},{n:83,en:"Al-Mutaffifin",ar:"ÿßŸÑŸÖÿ∑ŸÅŸÅŸäŸÜ",juz:30,v:36},
  {n:82,en:"Al-Infitar",ar:"ÿßŸÑÿßŸÜŸÅÿ∑ÿßÿ±",juz:30,v:19},{n:81,en:"At-Takwir",ar:"ÿßŸÑÿ™ŸÉŸàŸäÿ±",juz:30,v:29},
  {n:80,en:"Abasa",ar:"ÿπÿ®ÿ≥",juz:30,v:42},{n:79,en:"An-Nazi'at",ar:"ÿßŸÑŸÜÿßÿ≤ÿπÿßÿ™",juz:30,v:46},
  {n:78,en:"An-Naba",ar:"ÿßŸÑŸÜÿ®ÿ£",juz:30,v:40},{n:77,en:"Al-Mursalat",ar:"ÿßŸÑŸÖÿ±ÿ≥ŸÑÿßÿ™",juz:29,v:50},
  {n:76,en:"Al-Insan",ar:"ÿßŸÑÿ•ŸÜÿ≥ÿßŸÜ",juz:29,v:31},{n:75,en:"Al-Qiyamah",ar:"ÿßŸÑŸÇŸäÿßŸÖÿ©",juz:29,v:40},
  {n:74,en:"Al-Muddaththir",ar:"ÿßŸÑŸÖÿØÿ´ÿ±",juz:29,v:56},{n:73,en:"Al-Muzzammil",ar:"ÿßŸÑŸÖÿ≤ŸÖŸÑ",juz:29,v:20},
  {n:72,en:"Al-Jinn",ar:"ÿßŸÑÿ¨ŸÜ",juz:29,v:28},{n:71,en:"Nuh",ar:"ŸÜŸàÿ≠",juz:29,v:28},
  {n:70,en:"Al-Ma'arij",ar:"ÿßŸÑŸÖÿπÿßÿ±ÿ¨",juz:29,v:44},{n:69,en:"Al-Haqqah",ar:"ÿßŸÑÿ≠ÿßŸÇÿ©",juz:29,v:52},
  {n:68,en:"Al-Qalam",ar:"ÿßŸÑŸÇŸÑŸÖ",juz:29,v:52},{n:67,en:"Al-Mulk",ar:"ÿßŸÑŸÖŸÑŸÉ",juz:29,v:30},
  {n:66,en:"At-Tahrim",ar:"ÿßŸÑÿ™ÿ≠ÿ±ŸäŸÖ",juz:28,v:12},{n:65,en:"At-Talaq",ar:"ÿßŸÑÿ∑ŸÑÿßŸÇ",juz:28,v:12},
  {n:64,en:"At-Taghabun",ar:"ÿßŸÑÿ™ÿ∫ÿßÿ®ŸÜ",juz:28,v:18},{n:63,en:"Al-Munafiqun",ar:"ÿßŸÑŸÖŸÜÿßŸÅŸÇŸàŸÜ",juz:28,v:11},
  {n:62,en:"Al-Jumu'ah",ar:"ÿßŸÑÿ¨ŸÖÿπÿ©",juz:28,v:11},{n:61,en:"As-Saf",ar:"ÿßŸÑÿµŸÅ",juz:28,v:14},
  {n:60,en:"Al-Mumtahanah",ar:"ÿßŸÑŸÖŸÖÿ™ÿ≠ŸÜÿ©",juz:28,v:13},{n:59,en:"Al-Hashr",ar:"ÿßŸÑÿ≠ÿ¥ÿ±",juz:28,v:24},
  {n:58,en:"Al-Mujadila",ar:"ÿßŸÑŸÖÿ¨ÿßÿØŸÑÿ©",juz:28,v:22},{n:57,en:"Al-Hadid",ar:"ÿßŸÑÿ≠ÿØŸäÿØ",juz:27,v:29},
  {n:56,en:"Al-Waqi'ah",ar:"ÿßŸÑŸàÿßŸÇÿπÿ©",juz:27,v:96},{n:55,en:"Ar-Rahman",ar:"ÿßŸÑÿ±ÿ≠ŸÖŸÜ",juz:27,v:78},
  {n:54,en:"Al-Qamar",ar:"ÿßŸÑŸÇŸÖÿ±",juz:27,v:55},{n:53,en:"An-Najm",ar:"ÿßŸÑŸÜÿ¨ŸÖ",juz:27,v:62},
  {n:52,en:"At-Tur",ar:"ÿßŸÑÿ∑Ÿàÿ±",juz:27,v:49},{n:51,en:"Adh-Dhariyat",ar:"ÿßŸÑÿ∞ÿßÿ±Ÿäÿßÿ™",juz:26,v:60},
  {n:50,en:"Qaf",ar:"ŸÇ",juz:26,v:45},{n:49,en:"Al-Hujurat",ar:"ÿßŸÑÿ≠ÿ¨ÿ±ÿßÿ™",juz:26,v:18},
  {n:48,en:"Al-Fath",ar:"ÿßŸÑŸÅÿ™ÿ≠",juz:26,v:29},{n:47,en:"Muhammad",ar:"ŸÖÿ≠ŸÖÿØ",juz:26,v:38},
  {n:46,en:"Al-Ahqaf",ar:"ÿßŸÑÿ£ÿ≠ŸÇÿßŸÅ",juz:26,v:35},{n:45,en:"Al-Jathiyah",ar:"ÿßŸÑÿ¨ÿßÿ´Ÿäÿ©",juz:25,v:37},
  {n:44,en:"Ad-Dukhan",ar:"ÿßŸÑÿØÿÆÿßŸÜ",juz:25,v:59},{n:43,en:"Az-Zukhruf",ar:"ÿßŸÑÿ≤ÿÆÿ±ŸÅ",juz:25,v:89},
  {n:42,en:"Ash-Shura",ar:"ÿßŸÑÿ¥Ÿàÿ±Ÿâ",juz:25,v:53},{n:41,en:"Fussilat",ar:"ŸÅÿµŸÑÿ™",juz:24,v:54},
  {n:40,en:"Ghafir",ar:"ÿ∫ÿßŸÅÿ±",juz:24,v:85},{n:39,en:"Az-Zumar",ar:"ÿßŸÑÿ≤ŸÖÿ±",juz:23,v:75},
  {n:38,en:"Sad",ar:"ÿµ",juz:23,v:88},{n:37,en:"As-Saffat",ar:"ÿßŸÑÿµÿßŸÅÿßÿ™",juz:23,v:182},
  {n:36,en:"Ya-Sin",ar:"Ÿäÿ≥",juz:22,v:83},{n:35,en:"Fatir",ar:"ŸÅÿßÿ∑ÿ±",juz:22,v:45},
  {n:34,en:"Saba",ar:"ÿ≥ÿ®ÿ£",juz:22,v:54},{n:33,en:"Al-Ahzab",ar:"ÿßŸÑÿ£ÿ≠ÿ≤ÿßÿ®",juz:21,v:73},
  {n:32,en:"As-Sajdah",ar:"ÿßŸÑÿ≥ÿ¨ÿØÿ©",juz:21,v:30},{n:31,en:"Luqman",ar:"ŸÑŸÇŸÖÿßŸÜ",juz:21,v:34},
  {n:30,en:"Ar-Rum",ar:"ÿßŸÑÿ±ŸàŸÖ",juz:21,v:60},{n:29,en:"Al-Ankabut",ar:"ÿßŸÑÿπŸÜŸÉÿ®Ÿàÿ™",juz:20,v:69},
  {n:28,en:"Al-Qasas",ar:"ÿßŸÑŸÇÿµÿµ",juz:20,v:88},{n:27,en:"An-Naml",ar:"ÿßŸÑŸÜŸÖŸÑ",juz:19,v:93},
  {n:26,en:"Ash-Shu'ara",ar:"ÿßŸÑÿ¥ÿπÿ±ÿßÿ°",juz:19,v:227},{n:25,en:"Al-Furqan",ar:"ÿßŸÑŸÅÿ±ŸÇÿßŸÜ",juz:18,v:77},
  {n:24,en:"An-Nur",ar:"ÿßŸÑŸÜŸàÿ±",juz:18,v:64},{n:23,en:"Al-Mu'minun",ar:"ÿßŸÑŸÖÿ§ŸÖŸÜŸàŸÜ",juz:18,v:118},
  {n:22,en:"Al-Hajj",ar:"ÿßŸÑÿ≠ÿ¨",juz:17,v:78},{n:21,en:"Al-Anbiya",ar:"ÿßŸÑÿ£ŸÜÿ®Ÿäÿßÿ°",juz:17,v:112},
  {n:20,en:"Ta-Ha",ar:"ÿ∑Ÿá",juz:16,v:135},{n:19,en:"Maryam",ar:"ŸÖÿ±ŸäŸÖ",juz:16,v:98},
  {n:18,en:"Al-Kahf",ar:"ÿßŸÑŸÉŸáŸÅ",juz:15,v:110},{n:17,en:"Al-Isra",ar:"ÿßŸÑÿ•ÿ≥ÿ±ÿßÿ°",juz:15,v:111},
  {n:16,en:"An-Nahl",ar:"ÿßŸÑŸÜÿ≠ŸÑ",juz:14,v:128},{n:15,en:"Al-Hijr",ar:"ÿßŸÑÿ≠ÿ¨ÿ±",juz:14,v:99},
  {n:14,en:"Ibrahim",ar:"ÿ•ÿ®ÿ±ÿßŸáŸäŸÖ",juz:13,v:52},{n:13,en:"Ar-Ra'd",ar:"ÿßŸÑÿ±ÿπÿØ",juz:13,v:43},
  {n:12,en:"Yusuf",ar:"ŸäŸàÿ≥ŸÅ",juz:12,v:111},{n:11,en:"Hud",ar:"ŸáŸàÿØ",juz:11,v:123},
  {n:10,en:"Yunus",ar:"ŸäŸàŸÜÿ≥",juz:11,v:109},{n:9,en:"At-Tawbah",ar:"ÿßŸÑÿ™Ÿàÿ®ÿ©",juz:10,v:129},
  {n:8,en:"Al-Anfal",ar:"ÿßŸÑÿ£ŸÜŸÅÿßŸÑ",juz:9,v:75},{n:7,en:"Al-A'raf",ar:"ÿßŸÑÿ£ÿπÿ±ÿßŸÅ",juz:8,v:206},
  {n:6,en:"Al-An'am",ar:"ÿßŸÑÿ£ŸÜÿπÿßŸÖ",juz:7,v:165},{n:5,en:"Al-Ma'idah",ar:"ÿßŸÑŸÖÿßÿ¶ÿØÿ©",juz:6,v:120},
  {n:4,en:"An-Nisa",ar:"ÿßŸÑŸÜÿ≥ÿßÿ°",juz:4,v:176},{n:3,en:"Aali Imran",ar:"ÿ¢ŸÑ ÿπŸÖÿ±ÿßŸÜ",juz:3,v:200},
  {n:2,en:"Al-Baqarah",ar:"ÿßŸÑÿ®ŸÇÿ±ÿ©",juz:1,v:286},{n:1,en:"Al-Fatiha",ar:"ÿßŸÑŸÅÿßÿ™ÿ≠ÿ©",juz:1,v:7}
];

const STATUS_CYCLE=['not-started','memorising','memorised','revision'];
const STATUS_LABELS={'not-started':'‚¨ú Not Started','memorising':'üìù Memorising','memorised':'‚úÖ Memorised','revision':'üîÑ Revision'};

const SURAH_MEANING={1:'The Opener',2:'The Cow',3:'Family of Imran',4:'The Women',5:'The Table Spread',6:'The Cattle',7:'The Heights',8:'Spoils of War',9:'The Repentance',10:'Jonah',11:'Hud',12:'Joseph',13:'The Thunder',14:'Abraham',15:'The Rocky Tract',16:'The Bee',17:'The Night Journey',18:'The Cave',19:'Mary',20:'Ta-Ha',21:'The Prophets',22:'The Pilgrimage',23:'The Believers',24:'The Light',25:'The Criterion',26:'The Poets',27:'The Ant',28:'The Stories',29:'The Spider',30:'The Romans',31:'Luqman',32:'The Prostration',33:'The Combined Forces',34:'Sheba',35:'Originator',36:'Ya-Sin',37:'Those Who Set the Ranks',38:'Sad',39:'The Troops',40:'The Forgiver',41:'Explained in Detail',42:'The Consultation',43:'Ornaments of Gold',44:'The Smoke',45:'The Crouching',46:'The Sandhills',47:'Muhammad',48:'The Victory',49:'The Rooms',50:'Qaf',51:'The Winds',52:'The Mount',53:'The Star',54:'The Moon',55:'The Beneficent',56:'The Inevitable',57:'The Iron',58:'The Pleading Woman',59:'The Exile',60:'She That Is Examined',61:'The Ranks',62:'The Congregation',63:'The Hypocrites',64:'Mutual Disillusion',65:'The Divorce',66:'The Prohibition',67:'The Sovereignty',68:'The Pen',69:'The Reality',70:'The Ascending Stairways',71:'Noah',72:'The Jinn',73:'The Enshrouded One',74:'The Cloaked One',75:'The Resurrection',76:'The Man',77:'The Emissaries',78:'The Tidings',79:'Those Who Drag Forth',80:'He Frowned',81:'The Overthrowing',82:'The Cleaving',83:'The Defrauding',84:'The Sundering',85:'The Stars',86:'The Night-Comer',87:'The Most High',88:'The Overwhelming',89:'The Dawn',90:'The City',91:'The Sun',92:'The Night',93:'The Morning Hours',94:'The Relief',95:'The Fig',96:'The Clot',97:'The Power',98:'The Clear Proof',99:'The Earthquake',100:'The Courser',101:'The Calamity',102:'Rivalry',103:'The Declining Day',104:'The Traducer',105:'The Elephant',106:'Quraysh',107:'Small Kindnesses',108:'The Abundance',109:'The Disbelievers',110:'Divine Support',111:'The Palm Fibre',112:'The Sincerity',113:'The Daybreak',114:'Mankind'};
const SURAH_TRANSLIT={1:'Al-Fatihah',2:'Al-Baqarah',3:"Ali 'Imran",4:"An-Nisa'",5:"Al-Ma'idah",6:"Al-An'am",7:"Al-A'raf",8:'Al-Anfal',9:'At-Tawbah',10:'Yunus',11:'Hud',12:'Yusuf',13:"Ar-Ra'd",14:'Ibrahim',15:'Al-Hijr',16:'An-Nahl',17:"Al-Isra'",18:'Al-Kahf',19:'Maryam',20:'Ta-Ha',21:'Al-Anbya',22:'Al-Hajj',23:"Al-Mu'minun",24:'An-Nur',25:'Al-Furqan',26:"Ash-Shu'ara",27:'An-Naml',28:'Al-Qasas',29:"Al-'Ankabut",30:'Ar-Rum',31:'Luqman',32:'As-Sajdah',33:'Al-Ahzab',34:"Saba'",35:'Fatir',36:'Ya-Sin',37:'As-Saffat',38:'Sad',39:'Az-Zumar',40:'Ghafir',41:'Fussilat',42:'Ash-Shura',43:'Az-Zukhruf',44:'Ad-Dukhan',45:'Al-Jathiyah',46:'Al-Ahqaf',47:'Muhammad',48:'Al-Fath',49:'Al-Hujurat',50:'Qaf',51:'Adh-Dhariyat',52:'At-Tur',53:'An-Najm',54:'Al-Qamar',55:'Ar-Rahman',56:"Al-Waqi'ah",57:'Al-Hadid',58:'Al-Mujadila',59:'Al-Hashr',60:'Al-Mumtahanah',61:'As-Saf',62:"Al-Jumu'ah",63:'Al-Munafiqun',64:'At-Taghabun',65:'At-Talaq',66:'At-Tahrim',67:'Al-Mulk',68:'Al-Qalam',69:'Al-Haqqah',70:"Al-Ma'arij",71:'Nuh',72:'Al-Jinn',73:'Al-Muzzammil',74:'Al-Muddaththir',75:'Al-Qiyamah',76:'Al-Insan',77:'Al-Mursalat',78:'An-Naba',79:"An-Nazi'at",80:"'Abasa",81:'At-Takwir',82:'Al-Infitar',83:'Al-Mutaffifin',84:'Al-Inshiqaq',85:'Al-Buruj',86:'At-Tariq',87:"Al-A'la",88:'Al-Ghashiyah',89:'Al-Fajr',90:'Al-Balad',91:'Ash-Shams',92:'Al-Layl',93:'Ad-Duhaa',94:'Ash-Sharh',95:'At-Tin',96:"Al-'Alaq",97:'Al-Qadr',98:'Al-Bayyinah',99:'Az-Zalzalah',100:"Al-'Adiyat",101:"Al-Qari'ah",102:'At-Takathur',103:"Al-'Asr",104:'Al-Humazah',105:'Al-Fil',106:'Quraysh',107:"Al-Ma'un",108:'Al-Kawthar',109:'Al-Kafirun',110:'An-Nasr',111:'Al-Masad',112:'Al-Ikhlas',113:'Al-Falaq',114:'An-Nas'};
const SURAH_PLACE={1:'Makkah',2:'Madinah',3:'Madinah',4:'Madinah',5:'Madinah',6:'Makkah',7:'Makkah',8:'Madinah',9:'Madinah',10:'Makkah',11:'Makkah',12:'Makkah',13:'Madinah',14:'Makkah',15:'Makkah',16:'Makkah',17:'Makkah',18:'Makkah',19:'Makkah',20:'Makkah',21:'Makkah',22:'Madinah',23:'Makkah',24:'Madinah',25:'Makkah',26:'Makkah',27:'Makkah',28:'Makkah',29:'Makkah',30:'Makkah',31:'Makkah',32:'Makkah',33:'Madinah',34:'Makkah',35:'Makkah',36:'Makkah',37:'Makkah',38:'Makkah',39:'Makkah',40:'Makkah',41:'Makkah',42:'Makkah',43:'Makkah',44:'Makkah',45:'Makkah',46:'Makkah',47:'Madinah',48:'Madinah',49:'Madinah',50:'Makkah',51:'Makkah',52:'Makkah',53:'Makkah',54:'Makkah',55:'Madinah',56:'Makkah',57:'Madinah',58:'Madinah',59:'Madinah',60:'Madinah',61:'Madinah',62:'Madinah',63:'Madinah',64:'Madinah',65:'Madinah',66:'Madinah',67:'Makkah',68:'Makkah',69:'Makkah',70:'Makkah',71:'Makkah',72:'Makkah',73:'Makkah',74:'Makkah',75:'Makkah',76:'Madinah',77:'Makkah',78:'Makkah',79:'Makkah',80:'Makkah',81:'Makkah',82:'Makkah',83:'Makkah',84:'Makkah',85:'Makkah',86:'Makkah',87:'Makkah',88:'Makkah',89:'Makkah',90:'Makkah',91:'Makkah',92:'Makkah',93:'Makkah',94:'Makkah',95:'Makkah',96:'Makkah',97:'Makkah',98:'Madinah',99:'Madinah',100:'Makkah',101:'Makkah',102:'Makkah',103:'Makkah',104:'Makkah',105:'Makkah',106:'Makkah',107:'Makkah',108:'Makkah',109:'Makkah',110:'Madinah',111:'Makkah',112:'Makkah',113:'Makkah',114:'Makkah'};

const BADGES=[
  {id:'first_step',emoji:'üå±',name:'First Step',desc:'Memorise your first surah',check:s=>s.filter(x=>x.status==='memorised').length>=1},
  {id:'five',emoji:'‚úã',name:'High Five',desc:'Memorise 5 surahs',check:s=>s.filter(x=>x.status==='memorised').length>=5},
  {id:'ten',emoji:'üéØ',name:'Ten Strong',desc:'Memorise 10 surahs',check:s=>s.filter(x=>x.status==='memorised').length>=10},
  {id:'twenty',emoji:'üìö',name:'Scholar',desc:'Memorise 20 surahs',check:s=>s.filter(x=>x.status==='memorised').length>=20},
  {id:'juz_amma',emoji:'üïå',name:'Juz Amma',desc:'Memorise all of Juz 30',check:s=>s.filter(x=>x.juz===30&&x.status==='memorised').length===s.filter(x=>x.juz===30).length},
  {id:'half',emoji:'üåô',name:'Halfway',desc:'Memorise 57+ surahs',check:s=>s.filter(x=>x.status==='memorised').length>=57},
  {id:'full',emoji:'üìñ',name:'Hafidh/Hafidha',desc:'Memorise all 114 surahs',check:s=>s.filter(x=>x.status==='memorised').length===114},
  {id:'first_rev',emoji:'üîÑ',name:'Revisor',desc:'First surah in revision',check:s=>s.filter(x=>x.status==='revision').length>=1},
  {id:'annotator',emoji:'üìù',name:'Annotator',desc:'Add notes to 5 surahs',check:s=>s.filter(x=>x.notes&&x.notes.trim()).length>=5},
  {id:'first_star',emoji:'‚≠ê',name:'First Star',desc:'Rate confidence on a surah',check:s=>s.filter(x=>x.confidence>0).length>=1},
];

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// GLOBAL STATE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let currentUser = null;
let userProfile = null;
let userState   = null;
let activeFilter = 'all';
let activeTab   = '';
let donutChart_ = null;
let juzChart_   = null;
let compareChart_ = null;
let verseCache  = {};
let verseMode   = 'arabic';
let editGoalId  = null;
let unsubListeners = [];
let currentSurahFetchId = 0; // FIX #15: abort controller for stale fetches

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// FRESH STATE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function freshState() {
  return {
    surahs: SURAHS.map(s=>({...s,status:'not-started',lastRevised:'',notes:'',confidence:0})),
    heatmap: {},
    history: [],
    earnedBadges: [],
    goals:[
      {id:1,title:'Memorise Short Surahs',target:20,deadline:'',metric:'memorised'},
      {id:2,title:'Juz Amma Complete',target:37,deadline:'',metric:'memorised'},
      {id:3,title:'Overall Memorisation',target:114,deadline:'',metric:'memorised'},
      {id:4,title:'Active Revision',target:10,deadline:'',metric:'revision'},
    ]
  };
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// FIREBASE HELPERS ‚Äî FIX #1: use fn() consistently
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function db()  { return window.__db; }
function auth(){ return window.__auth; }
function fn()  { return window.__firebaseFns; }

// FIX #9: Find surah by number, not by array index
function findSurahIndex(surahNum) {
  return userState.surahs.findIndex(s => s.n === surahNum);
}

// FIX #1: All Firestore calls now use fn().xxx consistently
async function saveState() {
  if (!currentUser || !userState) return;
  try {
    await fn().setDoc(fn().doc(db(), 'users', currentUser.uid, 'data', 'state'), userState);
  } catch(e) {
    console.error('Failed to save state:', e);
    showToast('‚ö†Ô∏è', 'Save failed', 'Changes may not be saved');
  }
}

async function loadState() {
  const snap = await fn().getDoc(fn().doc(db(), 'users', currentUser.uid, 'data', 'state'));
  if (snap.exists()) {
    const saved = snap.data();
    const base = freshState();
    if (saved.surahs && saved.surahs.length === 114) {
      // FIX #10: Merge saved data with defaults to ensure all fields exist
      base.surahs = saved.surahs.map(s => ({
        ...freshState().surahs.find(fs => fs.n === s.n) || {},
        ...s
      }));
    }
    base.heatmap = saved.heatmap || {};
    base.history = saved.history || [];
    base.earnedBadges = saved.earnedBadges || [];
    base.goals = saved.goals || base.goals;
    userState = base;
  } else {
    userState = freshState();
    await saveState();
  }
}

async function loadProfile() {
  const snap = await fn().getDoc(fn().doc(db(), 'users', currentUser.uid));
  if (snap.exists()) userProfile = snap.data();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// AUTH SCREEN
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let selectedRole = 'student';

// Particles
function initAuthParticles() {
  const canvas = document.getElementById('authParticles');
  if(!canvas) return;
  const ctx = canvas.getContext('2d');
  let ps = [], raf = 0;
  const setSize = () => { canvas.width = window.innerWidth; canvas.height = window.innerHeight; };
  setSize();
  const make = () => ({x:Math.random()*canvas.width,y:Math.random()*canvas.height,v:Math.random()*0.25+0.05,o:Math.random()*0.3+0.1});
  const init = () => { ps=[]; const count=Math.floor((canvas.width*canvas.height)/9000); for(let i=0;i<count;i++) ps.push(make()); };
  const draw = () => { ctx.clearRect(0,0,canvas.width,canvas.height); ps.forEach(p=>{p.y-=p.v;if(p.y<0){p.x=Math.random()*canvas.width;p.y=canvas.height+20;p.v=Math.random()*0.25+0.05;p.o=Math.random()*0.3+0.1;}ctx.fillStyle=`rgba(250,250,250,${p.o})`;ctx.fillRect(p.x,p.y,0.7,2.2);}); raf=requestAnimationFrame(draw); };
  const onResize = () => { setSize(); init(); };
  window.addEventListener('resize', onResize);
  init(); raf = requestAnimationFrame(draw);
  return () => { window.removeEventListener('resize', onResize); cancelAnimationFrame(raf); };
}

let _stopParticles = null;
function startAuthParticles() { if(!_stopParticles) _stopParticles = initAuthParticles(); }
function stopAuthParticles() { if(_stopParticles) { _stopParticles(); _stopParticles = null; } }

let _pwVisible = false;
function togglePasswordVisibility() {
  _pwVisible = !_pwVisible;
  const input = document.getElementById('loginPassword');
  const btn = document.getElementById('togglePw');
  if(input) input.type = _pwVisible ? 'text' : 'password';
  if(btn) btn.textContent = _pwVisible ? 'üôà' : 'üëÅ';
}

function switchAuthTab(tab) {
  document.querySelectorAll('.auth-tab').forEach((t,i)=>t.classList.toggle('active',['login','signup'][i]===tab));
  document.getElementById('loginForm').classList.toggle('active',tab==='login');
  document.getElementById('signupForm').classList.toggle('active',tab==='signup');
  clearAuthError();
}

function selectRole(role, el) {
  selectedRole = role;
  document.querySelectorAll('#roleCards .role-card').forEach(c=>c.classList.remove('selected'));
  el.classList.add('selected');
  document.getElementById('classCodeGroup').style.display = (role==='student')?'block':'none';
}

function showAuthError(msg) { const el=document.getElementById('authError'); el.textContent=msg; el.classList.add('visible'); }
function clearAuthError() { document.getElementById('authError').classList.remove('visible'); }

async function handleLogin() {
  const email=document.getElementById('loginEmail').value.trim();
  const pass=document.getElementById('loginPassword').value;
  if(!email||!pass){showAuthError('Please fill in all fields');return;}
  clearAuthError();
  try { await fn().signInWithEmailAndPassword(auth(),email,pass); }
  catch(e) { showAuthError(e.code==='auth/invalid-credential'?'Invalid email or password.':e.message); }
}

async function handleSignup() {
  const name=document.getElementById('signupName').value.trim();
  const email=document.getElementById('signupEmail').value.trim();
  const pass=document.getElementById('signupPassword').value;
  if(!name||!email||!pass){showAuthError('Please fill in all fields');return;}
  if(pass.length<6){showAuthError('Password must be at least 6 characters');return;}
  clearAuthError();
  try {
    const cred = await fn().createUserWithEmailAndPassword(auth(),email,pass);
    const uid = cred.user.uid;
    const classCode = document.getElementById('classCode')?.value.trim()||'';
    const inviteToken = 'inv_'+uid+'_'+Math.random().toString(36).slice(2,8);
    const profile = {name,email,role:selectedRole,uid,inviteToken,classCode,createdAt:new Date().toISOString(),linkedChildren:[],linkedParents:[],linkedTeacher:null};
    await fn().setDoc(fn().doc(db(),'users',uid),profile);
    if(selectedRole==='student'&&classCode) await linkToTeacherByCode(uid,classCode);
  } catch(e) {
    showAuthError(e.code==='auth/email-already-in-use'?'This email is already registered.':e.message);
  }
}

async function linkToTeacherByCode(studentUid, code) {
  const q = fn().query(fn().collection(db(),'users'), fn().where('inviteToken','==',code));
  const snap = await fn().getDocs(q);
  if(!snap.empty){
    const teacherDoc = snap.docs[0];
    const teacherData = teacherDoc.data();
    const students = teacherData.students||[];
    if(!students.includes(studentUid)) students.push(studentUid);
    await fn().updateDoc(fn().doc(db(),'users',teacherDoc.id),{students});
    await fn().updateDoc(fn().doc(db(),'users',studentUid),{linkedTeacher:teacherDoc.id});
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// GOOGLE SIGN-IN ‚Äî FIX #20: defer initApp until profile exists
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let pendingGoogleUser = null;
let selectedGoogleRole = 'student';
let _waitingForGoogleRole = false; // FIX #20

async function handleGoogleSignIn() {
  clearAuthError();
  try {
    const provider = new (fn().GoogleAuthProvider)();
    _waitingForGoogleRole = true; // FIX #20: prevent initApp from running
    const result = await fn().signInWithPopup(auth(), provider);
    const user = result.user;
    const snap = await fn().getDoc(fn().doc(db(), 'users', user.uid));
    if (snap.exists()) {
      // Existing user ‚Äî let onAuthStateChanged handle it
      _waitingForGoogleRole = false;
      // Manually trigger initApp since onAuthStateChanged may have already fired
      await initApp(user);
      return;
    }
    // New Google user ‚Äî need to pick a role
    pendingGoogleUser = user;
    selectedGoogleRole = 'student';
    document.getElementById('googleRoleOverlay').style.display = 'flex';
    document.getElementById('googleClassCodeGroup').style.display = 'block';
  } catch(e) {
    _waitingForGoogleRole = false;
    if (e.code !== 'auth/popup-closed-by-user') showAuthError(e.message);
  }
}

function selectGoogleRole(role, el) {
  selectedGoogleRole = role;
  document.querySelectorAll('#googleRoleCards .role-card').forEach(c => c.classList.remove('selected'));
  el.classList.add('selected');
  document.getElementById('googleClassCodeGroup').style.display = role === 'student' ? 'block' : 'none';
}

async function confirmGoogleRole() {
  if (!pendingGoogleUser) return;
  const user = pendingGoogleUser;
  const classCode = document.getElementById('googleClassCode')?.value.trim() || '';
  const inviteToken = 'inv_' + user.uid + '_' + Math.random().toString(36).slice(2, 8);
  const name = user.displayName || user.email.split('@')[0];
  const profile = {
    name, email: user.email, role: selectedGoogleRole, uid: user.uid,
    inviteToken, classCode, createdAt: new Date().toISOString(),
    linkedChildren: [], linkedParents: [], linkedTeacher: null,
    photoURL: user.photoURL || null
  };
  await fn().setDoc(fn().doc(db(), 'users', user.uid), profile);
  if (selectedGoogleRole === 'student' && classCode) await linkToTeacherByCode(user.uid, classCode);
  document.getElementById('googleRoleOverlay').style.display = 'none';
  pendingGoogleUser = null;
  _waitingForGoogleRole = false;
  // Now manually init the app
  await initApp(user);
}

async function handleForgotPassword() {
  const email = prompt('Enter your email address to reset your password:');
  if(!email) return;
  try {
    await fn().sendPasswordResetEmail(auth(),email);
    showToast('üìß','Password reset email sent!','Check your inbox');
  } catch(e) { showToast('‚ùå','Error',e.message); }
}

async function handleSignOut() {
  closeHeaderDropdown();
  unsubListeners.forEach(u=>u&&u());
  unsubListeners=[];
  await fn().signOut(auth());
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// APP INIT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function initApp(user) {
  currentUser = user;
  await loadProfile();
  if (!userProfile) {
    // FIX #20: Profile doesn't exist yet (Google user picking role)
    return;
  }
  await loadState();

  const urlParams = new URLSearchParams(window.location.search);
  const inviteToken = urlParams.get('invite');
  if(inviteToken) await handleInviteFromURL(inviteToken);

  document.getElementById('authScreen').classList.remove('active');
  document.getElementById('appScreen').classList.add('active');
  updateHeaderUser();
  buildNav();
  showFirstTab();
  hideLoading();
}

function updateHeaderUser() {
  if(!userProfile) return;
  const initial = (userProfile.name||'U')[0].toUpperCase();
  const avatarEl = document.getElementById('headerAvatar');
  if(userProfile.photoURL) {
    avatarEl.innerHTML = `<img src="${esc(userProfile.photoURL)}" style="width:100%;height:100%;border-radius:50%;object-fit:cover" referrerpolicy="no-referrer">`;
  } else {
    avatarEl.textContent = initial;
  }
  document.getElementById('headerName').textContent = userProfile.name||'User';
  const badge = document.getElementById('roleBadge');
  badge.textContent = {teacher:'üë©‚Äçüè´ Teacher',parent:'üë®‚Äçüë©‚Äçüëß Parent',student:'üßë‚Äçüéì Student'}[userProfile.role]||'';
  badge.className = 'role-badge '+(userProfile.role||'student');
}

function buildNav() {
  const role = userProfile?.role||'student';
  const nav = document.getElementById('mainNav');
  let tabs = [];
  if(role==='student') {
    tabs=[{id:'overview',label:'üìä Overview'},{id:'surahs',label:'üìñ Surahs'},{id:'juz',label:'üìö By Juz'},{id:'heatmap',label:'üìÖ Revision Calendar'},{id:'goals',label:'üéØ Goals'},{id:'history',label:'üìú History'},{id:'connect',label:'üîó Connect'}];
  } else if(role==='teacher') {
    tabs=[{id:'teacher-overview',label:'üë• Class Overview'},{id:'teacher-messages',label:'üí¨ Messages'},{id:'teacher-invite',label:'üîó Invite & Manage'},{id:'overview',label:'üìä My Progress'},{id:'surahs',label:'üìñ My Surahs'},{id:'heatmap',label:'üìÖ My Calendar'}];
  } else {
    tabs=[{id:'parent-children',label:'üë¶üëß My Children'},{id:'parent-messages',label:'üí¨ Message Teacher'},{id:'parent-connect',label:'üîó Link a Child'}];
  }
  nav.innerHTML = tabs.map(t=>`<button class="tab-btn" id="navbtn-${t.id}" onclick="showTab('${t.id}')">${t.label}</button>`).join('');
}

function showFirstTab() {
  const role = userProfile?.role||'student';
  if(role==='teacher') showTab('teacher-overview');
  else if(role==='parent') showTab('parent-children');
  else showTab('overview');
}

function showTab(name) {
  document.querySelectorAll('.tab-section').forEach(s=>s.classList.remove('active'));
  document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
  const sec = document.getElementById('tab-'+name);
  if(sec) sec.classList.add('active');
  const btn = document.getElementById('navbtn-'+name);
  if(btn) btn.classList.add('active');
  activeTab = name;
  renderTab(name);
}

function renderTab(name) {
  if(name==='overview')          { renderKPIs(); renderCharts(); renderBadges(); }
  if(name==='surahs')            renderTable();
  if(name==='juz')               renderJuzBars();
  if(name==='heatmap')           { renderHeatmap(); renderDueList(); }
  if(name==='goals')             renderGoals();
  if(name==='history')           renderHistory();
  if(name==='connect')           renderConnectTab();
  if(name==='teacher-overview')  renderTeacherOverview();
  if(name==='teacher-messages')  renderTeacherMessages();
  if(name==='teacher-invite')    renderTeacherInvite();
  if(name==='parent-children')   renderParentChildren();
  if(name==='parent-messages')   renderParentMessages();
  if(name==='parent-connect')    renderParentConnect();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// KPIs
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function getStats(surahs) {
  const s = surahs||userState.surahs;
  const m=s.filter(x=>x.status==='memorised').length;
  const mg=s.filter(x=>x.status==='memorising').length;
  const r=s.filter(x=>x.status==='revision').length;
  return {m,mg,r,ns:114-m-mg-r,pct:Math.round(m/114*100)};
}

// FIX #4/#12: Fixed streak calculation ‚Äî streak counts consecutive days backward from today
function calcStreak() {
  let streak=0;
  const today=new Date();
  for(let i=0;i<365;i++){
    const d=new Date(today); d.setDate(d.getDate()-i);
    const ds=localDateStr(d);
    if(userState.heatmap[ds]) streak++; else break; // FIX: break immediately, no free pass for today
  }
  return streak;
}

function calcStreakFromHeatmap(heatmap){
  let streak=0; const today=new Date();
  for(let i=0;i<365;i++){const d=new Date(today);d.setDate(d.getDate()-i);const ds=localDateStr(d);if(heatmap[ds]) streak++;else break;}
  return streak;
}

function renderKPIs() {
  const {m,mg,r,pct}=getStats();
  const streak=calcStreak();
  const rated=userState.surahs.filter(s=>s.confidence>0);
  const avg=rated.length?(rated.reduce((a,s)=>a+s.confidence,0)/rated.length).toFixed(1):'‚Äî';
  document.getElementById('kpiGrid').innerHTML=`
    <div class="kpi-card c1"><div class="kpi-icon">üìñ</div><div class="kpi-value" style="color:var(--teal)">${m+mg+r}</div><div class="kpi-label">Total Tracked</div></div>
    <div class="kpi-card c2"><div class="kpi-icon">‚úÖ</div><div class="kpi-value" style="color:var(--green)">${m}</div><div class="kpi-label">Memorised</div></div>
    <div class="kpi-card c3"><div class="kpi-icon">üìù</div><div class="kpi-value" style="color:var(--blue)">${mg}</div><div class="kpi-label">Memorising</div></div>
    <div class="kpi-card c4"><div class="kpi-icon">üîÑ</div><div class="kpi-value" style="color:var(--amber)">${r}</div><div class="kpi-label">In Revision</div></div>
    <div class="kpi-card c1"><div class="kpi-icon">üåü</div><div class="kpi-value" style="color:var(--teal)">${pct}%</div><div class="kpi-label">Completion</div><div class="kpi-bar"><div class="kpi-bar-fill" style="width:${pct}%"></div></div></div>
    <div class="kpi-card c5"><div class="kpi-icon">üî•</div><div class="kpi-value" style="color:#e8a4b8">${streak}</div><div class="kpi-label">Day Streak</div></div>
    <div class="kpi-card c3"><div class="kpi-icon">‚≠ê</div><div class="kpi-value" style="color:var(--blue)">${avg==='‚Äî'?'‚Äî':avg+'‚òÖ'}</div><div class="kpi-label">Avg Confidence</div></div>`;
  document.getElementById('donutNum').textContent=m;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CHARTS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderCharts() {
  const {m,mg,r,ns}=getStats();
  if(donutChart_) donutChart_.destroy();
  donutChart_=new Chart(document.getElementById('donutChart').getContext('2d'),{
    type:'doughnut',
    data:{labels:['Memorised','Memorising','Revision','Not Started'],datasets:[{data:[m,mg,r,ns],backgroundColor:['#51bb25','#2697f3','#f4a53a','#e6e9f4'],borderWidth:0,hoverOffset:6}]},
    options:{cutout:'72%',plugins:{legend:{display:false},tooltip:{backgroundColor:'#fff',borderColor:'#e6e9f4',borderWidth:1,titleColor:'#2c323f',bodyColor:'#6c757d',padding:12,cornerRadius:10}},animation:{animateRotate:true,duration:800}}
  });
  const jd=buildJuzData();
  if(juzChart_) juzChart_.destroy();
  juzChart_=new Chart(document.getElementById('juzChart').getContext('2d'),{
    type:'bar',
    data:{labels:jd.map(j=>'J'+j.juz),datasets:[
      {label:'Memorised',data:jd.map(j=>j.m),backgroundColor:'#51bb25',borderRadius:4,borderSkipped:false},
      {label:'Memorising',data:jd.map(j=>j.mg),backgroundColor:'#2697f3',borderRadius:4,borderSkipped:false},
      {label:'Revision',data:jd.map(j=>j.r),backgroundColor:'#f4a53a',borderRadius:4,borderSkipped:false},
    ]},
    options:{responsive:true,maintainAspectRatio:false,scales:{x:{stacked:true,grid:{color:'rgba(230,233,244,0.8)'},ticks:{color:'#98a2b3',font:{size:9}}},y:{stacked:true,grid:{color:'rgba(230,233,244,0.8)'},ticks:{color:'#98a2b3',stepSize:1}}},plugins:{legend:{labels:{color:'#6c757d',font:{size:11},boxWidth:10}},tooltip:{backgroundColor:'#fff',borderColor:'#e6e9f4',borderWidth:1,titleColor:'#2c323f',bodyColor:'#6c757d',padding:10,cornerRadius:8}},animation:{duration:600}}
  });
}

function buildJuzData(surahs) {
  const s=surahs||userState.surahs;
  return Array.from({length:30},(_,i)=>{
    const j=i+1,ss=s.filter(x=>x.juz===j);
    return{juz:j,m:ss.filter(x=>x.status==='memorised').length,mg:ss.filter(x=>x.status==='memorising').length,r:ss.filter(x=>x.status==='revision').length,total:ss.length};
  });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// BADGES
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderBadges() {
  const prev=userState.earnedBadges||[];
  const now=BADGES.filter(b=>b.check(userState.surahs)).map(b=>b.id);
  const newOnes=now.filter(id=>!prev.includes(id));
  if(newOnes.length){
    userState.earnedBadges=now;
    newOnes.forEach(id=>{const b=BADGES.find(x=>x.id===id);if(b){logActivity('üèÜ',`Badge: ${b.name}`,b.desc);showToast('üèÜ','Badge Earned: '+b.name,b.desc);}});
    saveState();
  }
  const grid=document.getElementById('badgesSectionOverview');
  if(grid) grid.innerHTML=BADGES.map(b=>{const e=now.includes(b.id);return`<div class="badge-card ${e?'earned':'locked'}">${e?'<div class="badge-earned-tag">‚úì EARNED</div>':''}<div class="badge-emoji">${b.emoji}</div><div class="badge-name">${esc(b.name)}</div><div class="badge-desc">${esc(b.desc)}</div></div>`;}).join('');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SURAH TABLE ‚Äî FIX #9: use surah number for operations, not array index
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderTable() {
  const tbody=document.getElementById('surahTableBody');
  tbody.innerHTML='';
  userState.surahs.forEach((s)=>{
    const tr=document.createElement('tr');
    tr.dataset.name=s.en.toLowerCase(); tr.dataset.status=s.status; tr.dataset.num=s.n;
    tr.innerHTML=`
      <td><div class="surah-num">${s.n}</div></td>
      <td><button class="surah-name-btn" onclick="openSurahViewer(${s.n})">${esc(s.en)}</button></td>
      <td><div class="arabic-col">${esc(s.ar)}</div></td>
      <td style="color:var(--text3)">${s.juz}</td>
      <td style="color:var(--text3)">${s.v}</td>
      <td><button class="status-badge ${s.status}" onclick="cycleStatus(${s.n})">${STATUS_LABELS[s.status]}</button></td>
      <td><input type="date" class="date-input" value="${s.lastRevised||''}" onchange="updateRevised(${s.n},this.value)"></td>
      <td><div class="star-rating">${[1,2,3,4,5].map(x=>`<span class="star ${x<=(s.confidence||0)?'filled':''}" onclick="setConf(${s.n},${x})">‚òÖ</span>`).join('')}</div></td>
      <td><input type="text" class="notes-input" value="${esc(s.notes||'')}" placeholder="Add notes‚Ä¶" onchange="updateNotes(${s.n},this.value)"></td>`;
    tbody.appendChild(tr);
  });
  filterTable();
}

// FIX #9: All these now use surah number to find the correct item
function cycleStatus(surahNum) {
  const i = findSurahIndex(surahNum);
  if (i === -1) return;
  const s=userState.surahs[i];
  const prev=s.status;
  s.status=STATUS_CYCLE[(STATUS_CYCLE.indexOf(prev)+1)%STATUS_CYCLE.length];
  logActivity({memorised:'‚úÖ',memorising:'üìù',revision:'üîÑ','not-started':'‚¨ú'}[s.status],`Status: ${s.en}`,`${STATUS_LABELS[prev]} ‚Üí ${STATUS_LABELS[s.status]}`);
  saveState(); renderTable(); renderKPIs(); renderBadges();
}

function updateRevised(surahNum,val) {
  const i = findSurahIndex(surahNum);
  if (i === -1) return;
  userState.surahs[i].lastRevised=val;
  if(val) logActivity('üìÖ',`Revised: ${userState.surahs[i].en}`,new Date(val).toLocaleDateString('en-GB',{day:'numeric',month:'short',year:'numeric'}));
  saveState();
}

function updateNotes(surahNum,val) {
  const i = findSurahIndex(surahNum);
  if (i === -1) return;
  userState.surahs[i].notes=val;
  if(val.trim()) logActivity('üìù',`Note: ${userState.surahs[i].en}`,val.slice(0,60));
  saveState();
}

function setConf(surahNum,val) {
  const i = findSurahIndex(surahNum);
  if (i === -1) return;
  const s=userState.surahs[i];
  s.confidence=s.confidence===val?0:val;
  logActivity('‚≠ê',`Confidence: ${s.en}`,s.confidence?`${s.confidence}/5‚òÖ`:'Cleared');
  saveState(); renderTable(); renderKPIs();
}

function setFilter(f,btn) {
  activeFilter=f;
  document.querySelectorAll('.filter-btn').forEach(b=>b.classList.remove('active-filter'));
  btn.classList.add('active-filter');
  filterTable();
}

function filterTable() {
  const q=(document.getElementById('searchInput')?.value||'').toLowerCase();
  document.querySelectorAll('#surahTableBody tr').forEach(row=>{
    const match=(!q||row.dataset.name.includes(q))&&(activeFilter==='all'||row.dataset.status===activeFilter);
    row.style.display=match?'':'none';
  });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// JUZ BARS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderJuzBars() {
  document.getElementById('juzBarsContainer').innerHTML=buildJuzData().map(j=>{
    const pct=j.total?Math.round(j.m/j.total*100):0;
    return`<div class="juz-bar">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:5px">
        <div style="font-size:13px;font-weight:600">Juz ${j.juz}</div>
        <div style="font-size:12px;color:var(--text3)">${j.m}/${j.total} memorised</div>
        <div style="font-size:12px;font-weight:600;color:var(--teal)">${pct}%</div>
      </div>
      <div style="height:8px;background:var(--border);border-radius:4px;overflow:hidden;display:flex">
        <div style="width:${j.total?Math.round(j.m/j.total*100):0}%;background:var(--green);transition:width 0.6s"></div>
        <div style="width:${j.total?Math.round(j.mg/j.total*100):0}%;background:var(--blue);transition:width 0.6s"></div>
        <div style="width:${j.total?Math.round(j.r/j.total*100):0}%;background:var(--amber);transition:width 0.6s"></div>
      </div>
    </div>`;
  }).join('');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// HEATMAP ‚Äî FIX #13: use local dates
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function logTodayRevision() {
  const today=todayStr();
  userState.heatmap[today]=(userState.heatmap[today]||0)+1;
  logActivity('üóìÔ∏è','Revision logged',`Session ${userState.heatmap[today]} today`);
  await saveState(); renderHeatmap(); renderDueList();
  showToast('‚úÖ','Revision logged!','Keep it up!');
}

function renderHeatmap() {
  const today=new Date();
  const start=new Date(today); start.setDate(start.getDate()-52*7+1);
  const dow=start.getDay()||7; if(dow!==1) start.setDate(start.getDate()-(dow-1));
  const cols=document.getElementById('heatmapCols');
  const monthsEl=document.getElementById('heatmapMonths');
  cols.innerHTML=''; monthsEl.innerHTML='';
  const months=['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
  let colDate=new Date(start),lastMonth=-1,monthSpans=[];
  const todayLocal = todayStr();
  for(let c=0;c<53;c++){
    const col=document.createElement('div'); col.className='heatmap-col';
    for(let r=0;r<7;r++){
      const d=new Date(colDate); d.setDate(d.getDate()+r);
      const ds=localDateStr(d); // FIX #13: local date
      const count=(userState.heatmap||{})[ds]||0;
      const cell=document.createElement('div'); cell.className='heatmap-cell';
      if(count>=4) cell.classList.add('l4'); else if(count===3) cell.classList.add('l3'); else if(count===2) cell.classList.add('l2'); else if(count===1) cell.classList.add('l1');
      if(ds===todayLocal) cell.classList.add('today');
      cell.title=ds+(count?` ‚Äî ${count} session${count>1?'s':''}`:'');
      // Capture ds in closure
      cell.onclick=(function(dateStr){return function(){userState.heatmap[dateStr]=(userState.heatmap[dateStr]||0)+1;saveState();renderHeatmap();};})(ds);
      col.appendChild(cell);
      const m=d.getMonth(); if(m!==lastMonth&&r===0){monthSpans.push({col:c,label:months[m]});lastMonth=m;}
    }
    colDate.setDate(colDate.getDate()+7); cols.appendChild(col);
  }
  monthsEl.innerHTML=monthSpans.map((ms,i)=>{
    const gap=i<monthSpans.length-1?(monthSpans[i+1].col-ms.col)*16:50;
    return`<div class="month-label" style="min-width:${gap}px">${ms.label}</div>`;
  }).join('');
}

function renderDueList() {
  const todayD=new Date();
  const due=userState.surahs.filter(s=>{
    if(s.status!=='memorised'&&s.status!=='revision') return false;
    if(!s.lastRevised) return true;
    return(todayD-new Date(s.lastRevised))/(86400000)>=7;
  });
  const el=document.getElementById('dueList');
  if(!due.length){el.innerHTML='<div class="empty-state"><div class="empty-icon">‚úÖ</div><p>All caught up! No surahs overdue.</p></div>';return;}
  el.innerHTML=due.map(s=>{
    const days=!s.lastRevised?'Never revised':`${Math.round((new Date()-new Date(s.lastRevised))/86400000)}d ago`;
    return`<div class="due-item"><div><div style="font-size:13px;font-weight:600">${s.n}. ${esc(s.en)} <span style="font-family:var(--arabic);color:var(--gold)">${esc(s.ar)}</span></div><div style="font-size:11px;color:var(--text3);margin-top:2px">${STATUS_LABELS[s.status]}</div></div><div style="font-size:12px;color:var(--red);font-weight:600">‚ö†Ô∏è ${days}</div></div>`;
  }).join('');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// GOALS ‚Äî FIX #11: safer goal find
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderGoals() {
  const {m,mg,r}=getStats();
  const mm={'memorised':m,'memorising':mg,'revision':r};
  document.getElementById('goalsGrid').innerHTML=userState.goals.map(g=>{
    const cur=mm[g.metric]||0,pct=Math.min(100,Math.round(cur/g.target*100));
    const dl=g.deadline?`üóìÔ∏è ${new Date(g.deadline).toLocaleDateString('en-GB',{day:'numeric',month:'short',year:'numeric'})}`:'üóìÔ∏è No deadline set';
    return`<div class="goal-card">
      <div style="display:flex;justify-content:space-between;align-items:center"><div style="font-size:15px;font-weight:600">${esc(g.title)}</div><button class="btn btn-sm btn-secondary" onclick="openGoalModal(${g.id})">‚úèÔ∏è Edit</button></div>
      <div class="goal-nums"><div class="goal-current">${cur}</div><div class="goal-sep">/</div><div class="goal-target">${g.target}</div></div>
      <div style="font-size:12px;color:var(--text3);margin-bottom:6px">${g.metric==='memorised'?'surahs memorised':g.metric==='revision'?'in revision':'memorising'}</div>
      <div class="goal-bar"><div class="goal-bar-fill" style="width:${pct}%"></div></div>
      <div style="display:flex;justify-content:space-between"><div style="font-size:12px;color:var(--text3)">${dl}</div><div style="font-size:12px;font-weight:600;color:${pct>=100?'var(--green)':'var(--teal)'}">${pct}%${pct>=100?' üéâ':''}</div></div>
    </div>`;
  }).join('');
}

function openGoalModal(id) {
  editGoalId=id;
  // FIX #11: use == for flexible matching in case of type mismatch
  const g=userState.goals.find(x=>x.id==id);
  if(!g) return;
  document.getElementById('goalTitle').value=g.title;
  document.getElementById('goalTarget').value=g.target;
  document.getElementById('goalDeadline').value=g.deadline||'';
  document.getElementById('goalModal').classList.add('open');
}
function closeGoalModal(){document.getElementById('goalModal').classList.remove('open');}
async function saveGoal(){
  const g=userState.goals.find(x=>x.id==editGoalId);
  if(!g) return;
  g.title=document.getElementById('goalTitle').value;
  g.target=parseInt(document.getElementById('goalTarget').value)||g.target;
  g.deadline=document.getElementById('goalDeadline').value;
  logActivity('üéØ',`Goal updated: ${g.title}`,`Target: ${g.target}`);
  await saveState(); closeGoalModal(); renderGoals();
}
document.getElementById('goalModal').addEventListener('click',e=>{if(e.target===e.currentTarget)closeGoalModal();});

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// HISTORY
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function logActivity(icon,action,detail){
  if(!userState.history) userState.history=[];
  userState.history.unshift({icon,action,detail,ts:new Date().toISOString()});
  if(userState.history.length>200) userState.history=userState.history.slice(0,200);
}

function renderHistory(){
  const el=document.getElementById('historyList');
  if(!userState.history?.length){el.innerHTML='<div class="empty-state"><div class="empty-icon">üìú</div><p>No activity yet. Start by updating a surah!</p></div>';return;}
  el.innerHTML=userState.history.map(h=>{
    const d=new Date(h.ts),now=new Date();
    const mins=Math.floor((now-d)/60000),hrs=Math.floor((now-d)/3600000),days=Math.floor((now-d)/86400000);
    const t=mins<1?'Just now':mins<60?mins+'m ago':hrs<24?hrs+'h ago':days===1?'Yesterday':days+'d ago';
    return`<div class="history-item"><div class="history-icon">${h.icon}</div><div class="history-content"><div class="history-action">${esc(h.action)}</div><div class="history-detail">${esc(h.detail)}</div></div><div class="history-time">${t}</div></div>`;
  }).join('');
}

async function clearHistory(){
  if(!confirm('Clear all activity history?')) return;
  userState.history=[]; await saveState(); renderHistory();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CONNECT TAB (STUDENT) ‚Äî FIX #1: fn() calls
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function renderConnectTab() {
  const freshSnap=await fn().getDoc(fn().doc(db(),'users',currentUser.uid));
  if(freshSnap.exists()) userProfile=freshSnap.data();
  const el=document.getElementById('connectContent');
  const inviteLink=`${window.location.origin}${window.location.pathname}?invite=${userProfile.inviteToken}`;
  el.innerHTML=`
    <div class="card" style="margin-bottom:16px">
      <div class="card-title">üë®‚Äçüë©‚Äçüëß Share with Parents</div>
      <p style="font-size:13px;color:var(--text2);margin-bottom:12px">Send this link to your parents so they can link to your account and view your progress.</p>
      <div class="invite-box">
        <div style="font-size:12px;color:var(--text3);margin-bottom:6px">Your invite link:</div>
        <code class="invite-link">${esc(inviteLink)}</code>
        <div class="invite-actions">
          <button class="btn btn-sm btn-primary" style="width:auto;margin:0" onclick="copyText('${inviteLink}')">üìã Copy Link</button>
          <button class="btn btn-sm btn-secondary" onclick="shareInviteLink('${inviteLink}')">üì§ Share</button>
        </div>
      </div>
    </div>
    <div class="card" style="margin-bottom:16px">
      <div class="card-title">üë®‚Äçüë©‚Äçüëß Linked Parents</div>
      <div id="linkedParentsInfo"></div>
    </div>
    <div class="card">
      <div class="card-title">üë©‚Äçüè´ Linked Teacher</div>
      <div id="linkedTeacherInfo"></div>
    </div>`;
  loadLinkedParentsInfo();
  loadLinkedTeacherInfo();
}

function copyText(text) {
  navigator.clipboard.writeText(text).then(()=>showToast('üìã','Copied!','Link copied to clipboard'));
}

async function loadLinkedParentsInfo() {
  const el=document.getElementById('linkedParentsInfo');
  if(!el) return;
  const parents=userProfile.linkedParents||[];
  if(!parents.length){
    el.innerHTML=`<div class="empty-state" style="padding:16px"><div class="empty-icon" style="font-size:28px">üë®‚Äçüë©‚Äçüëß</div><p>No parents linked yet. Share your invite link above with your parents.</p></div>`;
    return;
  }
  let html='';
  for(const uid of parents){
    const snap=await fn().getDoc(fn().doc(db(),'users',uid));
    if(!snap.exists()) continue;
    const p=snap.data();
    html+=`<div style="display:flex;align-items:center;gap:12px;padding:10px;background:rgba(81,187,37,0.06);border-radius:12px;margin-bottom:8px">
      <div class="student-avatar" style="width:34px;height:34px;font-size:13px;background:linear-gradient(135deg,#51bb25,#7dd356)">${esc((p.name||'P')[0])}</div>
      <div><div style="font-size:13px;font-weight:600">${esc(p.name)}</div><div style="font-size:11px;color:var(--text3)">${esc(p.email)}</div></div>
      <div style="margin-left:auto;font-size:11px;color:var(--green);font-weight:600">‚úì Linked</div>
    </div>`;
  }
  el.innerHTML=html;
}

async function loadLinkedTeacherInfo() {
  const el=document.getElementById('linkedTeacherInfo');
  if(!el) return;
  if(userProfile.linkedTeacher){
    const snap=await fn().getDoc(fn().doc(db(),'users',userProfile.linkedTeacher));
    if(snap.exists()){
      const t=snap.data();
      el.innerHTML=`<div style="display:flex;align-items:center;gap:12px;padding:12px;background:rgba(115,102,255,0.05);border-radius:12px"><div class="student-avatar" style="width:36px;height:36px;font-size:14px">${esc((t.name||'T')[0])}</div><div><div style="font-size:13px;font-weight:600">${esc(t.name)}</div><div style="font-size:11px;color:var(--text3)">${esc(t.email)}</div></div></div>`;
    }
  } else {
    el.innerHTML=`<div class="empty-state" style="padding:20px"><div class="empty-icon">üë©‚Äçüè´</div><p>Not yet linked to a class. Ask your teacher for their class code when signing up.</p></div>`;
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// INVITE HANDLING ‚Äî FIX #2/#17: use fn().arrayUnion properly
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function handleInviteFromURL(token) {
  const q=fn().query(fn().collection(db(),'users'), fn().where('inviteToken','==',token));
  const snap=await fn().getDocs(q);
  if(snap.empty) return;
  const invitedUser=snap.docs[0].data();
  const role=userProfile?.role;
  if(!role) return;

  if(role==='parent'&&invitedUser.role==='student'){
    const childUid=invitedUser.uid;
    if(!(userProfile.linkedChildren||[]).includes(childUid)){
      // FIX #2/#17: use real arrayUnion
      await fn().updateDoc(fn().doc(db(),'users',currentUser.uid),{linkedChildren: fn().arrayUnion(childUid)});
      await fn().updateDoc(fn().doc(db(),'users',childUid),{linkedParents: fn().arrayUnion(currentUser.uid)});
      userProfile.linkedChildren=[...(userProfile.linkedChildren||[]),childUid];
      showToast('üîó',`Linked to ${esc(invitedUser.name)}!`,'You can now view their progress');
    }
  } else if(role==='student'&&invitedUser.role==='parent'){
    const parentUid=invitedUser.uid;
    if(!(userProfile.linkedParents||[]).includes(parentUid)){
      await fn().updateDoc(fn().doc(db(),'users',currentUser.uid),{linkedParents: fn().arrayUnion(parentUid)});
      await fn().updateDoc(fn().doc(db(),'users',parentUid),{linkedChildren: fn().arrayUnion(currentUser.uid)});
      userProfile.linkedParents=[...(userProfile.linkedParents||[]),parentUid];
      showToast('üîó',`Linked to ${esc(invitedUser.name)}!`,'They can now view your progress');
    }
  }
  window.history.replaceState({},'',window.location.pathname);
}

function copyInviteLink() {
  const inviteLink=`${window.location.origin}${window.location.pathname}?invite=${userProfile.inviteToken}`;
  navigator.clipboard.writeText(inviteLink).then(()=>showToast('üìã','Copied!','Share this link with parents or children'));
  closeHeaderDropdown();
}

function shareInviteLink(link) {
  if(navigator.share){navigator.share({title:'Quran Tracker Invite',url:link});}
  else{navigator.clipboard.writeText(link).then(()=>showToast('üìã','Copied!',''));}
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// TEACHER DASHBOARD ‚Äî FIX #1/#8: fn() calls + XSS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let teacherSubTab='students';
let compareChart2=null;

function setTeacherSubTab(tab,btn){
  teacherSubTab=tab;
  document.querySelectorAll('.pill-tab').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
  document.getElementById('teacherStudentsPane').style.display=tab==='students'?'':'none';
  document.getElementById('teacherAlertsPane').style.display=tab==='alerts'?'':'none';
  document.getElementById('teacherComparePane').style.display=tab==='compare'?'':'none';
  if(tab==='compare') renderCompareChart();
}

async function renderTeacherOverview() {
  const grid=document.getElementById('classOverviewGrid');
  const todayBar=document.getElementById('revisedTodayBar');
  grid.innerHTML='<div style="color:var(--text3);font-size:13px;padding:20px">Loading students‚Ä¶</div>';

  const freshSnap=await fn().getDoc(fn().doc(db(),'users',currentUser.uid));
  if(freshSnap.exists()) userProfile=freshSnap.data();

  const students=userProfile.students||[];
  if(!students.length){
    grid.innerHTML='<div class="empty-state"><div class="empty-icon">üë•</div><p>No students yet. Share your class code to invite students.</p></div>';
    todayBar.innerHTML='';
    return;
  }

  const today=todayStr();
  const studentData=[];
  for(const uid of students){
    const snap=await fn().getDoc(fn().doc(db(),'users',uid));
    if(!snap.exists()) continue;
    const profile=snap.data();
    const stateSnap=await fn().getDoc(fn().doc(db(),'users',uid,'data','state'));
    const st=stateSnap.exists()?stateSnap.data():freshState();
    studentData.push({uid,profile,st});
  }

  window._teacherStudentData=studentData;

  let revisedToday=0;
  grid.innerHTML=studentData.map(({uid,profile,st})=>{
    const s=st.surahs||freshState().surahs;
    const m=s.filter(x=>x.status==='memorised').length;
    const mg=s.filter(x=>x.status==='memorising').length;
    const r=s.filter(x=>x.status==='revision').length;
    const pct=Math.round(m/114*100);
    const didRevise=st.heatmap&&st.heatmap[today];
    if(didRevise) revisedToday++;
    return`<div class="student-card" onclick="openStudentDetail('${esc(uid)}')">
      <div class="student-card-header">
        <div class="student-avatar">${esc((profile.name||'S')[0].toUpperCase())}</div>
        <div><div class="student-name">${esc(profile.name)}</div><div class="student-email">${esc(profile.email)}</div></div>
        <div class="revised-today-dot ${didRevise?'yes':'no'}" title="${didRevise?'Revised today':'Not yet today'}" style="margin-left:auto"></div>
      </div>
      <div class="student-mini-stats">
        <div class="mini-stat m">‚úÖ ${m}</div>
        <div class="mini-stat mg">üìù ${mg}</div>
        <div class="mini-stat r">üîÑ ${r}</div>
      </div>
      <div class="student-progress-bar"><div class="student-progress-fill" style="width:${pct}%"></div></div>
      <div style="font-size:11px;color:var(--text3);margin-top:6px">${pct}% memorised</div>
    </div>`;
  }).join('');

  todayBar.innerHTML=`
    <div style="font-size:13px;font-weight:600">Today's Revision</div>
    <div style="display:flex;align-items:center;gap:6px"><div class="revised-today-dot yes"></div><span style="font-size:13px;color:var(--text2)">${revisedToday} revised</span></div>
    <div style="display:flex;align-items:center;gap:6px"><div class="revised-today-dot no"></div><span style="font-size:13px;color:var(--text2)">${students.length-revisedToday} not yet</span></div>`;

  renderTeacherAlerts(studentData);
}

function renderTeacherAlerts(studentData) {
  const todayD=new Date();
  const el=document.getElementById('alertsList');
  let html='';
  (studentData||window._teacherStudentData||[]).forEach(({profile,st})=>{
    const s=st.surahs||[];
    s.filter(x=>(x.status==='memorised'||x.status==='revision')&&(!x.lastRevised||(todayD-new Date(x.lastRevised))/86400000>=7)).forEach(x=>{
      const days=!x.lastRevised?'Never revised':`${Math.round((todayD-new Date(x.lastRevised))/86400000)}d ago`;
      html+=`<div class="alert-card" style="margin-bottom:10px">
        <div class="alert-info">
          <div class="alert-name">${esc(profile.name)} ‚Äî ${esc(x.en)} <span style="font-family:var(--arabic);color:var(--gold)">${esc(x.ar)}</span></div>
          <div class="alert-detail">${STATUS_LABELS[x.status]}</div>
        </div>
        <div class="alert-days">‚ö†Ô∏è ${days}</div>
      </div>`;
    });
  });
  el.innerHTML=html||'<div class="empty-state"><div class="empty-icon">‚úÖ</div><p>No overdue revisions!</p></div>';
}

function renderCompareChart(){
  const data=window._teacherStudentData||[];
  if(!data.length) return;
  const labels=data.map(d=>d.profile.name);
  const vals=data.map(d=>(d.st.surahs||[]).filter(x=>x.status==='memorised').length);
  const canvas=document.getElementById('compareChart');
  if(compareChart2) compareChart2.destroy();
  compareChart2=new Chart(canvas.getContext('2d'),{
    type:'bar',
    data:{labels,datasets:[{label:'Memorised Surahs',data:vals,backgroundColor:'#7366ff',borderRadius:8}]},
    options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false},tooltip:{backgroundColor:'#fff',borderColor:'#e6e9f4',borderWidth:1,titleColor:'#2c323f',bodyColor:'#6c757d',padding:12,cornerRadius:8}},scales:{y:{beginAtZero:true,max:114,ticks:{color:'#98a2b3'},grid:{color:'rgba(230,233,244,0.8)'}},x:{ticks:{color:'#98a2b3'},grid:{display:false}}}}
  });
}

function openStudentDetail(uid) {
  const data=(window._teacherStudentData||[]).find(d=>d.uid===uid);
  if(!data) return;
  const {profile,st}=data;
  const s=st.surahs||[];
  const m=s.filter(x=>x.status==='memorised').length;
  const mg=s.filter(x=>x.status==='memorising').length;
  const r=s.filter(x=>x.status==='revision').length;
  const pct=Math.round(m/114*100);
  document.getElementById('sdmTitle').textContent=profile.name+"'s Progress";
  document.getElementById('sdmContent').innerHTML=`
    <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin-bottom:16px">
      <div style="text-align:center;background:rgba(81,187,37,0.08);border-radius:10px;padding:12px"><div style="font-size:22px;font-weight:700;color:var(--green)">${m}</div><div style="font-size:11px;color:var(--text3)">Memorised</div></div>
      <div style="text-align:center;background:rgba(38,151,243,0.08);border-radius:10px;padding:12px"><div style="font-size:22px;font-weight:700;color:var(--blue)">${mg}</div><div style="font-size:11px;color:var(--text3)">Memorising</div></div>
      <div style="text-align:center;background:rgba(244,165,58,0.08);border-radius:10px;padding:12px"><div style="font-size:22px;font-weight:700;color:var(--amber)">${r}</div><div style="font-size:11px;color:var(--text3)">Revision</div></div>
      <div style="text-align:center;background:rgba(115,102,255,0.08);border-radius:10px;padding:12px"><div style="font-size:22px;font-weight:700;color:var(--teal)">${pct}%</div><div style="font-size:11px;color:var(--text3)">Complete</div></div>
    </div>
    <div style="font-size:12px;font-weight:600;color:var(--text3);text-transform:uppercase;letter-spacing:0.4px;margin-bottom:8px">Recent Activity</div>
    <div style="max-height:200px;overflow-y:auto">${(st.history||[]).slice(0,10).map(h=>`<div style="display:flex;gap:10px;padding:8px 0;border-bottom:1px solid var(--border)"><span>${h.icon}</span><div><div style="font-size:12px;font-weight:500">${esc(h.action)}</div><div style="font-size:11px;color:var(--text3)">${esc(h.detail)}</div></div></div>`).join('')||'<div style="font-size:13px;color:var(--text3);padding:10px 0">No activity yet</div>'}</div>`;
  document.getElementById('studentDetailModal').classList.add('open');
}
function closeStudentModal(){document.getElementById('studentDetailModal').classList.remove('open');}
document.getElementById('studentDetailModal').addEventListener('click',e=>{if(e.target===e.currentTarget)closeStudentModal();});

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// TEACHER MESSAGES ‚Äî FIX #5: filter properly by parent
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function renderTeacherMessages() {
  const el=document.getElementById('teacherMessagesContent');
  try {
    const messagesRef=fn().collection(db(),'messages');
    const q=fn().query(messagesRef, fn().where('teacherId','==',currentUser.uid), fn().orderBy('createdAt','asc'));
    const snap=await fn().getDocs(q);

    const threads={};
    snap.forEach(d=>{
      const m={id:d.id,...d.data()};
      // FIX #5: Group by the OTHER party (parent), not just sender
      const parentId = m.fromParent ? m.senderId : m.recipientId;
      if(!threads[parentId]) threads[parentId]=[];
      threads[parentId].push(m);
    });

    if(!Object.keys(threads).length){
      el.innerHTML=`<div class="card"><div class="empty-state"><div class="empty-icon">üí¨</div><p>No messages yet from parents.</p></div></div>`;
      return;
    }

    const threadIds=Object.keys(threads);
    el.innerHTML='';

    for(const parentId of threadIds){
      const pSnap=await fn().getDoc(fn().doc(db(),'users',parentId));
      const pName=pSnap.exists()?pSnap.data().name:'Parent';
      const msgs=threads[parentId];
      const div=document.createElement('div');
      div.className='card'; div.style.marginBottom='16px';
      div.innerHTML=`
        <div class="card-title">üí¨ ${esc(pName)}</div>
        <div class="message-thread" id="thread-${esc(parentId)}">
          ${msgs.map(m=>`<div class="message-bubble ${m.fromParent?'received':'sent'}">${esc(m.text)}<div class="message-meta">${new Date(m.createdAt?.toDate?m.createdAt.toDate():m.createdAt).toLocaleTimeString('en-GB',{hour:'2-digit',minute:'2-digit'})}</div></div>`).join('')}
        </div>
        <div class="message-compose">
          <input type="text" placeholder="Reply to ${esc(pName)}‚Ä¶" id="reply-${parentId}" onkeydown="if(event.key==='Enter')sendTeacherReply('${esc(parentId)}')">
          <button class="btn btn-primary btn-sm" style="width:auto;margin:0" onclick="sendTeacherReply('${esc(parentId)}')">Send</button>
        </div>`;
      el.appendChild(div);
    }
  } catch(e) {
    // FIX #16: Handle missing composite index gracefully
    console.error('Messages query error (may need composite index):', e);
    el.innerHTML=`<div class="card"><div class="empty-state"><div class="empty-icon">‚ö†Ô∏è</div><p>Could not load messages. If this is the first time, a Firestore index may need to be created. Check the browser console for a link to create it.</p></div></div>`;
  }
}

async function sendTeacherReply(parentId) {
  const input=document.getElementById('reply-'+parentId);
  const text=input.value.trim(); if(!text) return;
  await fn().addDoc(fn().collection(db(),'messages'),{
    teacherId:currentUser.uid,senderId:currentUser.uid,recipientId:parentId,
    text,fromParent:false,createdAt:fn().serverTimestamp()
  });
  input.value='';
  renderTeacherMessages();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// TEACHER INVITE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function renderTeacherInvite() {
  const freshSnap=await fn().getDoc(fn().doc(db(),'users',currentUser.uid));
  if(freshSnap.exists()) userProfile=freshSnap.data();
  const classLink=`${window.location.origin}${window.location.pathname}?invite=${userProfile.inviteToken}`;
  const el=document.getElementById('teacherInviteContent');
  const students=userProfile.students||[];
  el.innerHTML=`
    <div class="card" style="margin-bottom:16px">
      <div class="card-title">üîó Your Class Invite Link</div>
      <p style="font-size:13px;color:var(--text2);margin-bottom:12px">Share this link or code with students so they can join your class when signing up.</p>
      <div class="invite-box">
        <div style="font-size:12px;color:var(--text3);margin-bottom:4px">Class invite link:</div>
        <code class="invite-link">${esc(classLink)}</code>
        <div style="font-size:12px;color:var(--text3);margin:8px 0 4px">Or share just the code:</div>
        <code class="invite-link" style="font-size:14px;font-weight:700;letter-spacing:2px">${esc(userProfile.inviteToken)}</code>
        <div class="invite-actions">
          <button class="btn btn-sm btn-primary" style="width:auto;margin:0" onclick="copyText('${classLink}')">üìã Copy Link</button>
          <button class="btn btn-sm btn-secondary" onclick="copyText('${userProfile.inviteToken}')">Copy Code Only</button>
        </div>
      </div>
    </div>
    <div class="card">
      <div class="card-title">üë• Enrolled Students (${students.length})</div>
      <div id="enrolledStudentsList"></div>
    </div>`;
  loadEnrolledStudents();
}

async function loadEnrolledStudents() {
  const el=document.getElementById('enrolledStudentsList');
  if(!el) return;
  const students=userProfile.students||[];
  if(!students.length){el.innerHTML='<div class="empty-state" style="padding:20px"><div class="empty-icon">üë•</div><p>No students enrolled yet.</p></div>';return;}
  let html='';
  for(const uid of students){
    const snap=await fn().getDoc(fn().doc(db(),'users',uid));
    if(!snap.exists()) continue;
    const p=snap.data();
    html+=`<div style="display:flex;align-items:center;gap:12px;padding:10px 0;border-bottom:1px solid var(--border)">
      <div class="student-avatar" style="width:34px;height:34px;font-size:13px">${esc((p.name||'S')[0])}</div>
      <div style="flex:1"><div style="font-size:13px;font-weight:600">${esc(p.name)}</div><div style="font-size:11px;color:var(--text3)">${esc(p.email)}</div></div>
    </div>`;
  }
  el.innerHTML=html;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// PARENT DASHBOARD
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function renderParentChildren() {
  const el=document.getElementById('parentChildrenContent');
  const freshSnap=await fn().getDoc(fn().doc(db(),'users',currentUser.uid));
  if(freshSnap.exists()) userProfile=freshSnap.data();
  const children=userProfile.linkedChildren||[];
  if(!children.length){
    el.innerHTML=`<div class="card"><div class="empty-state"><div class="empty-icon">üë¶</div><p>No children linked yet. Go to "Link a Child" to connect to your child's account.</p></div></div>`;
    return;
  }
  el.innerHTML='<div class="children-grid" id="childrenGrid"></div>';
  const grid=document.getElementById('childrenGrid');
  for(const uid of children){
    const snap=await fn().getDoc(fn().doc(db(),'users',uid));
    if(!snap.exists()) continue;
    const p=snap.data();
    const stSnap=await fn().getDoc(fn().doc(db(),'users',uid,'data','state'));
    const st=stSnap.exists()?stSnap.data():freshState();
    const s=st.surahs||[];
    const m=s.filter(x=>x.status==='memorised').length;
    const mg=s.filter(x=>x.status==='memorising').length;
    const pct=Math.round(m/114*100);
    const streak=calcStreakFromHeatmap(st.heatmap||{});
    const todayD=new Date();
    const due=s.filter(x=>(x.status==='memorised'||x.status==='revision')&&(!x.lastRevised||(todayD-new Date(x.lastRevised))/86400000>=7));
    const div=document.createElement('div');
    div.className='child-card';
    div.innerHTML=`
      <div class="child-header">
        <div class="child-avatar">${esc((p.name||'S')[0])}</div>
        <div><div style="font-size:16px;font-weight:700">${esc(p.name)}</div><div style="font-size:12px;color:var(--text3)">${esc(p.email)}</div></div>
      </div>
      <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:14px">
        <div style="text-align:center;background:rgba(81,187,37,0.08);border-radius:10px;padding:10px"><div style="font-size:20px;font-weight:700;color:var(--green)">${m}</div><div style="font-size:10px;color:var(--text3)">Memorised</div></div>
        <div style="text-align:center;background:rgba(38,151,243,0.08);border-radius:10px;padding:10px"><div style="font-size:20px;font-weight:700;color:var(--blue)">${mg}</div><div style="font-size:10px;color:var(--text3)">Memorising</div></div>
        <div style="text-align:center;background:rgba(247,49,100,0.06);border-radius:10px;padding:10px"><div style="font-size:20px;font-weight:700;color:var(--red)">${streak}</div><div style="font-size:10px;color:var(--text3)">Day Streak</div></div>
      </div>
      <div style="margin-bottom:10px">
        <div style="display:flex;justify-content:space-between;font-size:12px;color:var(--text3);margin-bottom:4px"><span>Overall Progress</span><span>${pct}%</span></div>
        <div class="goal-bar"><div class="goal-bar-fill" style="width:${pct}%"></div></div>
      </div>
      ${due.length?`<div style="background:rgba(247,49,100,0.05);border:1px solid rgba(247,49,100,0.12);border-radius:10px;padding:10px;font-size:12px;color:var(--red)">‚ö†Ô∏è ${due.length} surah${due.length>1?'s':''} overdue for revision</div>`:'<div style="font-size:12px;color:var(--green)">‚úÖ All revisions up to date</div>'}`;
    grid.appendChild(div);
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// PARENT MESSAGES ‚Äî FIX #5: improved query
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function renderParentMessages() {
  const el=document.getElementById('parentMessagesContent');
  const children=userProfile.linkedChildren||[];
  let teacherId=null;
  if(children.length){
    const childSnap=await fn().getDoc(fn().doc(db(),'users',children[0]));
    if(childSnap.exists()) teacherId=childSnap.data().linkedTeacher;
  }

  if(!teacherId){
    el.innerHTML=`<div class="card"><div class="empty-state"><div class="empty-icon">üë©‚Äçüè´</div><p>No teacher linked yet. Link a child first to message their teacher.</p></div></div>`;
    return;
  }

  try {
    // FIX #5: Query all messages for this teacher, then filter client-side for this parent
    const q=fn().query(fn().collection(db(),'messages'), fn().where('teacherId','==',teacherId), fn().orderBy('createdAt','asc'));
    const snap=await fn().getDocs(q);
    const msgs=[];
    snap.forEach(d=>msgs.push({id:d.id,...d.data()}));
    // FIX #5: Only show messages where this parent is sender OR recipient
    const filtered=msgs.filter(m=>m.senderId===currentUser.uid||m.recipientId===currentUser.uid);

    el.innerHTML=`
      <div class="card">
        <div class="card-title">üí¨ Message to Teacher</div>
        <div class="message-thread" id="parentThread">
          ${filtered.map(m=>`<div class="message-bubble ${m.senderId===currentUser.uid?'sent':'received'}">${esc(m.text)}<div class="message-meta">${new Date(m.createdAt?.toDate?m.createdAt.toDate():m.createdAt).toLocaleTimeString('en-GB',{hour:'2-digit',minute:'2-digit'})}</div></div>`).join('')||'<div style="text-align:center;color:var(--text3);font-size:13px;padding:20px">No messages yet. Start the conversation!</div>'}
        </div>
        <div class="message-compose">
          <input type="text" placeholder="Type a message‚Ä¶" id="parentMsgInput" onkeydown="if(event.key==='Enter')sendParentMessage('${esc(teacherId)}')">
          <button class="btn btn-primary btn-sm" style="width:auto;margin:0" onclick="sendParentMessage('${esc(teacherId)}')">Send</button>
        </div>
      </div>`;
    const thread=document.getElementById('parentThread');
    if(thread) setTimeout(()=>thread.scrollTop=thread.scrollHeight,100);
  } catch(e) {
    console.error('Parent messages query error (may need composite index):', e);
    el.innerHTML=`<div class="card"><div class="empty-state"><div class="empty-icon">‚ö†Ô∏è</div><p>Could not load messages. A Firestore composite index may be needed. Check browser console for details.</p></div></div>`;
  }
}

async function sendParentMessage(teacherId){
  const input=document.getElementById('parentMsgInput');
  const text=input.value.trim(); if(!text) return;
  await fn().addDoc(fn().collection(db(),'messages'),{
    teacherId,senderId:currentUser.uid,recipientId:teacherId,
    text,fromParent:true,createdAt:fn().serverTimestamp()
  });
  input.value='';
  renderParentMessages();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// PARENT CONNECT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function renderParentConnect(){
  const freshSnap=await fn().getDoc(fn().doc(db(),'users',currentUser.uid));
  if(freshSnap.exists()) userProfile=freshSnap.data();
  const el=document.getElementById('parentConnectContent');
  const myLink=`${window.location.origin}${window.location.pathname}?invite=${userProfile.inviteToken}`;
  el.innerHTML=`
    <div class="card" style="margin-bottom:16px">
      <div class="card-title">Option 1 ‚Äî Share YOUR link with your child</div>
      <p style="font-size:13px;color:var(--text2);margin-bottom:12px">Your child opens this link while signed in to link themselves to your account.</p>
      <div class="invite-box">
        <code class="invite-link">${esc(myLink)}</code>
        <div class="invite-actions">
          <button class="btn btn-sm btn-primary" style="width:auto;margin:0" onclick="copyText('${myLink}')">üìã Copy</button>
          <button class="btn btn-sm btn-secondary" onclick="shareInviteLink('${myLink}')">üì§ Share</button>
        </div>
      </div>
    </div>
    <div class="card">
      <div class="card-title">Option 2 ‚Äî Paste your child's invite link</div>
      <p style="font-size:13px;color:var(--text2);margin-bottom:12px">Ask your child to copy their invite link and paste it below.</p>
      <div style="display:flex;gap:10px">
        <input type="text" class="form-input" id="childLinkInput" placeholder="Paste child's invite link here‚Ä¶" style="flex:1">
        <button class="btn btn-primary" style="width:auto;margin:0" onclick="linkChildFromPaste()">Link</button>
      </div>
    </div>`;
}

async function linkChildFromPaste(){
  const val=document.getElementById('childLinkInput').value.trim();
  const match=val.match(/invite=([^&\s]+)/);
  if(!match){showToast('‚ùå','Invalid link','Please paste a valid invite link');return;}
  await handleInviteFromURL(match[1]);
  renderParentConnect();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SURAH VIEWER ‚Äî FIX #15: stale fetch protection
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function openSurahViewer(num){
  const sd=SURAHS.find(s=>s.n===num); if(!sd) return;
  document.getElementById('svArabic').textContent=sd.ar;
  document.getElementById('svTranslit').textContent=SURAH_TRANSLIT[num]||sd.en;
  document.getElementById('svMeaning').textContent=SURAH_MEANING[num]?`"${SURAH_MEANING[num]}"`:'' ;
  const myS=userState.surahs.find(s=>s.n===num);
  document.getElementById('svChips').innerHTML=`<div class="sv-chip">Surah ${num}</div><div class="sv-chip">${sd.v} Ayahs</div><div class="sv-chip">Juz ${sd.juz}</div><div class="sv-chip">${SURAH_PLACE[num]||''}</div><div class="sv-chip">${STATUS_LABELS[myS?.status||'not-started']}</div>`;
  document.getElementById('svBismillah').style.display=num===9?'none':'block';
  verseMode='arabic';
  document.getElementById('btnArabicOnly').classList.add('active');
  document.getElementById('btnWithTrans').classList.remove('active');
  document.getElementById('svOverlay').classList.add('open');
  document.getElementById('svVerses').innerHTML=`<div class="sv-loading"><div class="sv-spinner"></div>Loading ${esc(sd.en)}‚Ä¶</div>`;

  // FIX #15: Track fetch ID to prevent stale responses
  const fetchId = ++currentSurahFetchId;

  try {
    if(verseCache[num]){renderVerses(verseCache[num]);return;}
    // Multi-edition endpoint: Uthmani script + Sahih International in one request
    const res = await fetch(`https://api.alquran.cloud/v1/surah/${num}/editions/quran-uthmani,en.sahih`);
    if (fetchId !== currentSurahFetchId) return;
    if(!res.ok) throw new Error('API request failed');
    const json = await res.json();
    if(json.code !== 200 || !json.data || json.data.length < 2) throw new Error('Unexpected response');
    const arAyahs = json.data[0].ayahs;   // Uthmani Arabic
    const enAyahs = json.data[1].ayahs;   // English translation

    // Robust Bismillah stripping for verse 1 of surahs 2‚Äì113
    // (Surah 1: Bismillah IS verse 1; Surah 9: no Bismillah)
    // The API embeds Bismillah into verse 1 text. We strip it since
    // it's already shown separately in the sv-bismillah banner.
    // Instead of fragile regex, we detect the Bismillah by looking for
    // "ÿßŸÑÿ±ÿ≠ŸäŸÖ" (stripped of diacritics) which ends the Bismillah phrase.
    function stripBismillah(text) {
      // Remove all diacritics (tashkeel) for matching purposes
      const stripped = text.replace(/[\u0610-\u061A\u064B-\u065F\u0670\u06D6-\u06DC\u06DF-\u06E4\u06E7\u06E8\u06EA-\u06ED]/g, '');
      // Find "ÿßŸÑÿ±ÿ≠ŸäŸÖ" (end of Bismillah) in diacritics-stripped version
      const marker = 'ÿßŸÑÿ±ÿ≠ŸäŸÖ';
      const idx = stripped.indexOf(marker);
      if (idx === -1) return text; // not found, return as-is
      // Map position back to original text: count non-diacritic chars
      let origIdx = 0, count = 0;
      for (origIdx = 0; origIdx < text.length; origIdx++) {
        const c = text.charCodeAt(origIdx);
        const isDiacritic = (c >= 0x0610 && c <= 0x061A) || (c >= 0x064B && c <= 0x065F) || c === 0x0670 || (c >= 0x06D6 && c <= 0x06DC) || (c >= 0x06DF && c <= 0x06E4) || c === 0x06E7 || c === 0x06E8 || (c >= 0x06EA && c <= 0x06ED);
        if (!isDiacritic) count++;
        if (count === idx + marker.length) { origIdx++; break; }
      }
      // Skip any whitespace after the Bismillah
      while (origIdx < text.length && /\s/.test(text[origIdx])) origIdx++;
      const result = text.substring(origIdx);
      return result || text; // fallback to full text if stripping removed everything
    }

    verseCache[num] = arAyahs.map((a, i) => {
      let arText = a.text;
      let enText = (enAyahs[i] && enAyahs[i].text) || '';
      if (i === 0 && num !== 1 && num !== 9) {
        arText = stripBismillah(arText);
        // English: strip "In the name of..." prefix
        enText = enText.replace(/^In\s+the\s+name\s+of\s+Allah[\s\S]*?(?:Merciful|Mercy)[.,;:!?\-‚Äì‚Äî]*\s*/i, '').trim();
        // Capitalize first letter after stripping
        if (enText) enText = enText.charAt(0).toUpperCase() + enText.slice(1);
      }
      return { numberInSurah: a.numberInSurah, text: arText, translation: enText };
    });
    if (fetchId !== currentSurahFetchId) return;
    renderVerses(verseCache[num]);
  } catch {
    if (fetchId === currentSurahFetchId) {
      document.getElementById('svVerses').innerHTML='<div class="sv-loading"><div style="font-size:32px;margin-bottom:12px">üåê</div><div>Internet connection required to load verses.</div></div>';
    }
  }
}

function renderVerses(ayahs){
  document.getElementById('svVerses').innerHTML=ayahs.map(a=>`<div class="sv-verse"><div class="sv-verse-top"><div class="sv-vnum">${a.numberInSurah}</div><div class="sv-varabic">${a.text}</div></div>${a.translation?`<div class="sv-vtranslation ${verseMode==='translation'?'show':''}">${esc(a.translation)}</div>`:''}</div>`).join('');
}

function setVerseMode(mode){
  verseMode=mode;
  document.getElementById('btnArabicOnly').classList.toggle('active',mode==='arabic');
  document.getElementById('btnWithTrans').classList.toggle('active',mode==='translation');
  document.querySelectorAll('.sv-vtranslation').forEach(el=>el.classList.toggle('show',mode==='translation'));
}

function closeSurahViewer(){document.getElementById('svOverlay').classList.remove('open');}
document.getElementById('svOverlay').addEventListener('click',e=>{if(e.target===e.currentTarget)closeSurahViewer();});

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// HEADER DROPDOWN & THEME
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function toggleHeaderDropdown(){document.getElementById('headerDropdown').classList.toggle('open');}
function closeHeaderDropdown(){document.getElementById('headerDropdown').classList.remove('open');}
document.addEventListener('click',e=>{const wrap=document.querySelector('.header-dropdown-wrap');if(wrap&&!wrap.contains(e.target))closeHeaderDropdown();});

function toggleTheme(){
  const dark=document.body.classList.toggle('dark-mode');
  document.getElementById('themeKnob').textContent=dark?'‚òÄÔ∏è':'üåô';
  localStorage.setItem('qtTheme',dark?'dark':'light');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// TOAST ‚Äî FIX #8: sanitized
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function showToast(icon,title,desc){
  const t=document.createElement('div'); t.className='toast';
  t.innerHTML=`<div style="font-size:24px">${icon}</div><div><div style="font-size:14px;font-weight:600;color:var(--text)">${esc(title)}</div><div style="font-size:12px;color:var(--text3)">${esc(desc)}</div></div>`;
  document.body.appendChild(t);
  setTimeout(()=>t.classList.add('show'),30);
  setTimeout(()=>{t.classList.remove('show');setTimeout(()=>t.remove(),400);},3500);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// LOADING
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function hideLoading(){
  const el=document.getElementById('loadingOverlay');
  el.classList.add('hide');
  setTimeout(()=>el.style.display='none',400);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// INIT ‚Äî FIX #3: prevent double startAuthListener
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
(function checkConfig() {
  setTimeout(() => {
    const overlay = document.getElementById('loadingOverlay');
    if(overlay && !overlay.classList.contains('hide') && overlay.style.display !== 'none') {
      const inner = overlay.querySelector('div');
      if(inner) {
        inner.innerHTML = `
          <div style="font-size:36px;margin-bottom:24px">‚ò™Ô∏è</div>
          <div class="loader">
            <div class="slider" style="--i:0"></div>
            <div class="slider" style="--i:1"></div>
            <div class="slider" style="--i:2"></div>
            <div class="slider" style="--i:3"></div>
            <div class="slider" style="--i:4"></div>
          </div>
          <div style="font-size:13px;color:var(--text3);margin-top:24px">Loading Quran Tracker‚Ä¶</div>
          <div id="configHint" style="display:none;margin-top:20px;max-width:320px;background:rgba(247,49,100,0.08);border:1px solid rgba(247,49,100,0.2);border-radius:14px;padding:16px;font-size:12px;color:#ff6b8a;line-height:1.6;text-align:left">
            <strong>‚ö†Ô∏è Still loading?</strong><br>
            Check these common causes:<br>
            1. Firebase config values are still placeholders<br>
            2. Firebase project not set up correctly<br>
            3. Authentication not enabled in Firebase<br>
            4. Firestore database not created<br><br>
            Open browser DevTools (F12) ‚Üí Console tab to see the exact error.
          </div>`;
      }
    }
  }, 1000);
  setTimeout(() => {
    const hint = document.getElementById('configHint');
    const overlay = document.getElementById('loadingOverlay');
    if(hint && overlay && !overlay.classList.contains('hide')) hint.style.display = 'block';
  }, 4000);
})();

if(localStorage.getItem('qtTheme')==='dark'){
  document.body.classList.add('dark-mode');
  document.getElementById('themeKnob').textContent='‚òÄÔ∏è';
}

// FIX #3: single flag to prevent double init
let __authListenerStarted = false;

function startAuthListener() {
  if (__authListenerStarted) return; // FIX #3: prevent double registration
  __authListenerStarted = true;

  if(window.__firebaseError || !window.__firebaseReady) {
    document.getElementById('loadingOverlay').style.display = 'none';
    document.getElementById('authScreen').classList.add('active');
    const errEl = document.getElementById('authError');
    errEl.textContent = window.__firebaseError
      ? '‚ö†Ô∏è Firebase config error: ' + window.__firebaseError + ' ‚Äî Please check your API keys in the HTML file.'
      : '‚ö†Ô∏è Firebase failed to load. Check your internet connection and config values.';
    errEl.classList.add('visible');
    return;
  }

  const timeout = setTimeout(() => {
    if(document.getElementById('loadingOverlay').style.display !== 'none' &&
       !document.getElementById('loadingOverlay').classList.contains('hide')) {
      hideLoading();
      document.getElementById('authScreen').classList.add('active');
      const errEl = document.getElementById('authError');
      errEl.textContent = '‚ö†Ô∏è Connection timed out. Check your Firebase config values and internet connection.';
      errEl.classList.add('visible');
    }
  }, 10000);

  fn().onAuthStateChanged(auth(), async user => {
    clearTimeout(timeout);
    if(user) {
      // FIX #20: Don't init if waiting for Google role selection
      if (_waitingForGoogleRole) return;
      stopAuthParticles();
      await initApp(user);
    } else {
      document.getElementById('authScreen').classList.add('active');
      document.getElementById('appScreen').classList.remove('active');
      hideLoading();
      startAuthParticles();
    }
  });
}

// Listen for firebaseReady event
document.addEventListener('firebaseReady', startAuthListener);

// Fallback polling ‚Äî FIX #3: uses same flag
const _fbPoll = setInterval(() => {
  if(window.__firebaseReady !== undefined) {
    clearInterval(_fbPoll);
    startAuthListener(); // Will no-op if already started due to flag
  }
}, 100);

// Keyboard listeners
document.addEventListener('keydown',e=>{
  if(e.key==='Escape'){
    closeSurahViewer();
    closeGoalModal();
    closeStudentModal();
  }
});
</script>
</body>
</html>
